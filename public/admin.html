<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BSC Store â€” Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f5f6fa; --white:#fff; --border:#e8eaed; --text:#1a1a1a; --text2:#6b7280; --text3:#9ca3af;
  --green:#16a34a; --green-bg:#f0fdf4; --red:#dc2626; --red-bg:#fef2f2;
  --yellow:#d97706; --yellow-bg:#fffbeb; --blue:#2563eb; --blue-bg:#eff6ff;
  --purple:#7c3aed; --purple-bg:#f5f3ff;
  --sidebar:#0f172a; --r:12px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);}
button{font-family:'Inter',sans-serif;cursor:pointer;border:none;}
input,select,textarea{font-family:'Inter',sans-serif;}
::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-thumb{background:#ddd;border-radius:3px;}

#loginScreen{min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--sidebar);}
.login-box{background:var(--white);border-radius:20px;padding:2.5rem;width:min(400px,90vw);box-shadow:0 20px 60px rgba(0,0,0,.3);}
.login-logo{font-size:1.8rem;font-weight:900;margin-bottom:.3rem;}
.login-logo span{color:var(--green);}
.login-sub{color:var(--text2);font-size:.9rem;margin-bottom:1.8rem;}
.login-box input{width:100%;border:2px solid var(--border);border-radius:10px;padding:.7rem 1rem;font-size:.95rem;margin-bottom:.8rem;transition:border-color .2s;}
.login-box input:focus{outline:none;border-color:var(--green);}
.login-err{color:var(--red);font-size:.8rem;margin-bottom:.7rem;display:none;}
.btn-primary{width:100%;background:var(--green);color:#fff;border-radius:10px;padding:.75rem;font-size:.95rem;font-weight:700;}

#app{display:none;min-height:100vh;}
#app.show{display:flex;}
.sidebar{width:230px;background:var(--sidebar);flex-shrink:0;display:flex;flex-direction:column;position:sticky;top:0;height:100vh;}
.sidebar-logo{padding:1.5rem 1.4rem 1rem;font-size:1.1rem;font-weight:800;color:#fff;border-bottom:1px solid rgba(255,255,255,.08);}
.sidebar-logo span{color:#4ade80;}
.sidebar-nav{flex:1;padding:.8rem 0;}
.nav-link{display:flex;align-items:center;gap:.75rem;padding:.72rem 1.4rem;color:#94a3b8;font-size:.88rem;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all .15s;}
.nav-link:hover{background:rgba(255,255,255,.05);color:#fff;}
.nav-link.active{color:#fff;background:rgba(255,255,255,.08);border-left-color:#4ade80;}
.nav-link .icon{font-size:1.1rem;width:20px;text-align:center;}
.sidebar-footer{padding:1rem 1.4rem;border-top:1px solid rgba(255,255,255,.08);}
.logout-btn{width:100%;background:rgba(255,255,255,.06);color:#94a3b8;border-radius:8px;padding:.55rem;font-size:.82rem;font-weight:600;}
.logout-btn:hover{background:rgba(255,255,255,.12);color:#fff;}

.main{flex:1;overflow-y:auto;}
.topbar{background:var(--white);border-bottom:1px solid var(--border);padding:1rem 1.8rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;}
.topbar h1{font-size:1.15rem;font-weight:700;}
.content{padding:1.8rem;}

.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:1.8rem;}
.stat-card{background:var(--white);border-radius:var(--r);padding:1.2rem 1.4rem;border:1px solid var(--border);}
.stat-val{font-size:1.8rem;font-weight:800;}
.stat-lbl{font-size:.78rem;color:var(--text2);margin-top:.2rem;font-weight:500;}

.card{background:var(--white);border-radius:var(--r);border:1px solid var(--border);overflow:hidden;margin-bottom:1.2rem;}
.card-header{padding:1rem 1.4rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem;}
.card-header h2{font-size:.95rem;font-weight:700;}
.card-body{padding:1.4rem;}

.btn{display:inline-flex;align-items:center;gap:.4rem;padding:.52rem 1rem;border-radius:8px;font-size:.82rem;font-weight:600;cursor:pointer;border:none;transition:all .15s;}
.btn-green{background:var(--green);color:#fff;}
.btn-green:hover{filter:brightness(1.1);}
.btn-red{background:var(--red-bg);color:var(--red);border:1px solid #fecaca;}
.btn-red:hover{background:#fecaca;}
.btn-gray{background:var(--bg);color:var(--text2);border:1px solid var(--border);}
.btn-gray:hover{background:var(--border);}
.btn-blue{background:var(--blue-bg);color:var(--blue);border:1px solid #bfdbfe;}
.btn-blue:hover{background:#dbeafe;}
.btn-yellow{background:var(--yellow-bg);color:var(--yellow);border:1px solid #fde68a;}
.btn-yellow:hover{background:#fde68a;}
.btn-purple{background:var(--purple-bg);color:var(--purple);border:1px solid #ddd6fe;}

table{width:100%;border-collapse:collapse;}
th{font-size:.75rem;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.05em;padding:.75rem 1rem;background:var(--bg);text-align:left;border-bottom:1px solid var(--border);}
td{padding:.85rem 1rem;border-bottom:1px solid var(--border);font-size:.88rem;vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:#fafafa;}
.td-img{width:44px;height:44px;border-radius:8px;object-fit:cover;}
.td-img-ph{width:44px;height:44px;border-radius:8px;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:1.3rem;border:1px solid var(--border);}
.actions{display:flex;gap:.4rem;flex-wrap:wrap;}
.badge{display:inline-block;padding:.2rem .6rem;border-radius:50px;font-size:.72rem;font-weight:600;}
.badge-green{background:var(--green-bg);color:var(--green);}
.badge-red{background:var(--red-bg);color:var(--red);}
.badge-yellow{background:var(--yellow-bg);color:var(--yellow);}
.badge-blue{background:var(--blue-bg);color:var(--blue);}
.badge-purple{background:var(--purple-bg);color:var(--purple);}

.form-group{margin-bottom:1rem;}
.form-group label{display:block;font-size:.78rem;font-weight:600;color:var(--text2);margin-bottom:.4rem;text-transform:uppercase;letter-spacing:.04em;}
.form-group input,.form-group select,.form-group textarea{width:100%;border:1.5px solid var(--border);border-radius:9px;padding:.62rem .9rem;font-size:.9rem;color:var(--text);background:var(--white);transition:border-color .2s;appearance:none;}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--green);}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:.8rem;}
.form-hint{font-size:.74rem;color:var(--text3);margin-top:.3rem;}

.img-upload-area{border:2px dashed var(--border);border-radius:10px;padding:1.5rem;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg);}
.img-upload-area:hover{border-color:var(--green);background:var(--green-bg);}
.img-upload-area.has-image{border-color:var(--green);border-style:solid;}
.img-preview{width:100%;max-height:140px;object-fit:cover;border-radius:8px;display:none;}

.tiers-list{display:flex;flex-direction:column;gap:.5rem;margin-bottom:.6rem;}
.tier-row{display:grid;grid-template-columns:1fr 1fr auto;gap:.5rem;align-items:center;background:var(--bg);border-radius:8px;padding:.5rem .6rem;border:1px solid var(--border);}
.tier-row input{border:1.5px solid var(--border);border-radius:7px;padding:.4rem .6rem;font-size:.85rem;background:var(--white);width:100%;}
.tier-row input:focus{outline:none;border-color:var(--green);}
.tier-del{background:none;color:var(--red);font-size:1.1rem;padding:.2rem .4rem;border-radius:5px;flex-shrink:0;}
.tier-del:hover{background:var(--red-bg);}

.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;padding:1rem;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--white);border-radius:18px;width:min(560px,100%);max-height:92vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,.2);}
.modal-head{padding:1.2rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--white);z-index:1;}
.modal-head h2{font-size:1rem;font-weight:700;}
.modal-close{background:none;font-size:1.3rem;color:var(--text2);padding:.2rem .4rem;cursor:pointer;}
.modal-body{padding:1.5rem;}
.modal-foot{padding:1rem 1.5rem;border-top:1px solid var(--border);display:flex;gap:.5rem;justify-content:flex-end;position:sticky;bottom:0;background:var(--white);}

.action-picker{border:1.5px solid var(--border);border-radius:10px;padding:1rem;margin-top:.5rem;background:var(--bg);}
.prod-pick-list{max-height:220px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--white);margin-top:.5rem;}
.pick-item{display:flex;align-items:center;gap:.6rem;padding:.55rem .8rem;border-bottom:1px solid var(--border);}
.pick-item:last-child{border:none;}
.pick-item:hover{background:var(--bg);}
.pick-item input[type=checkbox]{width:15px;height:15px;accent-color:var(--green);flex-shrink:0;}
.pick-item .pname{font-size:.83rem;font-weight:600;flex:1;}
.pick-item .pprice{font-size:.78rem;color:var(--text2);}

.search-input{border:1.5px solid var(--border);border-radius:8px;padding:.48rem .9rem;font-size:.85rem;background:var(--white);min-width:200px;}
.search-input:focus{outline:none;border-color:var(--green);}

.toast{position:fixed;bottom:1.5rem;right:1.5rem;background:var(--sidebar);color:#fff;padding:.7rem 1.2rem;border-radius:10px;font-size:.84rem;font-weight:500;z-index:9999;opacity:0;pointer-events:none;transition:opacity .3s;box-shadow:0 4px 20px rgba(0,0,0,.3);}
.toast.show{opacity:1;}

/* â”€â”€ MINI MODAL (replaces browser prompt()) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mini-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:5000;display:flex;align-items:center;justify-content:center;padding:1rem;backdrop-filter:blur(4px);}
.mini-modal{background:#fff;border-radius:18px;width:min(420px,100%);box-shadow:0 24px 64px rgba(0,0,0,.28);overflow:hidden;}
.mini-modal-head{padding:1.1rem 1.4rem;border-bottom:1px solid var(--border);font-weight:700;font-size:.97rem;display:flex;align-items:center;justify-content:space-between;}
.mini-modal-body{padding:1.3rem 1.4rem;display:flex;flex-direction:column;gap:.8rem;}
.mini-modal-foot{padding:.9rem 1.4rem;border-top:1px solid var(--border);display:flex;gap:.5rem;justify-content:flex-end;}
.mini-modal input,.mini-modal select{width:100%;border:1.5px solid var(--border);border-radius:9px;padding:.6rem .9rem;font-size:.9rem;font-family:inherit;color:var(--text);background:#fff;transition:border-color .2s;}
.mini-modal input:focus,.mini-modal select:focus{outline:none;border-color:var(--green);}

.empty-state{text-align:center;padding:3rem 1rem;color:var(--text2);}
.empty-state .ei{font-size:2.5rem;margin-bottom:.5rem;}
.empty-state p{font-size:.88rem;line-height:1.6;}

/* â”€â”€ BARCODE SCANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.scan-wrapper{min-height:calc(100vh - 120px);display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:2rem 1rem;gap:2rem;}
.scan-card{background:var(--white);border-radius:20px;border:1px solid var(--border);box-shadow:0 4px 24px rgba(0,0,0,.06);width:min(580px,100%);padding:2rem;}
.scan-title{font-size:1.4rem;font-weight:800;margin-bottom:.3rem;display:flex;align-items:center;gap:.5rem;}
.scan-subtitle{color:var(--text2);font-size:.9rem;margin-bottom:1.5rem;}
.scan-input-wrap{position:relative;margin-bottom:1rem;}
.scan-input{width:100%;border:2.5px solid var(--border);border-radius:14px;padding:1.1rem 3.2rem 1.1rem 1.2rem;font-size:1.25rem;font-weight:600;letter-spacing:.08em;transition:border-color .2s;background:var(--white);}
.scan-input:focus{outline:none;border-color:var(--green);}
.scan-input.scanning{border-color:var(--blue);animation:pulse-blue .6s ease-in-out;}
.scan-input::placeholder{font-weight:400;letter-spacing:normal;color:var(--text3);}
@keyframes pulse-blue{0%{box-shadow:0 0 0 0 rgba(37,99,235,.4);}70%{box-shadow:0 0 0 10px rgba(37,99,235,0);}100%{box-shadow:0 0 0 0 rgba(37,99,235,0);}}
.scan-icon{position:absolute;right:1rem;top:50%;transform:translateY(-50%);font-size:1.6rem;opacity:.4;}
.scan-result{border-radius:14px;padding:1.2rem;margin-top:.5rem;}
.scan-result.found{background:var(--green-bg);border:1.5px solid #86efac;}
.scan-result.not-found{background:var(--red-bg);border:1.5px solid #fecaca;}
.scan-result.loading{background:var(--blue-bg);border:1.5px solid #bfdbfe;}
.scan-status{font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;margin-bottom:.3rem;}
.scan-result.found .scan-status{color:var(--green);}
.scan-result.not-found .scan-status{color:var(--red);}
.scan-result.loading .scan-status{color:var(--blue);}
.scan-prod-name{font-size:1.1rem;font-weight:700;}
.scan-prod-meta{font-size:.82rem;color:var(--text2);margin-top:.2rem;}
.scan-history{background:var(--white);border-radius:14px;border:1px solid var(--border);width:min(580px,100%);overflow:hidden;}
.scan-history-head{padding:.75rem 1.1rem;background:var(--bg);font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text2);border-bottom:1px solid var(--border);}
.scan-history-item{display:flex;align-items:center;gap:.8rem;padding:.65rem 1.1rem;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;}
.scan-history-item:last-child{border:none;}
.scan-history-item:hover{background:var(--bg);}
.shi-barcode{font-family:monospace;font-size:.78rem;color:var(--text2);flex:1;}
.shi-name{font-size:.85rem;font-weight:600;flex:2;}
.shi-time{font-size:.73rem;color:var(--text3);}

/* â”€â”€ STOCK STATUS BADGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stock-in{background:#f0fdf4;color:#16a34a;border:1px solid #86efac;display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .7rem;border-radius:50px;font-size:.75rem;font-weight:700;}
.stock-low{background:#fffbeb;color:#d97706;border:1px solid #fcd34d;display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .7rem;border-radius:50px;font-size:.75rem;font-weight:700;}
.stock-out{background:#fef2f2;color:#dc2626;border:1px solid #fca5a5;display:inline-flex;align-items:center;gap:.3rem;padding:.2rem .7rem;border-radius:50px;font-size:.75rem;font-weight:700;}
.low-stock-alert{background:#fffbeb;border:1.5px solid #fcd34d;border-radius:12px;padding:1rem 1.2rem;margin-bottom:1.2rem;}
.low-stock-alert h3{font-size:.88rem;font-weight:700;color:#92400e;margin-bottom:.4rem;display:flex;align-items:center;gap:.4rem;}
.low-stock-list{display:flex;flex-direction:column;gap:.3rem;}
.low-stock-item{display:flex;align-items:center;justify-content:space-between;font-size:.83rem;padding:.25rem 0;border-bottom:1px solid #fde68a;}
.low-stock-item:last-child{border:none;}
.quick-stock-input{width:70px;border:1.5px solid var(--border);border-radius:7px;padding:.3rem .5rem;font-size:.85rem;text-align:center;}
.quick-stock-input:focus{outline:none;border-color:var(--green);}

/* â”€â”€ PRODUCT EDIT VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.prod-view{max-width:680px;margin:0 auto;}
.prod-view-header{display:flex;align-items:flex-start;gap:1.2rem;background:var(--white);border-radius:14px;border:1px solid var(--border);padding:1.2rem;margin-bottom:1rem;}
.prod-view-img{width:80px;height:80px;border-radius:10px;object-fit:cover;flex-shrink:0;border:1px solid var(--border);}
.prod-view-img-ph{width:80px;height:80px;border-radius:10px;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:2rem;flex-shrink:0;}
.prod-view-info{flex:1;}
.prod-view-name{font-size:1.15rem;font-weight:800;}
.prod-view-meta{font-size:.8rem;color:var(--text2);margin-top:.15rem;}
.prod-view-tags{display:flex;gap:.4rem;flex-wrap:wrap;margin-top:.4rem;}

/* â”€â”€ PROFILE TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.profile-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--bg);overflow-x:auto;}
.ptab-btn{padding:.65rem 1.2rem;font-size:.82rem;font-weight:600;border:none;cursor:pointer;background:none;border-bottom:3px solid transparent;color:var(--text2);transition:all .15s;white-space:nowrap;flex-shrink:0;}
.ptab-btn.active{border-bottom-color:var(--green);color:var(--green);}

@media(max-width:768px){
  #app{flex-direction:column;}
  .sidebar{width:100%;height:auto;flex-direction:row;position:fixed;bottom:0;left:0;right:0;top:auto;z-index:200;border-top:1px solid rgba(255,255,255,.12);box-shadow:0 -2px 16px rgba(0,0,0,.35);overflow:hidden;}
  .sidebar-logo,.sidebar-footer{display:none!important;}
  .sidebar-nav{display:flex!important;flex-direction:row!important;padding:0!important;width:100%!important;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
  .sidebar-nav::-webkit-scrollbar{display:none;}
  .nav-link{flex-direction:column!important;gap:2px!important;padding:.45rem .2rem!important;border-left:none!important;border-bottom:3px solid transparent!important;flex:1!important;min-width:52px!important;justify-content:center!important;align-items:center!important;}
  .nav-link.active{border-bottom-color:#4ade80!important;border-left:none!important;background:rgba(255,255,255,.1)!important;}
  .nav-link span:not(.icon){display:block!important;font-size:.52rem!important;color:inherit!important;line-height:1.1!important;}
  .nav-link .icon{font-size:1.25rem!important;width:auto!important;}
  .main{width:100%!important;padding-bottom:72px!important;}
  .topbar{padding:.6rem .9rem!important;}
  .topbar h1{font-size:.95rem!important;}
  .content{padding:.75rem!important;}
  .stats-grid{grid-template-columns:1fr 1fr!important;}
  .stat-val{font-size:1.35rem!important;}
  .card-header{flex-wrap:wrap!important;gap:.4rem!important;}
  .card-body{padding:.9rem!important;}
  .table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch;width:100%;}
  .form-row{grid-template-columns:1fr!important;}
  #content>div[style*="grid-template-columns"]{display:flex!important;flex-direction:column!important;gap:.9rem!important;max-width:100%!important;}
  .modal-overlay{align-items:flex-end!important;padding:0!important;}
  .modal{border-radius:16px 16px 0 0!important;width:100%!important;max-height:88vh!important;}
  .actions{flex-wrap:wrap!important;}
  .search-input{min-width:0!important;width:100%!important;}
}
</style>
</head>
<body>

<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">ğŸ›’ <span>BSC</span> Store</div>
    <div class="login-sub">Admin Panel â€” Enter your password</div>
    <input type="password" id="loginPass" placeholder="Password" onkeydown="if(event.key==='Enter')doLogin()">
    <div class="login-err" id="loginErr">Wrong password. Try again.</div>
    <button class="btn-primary" onclick="doLogin()">Login</button>
  </div>
</div>

<div id="app">
  <div class="sidebar">
    <div class="sidebar-logo">BSC <span>Store</span></div>
    <nav class="sidebar-nav">
      <div class="nav-link" onclick="goTo('dashboard')"><span class="icon">ğŸ“Š</span><span>Dashboard</span></div>
      <div class="nav-link" onclick="goTo('customers')"><span class="icon">ğŸ‘¥</span><span>Customers</span></div>
      <div class="nav-link" onclick="goTo('orders')"><span class="icon">ğŸ“¦</span><span>Orders</span></div>
      <div class="nav-link" onclick="goTo('milk')"><span class="icon">ğŸ¥›</span><span>Milk</span></div>
      <div class="nav-link" onclick="goTo('udhar')"><span class="icon">ğŸ“’</span><span>Udhar</span></div>
      <div class="nav-link" onclick="goTo('products')"><span class="icon">ğŸ›ï¸</span><span>Products</span></div>
      <div class="nav-link" onclick="goTo('scanner')"><span class="icon">ğŸ“·</span><span>Scanner</span></div>
      <div class="nav-link" onclick="goTo('categories')"><span class="icon">ğŸ“‚</span><span>Categories</span></div>
      <div class="nav-link" onclick="goTo('subcategories')"><span class="icon">ğŸ—‚ï¸</span><span>Subcategories</span></div>
      <div class="nav-link" onclick="goTo('banners')"><span class="icon">ğŸ–¼ï¸</span><span>Banners</span></div>
      <div class="nav-link" onclick="goTo('settings')"><span class="icon">âš™ï¸</span><span>Settings</span></div>
    </nav>
    <div class="sidebar-footer">
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>
  <div class="main">
    <div class="topbar">
      <h1 id="pageTitle">Dashboard</h1>
      <a href="/" target="_blank"><button class="btn btn-gray">View Store</button></a>
    </div>
    <div class="content" id="content"></div>
  </div>
</div>

<!-- PRODUCT MODAL -->
<div class="modal-overlay" id="productModal">
  <div class="modal">
    <div class="modal-head">
      <h2 id="productModalTitle">Add Product</h2>
      <button class="modal-close" onclick="closeModal('productModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="pEditId">
      <div class="form-row">
        <div class="form-group">
          <label>SKU (Internal Code)</label>
          <input type="text" id="pSku" placeholder="e.g. SKU-001">
          <div class="form-hint">Unique internal product code</div>
        </div>
        <div class="form-group">
          <label>Barcode (EAN/UPC)</label>
          <input type="text" id="pBarcode" placeholder="e.g. 8901262010023">
          <div class="form-hint">Scan with USB barcode scanner</div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>MRP (â‚¹)</label>
          <input type="number" id="pMrp" placeholder="Maximum retail price" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>Stock Quantity</label>
          <input type="number" id="pStock" placeholder="Units available" min="0">
          <div class="form-hint">Leave blank for unlimited / not tracked</div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Low Stock Threshold</label>
          <input type="number" id="pLowStock" placeholder="e.g. 5" min="0" value="5">
          <div class="form-hint">Alert when stock falls to this level</div>
        </div>
        <div class="form-group" style="display:flex;align-items:center;gap:.6rem;padding-top:1.6rem;">
          <input type="checkbox" id="pDisabled" style="width:16px;height:16px;accent-color:var(--red)">
          <label style="margin:0;text-transform:none;font-size:.88rem;color:var(--text)">Disable product (hide from customers)</label>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Product Name</label><input type="text" id="pName" placeholder="e.g. Maida, Tomatoes..."></div>
        <div class="form-group"><label>Category</label><select id="pCat" onchange="updateSubcatDropdown()"></select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Subcategory</label><select id="pSubCat"><option value="">â€” None â€”</option></select></div>
        <div class="form-group">
          <label>Tag</label>
          <select id="pTag">
            <option value="">None</option>
            <option value="featured">â­ Featured</option>
            <option value="new">âœ¨ New Arrival</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Product Image URL (fallback)</label>
        <input type="text" id="pImgUrl" placeholder="https://... paste image link here" oninput="previewUrlImg('pImgPreview', this.value)" style="width:100%;border:1.5px solid var(--border);border-radius:9px;padding:.62rem .9rem;font-size:.9rem;color:var(--text);background:var(--white)">
        <div style="margin-top:8px" id="pImgPreviewWrap">
          <img id="pImgPreview" style="display:none;width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid var(--border)">
        </div>
        <div class="form-hint">Paste a direct image URL (WhatsApp, Google Drive, Cloudinary, etc.)</div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Brand (optional)</label>
          <input type="text" id="pBrand" placeholder="e.g. Amul, Mother Dairy">
        </div>
        <div class="form-group">
          <label>Search Keywords</label>
          <input type="text" id="pKeywords" placeholder="e.g. doodh, milk, dairy, toned">
          <div class="form-hint">Comma-separated. Enables smart search (doodh â†’ milk)</div>
        </div>
      </div>
      <div class="form-group">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <label style="margin:0">Variants (sizes / units)</label>
          <button class="btn btn-green" style="font-size:.75rem;padding:.35rem .8rem" onclick="addVariant()">+ Add Variant</button>
        </div>
        <div id="variantEditor"></div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-gray" onclick="closeModal('productModal')">Cancel</button>
      <button class="btn btn-green" onclick="saveProduct()">Save Product</button>
    </div>
  </div>
</div>

<!-- CATEGORY MODAL -->
<div class="modal-overlay" id="categoryModal">
  <div class="modal">
    <div class="modal-head">
      <h2 id="catModalTitle">Add Category</h2>
      <button class="modal-close" onclick="closeModal('categoryModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="cEditId">
      <div class="form-group"><label>Category Name</label><input type="text" id="cName" placeholder="e.g. Dairy and Eggs"></div>
      <div class="form-group">
        <label>Category Image URL</label>
        <input type="text" id="cImgUrl" placeholder="https://... paste image link here" oninput="previewUrlImg('cImgPreview', this.value)" style="width:100%;border:1.5px solid var(--border);border-radius:9px;padding:.62rem .9rem;font-size:.9rem;color:var(--text);background:var(--white)">
        <div style="margin-top:8px">
          <img id="cImgPreview" style="display:none;width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid var(--border)">
        </div>
        <div class="form-hint">Paste a direct image URL</div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-gray" onclick="closeModal('categoryModal')">Cancel</button>
      <button class="btn btn-green" onclick="saveCat()">Save Category</button>
    </div>
  </div>
</div>

<!-- BANNER MODAL -->
<div class="modal-overlay" id="bannerModal">
  <div class="modal">
    <div class="modal-head">
      <h2 id="bannerModalTitle">Add Banner</h2>
      <button class="modal-close" onclick="closeModal('bannerModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="bEditId">
      <div class="form-group">
        <label>Banner Image URL</label>
        <input type="text" id="bImgUrl" placeholder="https://... paste image link here" oninput="previewUrlImg('bImgPreview', this.value)" style="width:100%;border:1.5px solid var(--border);border-radius:9px;padding:.62rem .9rem;font-size:.9rem;color:var(--text);background:var(--white)">
        <div style="margin-top:8px">
          <img id="bImgPreview" style="display:none;width:100%;max-height:120px;object-fit:cover;border-radius:8px;border:1px solid var(--border)">
        </div>
        <div class="form-hint">Paste a direct image URL. Recommended: 800Ã—400px</div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Title (optional)</label><input type="text" id="bTitle" placeholder="e.g. Weekend Deals"></div>
        <div class="form-group"><label>Subtitle (optional)</label><input type="text" id="bSub" placeholder="e.g. Up to 20% off"></div>
      </div>
      <div class="form-group">
        <label>Background Color (if no image)</label>
        <input type="color" id="bBgColor" value="#1a1a2e" style="height:40px;cursor:pointer;border-radius:8px;padding:4px 6px;width:100%;border:1.5px solid var(--border)">
      </div>
      <div class="form-group">
        <label>When Clicked Opens</label>
        <select id="bActionType" onchange="onBannerActionChange()">
          <option value="">Nothing</option>
          <option value="category">A specific category</option>
          <option value="products">Hand-picked products</option>
        </select>
      </div>
      <div class="action-picker" id="bActionPicker" style="display:none">
        <div id="bCatPicker" style="display:none">
          <div class="form-group" style="margin:0"><label>Select Category</label><select id="bCatId"></select></div>
        </div>
        <div id="bProdPicker" style="display:none">
          <label style="font-size:.78rem;font-weight:600;color:var(--text2);text-transform:uppercase;display:block;margin-bottom:.4rem">Pick Products</label>
          <input type="text" placeholder="Search..." class="search-input" style="width:100%;margin-bottom:.4rem" oninput="filterBannerProds(this.value)">
          <div class="prod-pick-list" id="bProdList"></div>
          <div style="font-size:.74rem;color:var(--text2);margin-top:.4rem"><span id="bPickCount">0</span> selected</div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-gray" onclick="closeModal('bannerModal')">Cancel</button>
      <button class="btn btn-green" onclick="saveBanner()">Save Banner</button>
    </div>
  </div>
</div>

<!-- SUBCATEGORY MODAL -->
<div class="modal-overlay" id="subcategoryModal">
  <div class="modal">
    <div class="modal-head">
      <h2 id="scModalTitle">Add Subcategory</h2>
      <button class="modal-close" onclick="closeModal('subcategoryModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="scEditId">
      <div class="form-group">
        <label>Parent Category</label>
        <select id="scCatId" style="width:100%;border:1.5px solid var(--border);border-radius:9px;padding:.62rem .9rem;font-size:.9rem;color:var(--text);background:var(--white)"></select>
      </div>
      <div class="form-group"><label>Subcategory Name</label><input type="text" id="scName" placeholder="e.g. Milk, Paneer, Curd, Eggs"></div>
      <div class="form-group">
        <label>Subcategory Image URL</label>
        <input type="text" id="scImgUrl" placeholder="https://... paste image link here" oninput="previewUrlImg('scImgPreview', this.value)" style="width:100%;border:1.5px solid var(--border);border-radius:9px;padding:.62rem .9rem;font-size:.9rem;color:var(--text);background:var(--white)">
        <div style="margin-top:8px">
          <img id="scImgPreview" style="display:none;width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid var(--border)">
        </div>
        <div class="form-hint">Paste a direct image URL</div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-gray" onclick="closeModal('subcategoryModal')">Cancel</button>
      <button class="btn btn-green" onclick="saveSubcat()">Save Subcategory</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let token = localStorage.getItem('bsc_token');
let allProducts = [], allCategories = [], allBanners = [], allSubcategories = [];
let currentPage = 'dashboard';

window.onload = function() {
  if (token) { document.getElementById('loginScreen').style.display = 'none'; startApp(); }
  // loginScreen is already visible by default, so no else needed
};

async function doLogin() {
  const pass = document.getElementById('loginPass').value;
  document.getElementById('loginErr').style.display = 'none';
  try {
    const r = await fetch('/api/admin/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pass}) });
    if (r.ok) { token = (await r.json()).token; localStorage.setItem('bsc_token',token); startApp(); }
    else { document.getElementById('loginErr').style.display = 'block'; }
  } catch { document.getElementById('loginErr').textContent='Cannot connect to server.'; document.getElementById('loginErr').style.display='block'; }
}

async function startApp() {
  try {
    const r = await fetch('/api/admin/verify', { headers:{Authorization:'Bearer '+token} });
    if (!r.ok) { token=null; localStorage.removeItem('bsc_token'); location.reload(); return; }
  } catch { document.getElementById('loginScreen').style.display='flex'; return; }
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('app').classList.add('show');
  await loadAll();
  goTo('dashboard');
}

function logout() { localStorage.removeItem('bsc_token'); token=null; location.reload(); }

async function loadAll(force = false) {
  const CACHE_TTL = 5 * 60 * 1000; // 5 minutes
  const now = Date.now();
  if (!force && loadAll._cachedAt && (now - loadAll._cachedAt) < CACHE_TTL) return;
  const [pR,cR,bR,scR] = await Promise.all([
    fetch('/api/admin/products',{headers:ah()}),
    fetch('/api/admin/categories',{headers:ah()}),
    fetch('/api/admin/banners',{headers:ah()}),
    fetch('/api/admin/subcategories',{headers:ah()}),
  ]);
  allProducts = await pR.json();
  allCategories = await cR.json();
  allBanners = await bR.json();
  allSubcategories = scR.ok ? await scR.json() : [];
  loadAll._cachedAt = Date.now();
}
function invalidateCache() { loadAll._cachedAt = 0; }

const ah = () => ({Authorization:'Bearer '+token,'Content-Type':'application/json'});

const PAGE_NAMES = ['dashboard','customers','orders','milk','udhar','products','scanner','categories','subcategories','banners','settings'];

function goTo(page) {
  currentPage = page;
  document.querySelectorAll('.nav-link').forEach((l,i) => l.classList.toggle('active', PAGE_NAMES[i]===page));
  const titles = {dashboard:'Dashboard',customers:'Customers',orders:'Orders',milk:'Milk Delivery',udhar:'Udhar / Credit',products:'Products',scanner:'ğŸ“· Barcode Scanner',categories:'Categories',subcategories:'Subcategories',banners:'Banners',settings:'Settings'};
  document.getElementById('pageTitle').textContent = titles[page]||page;
  const fns = {dashboard:renderDashboard,customers:renderCustomers,orders:renderOrders,milk:renderMilk,udhar:renderUdhar,products:renderProducts,scanner:renderScanner,categories:renderCategories,subcategories:renderSubcategories,banners:renderBanners,settings:renderSettings};
  if (fns[page]) {
    const r = fns[page]();
    if (r && r.then) r.then(() => wrapTables()); else setTimeout(wrapTables, 80);
  }
}

function wrapTables() {
  document.querySelectorAll('#content table').forEach(t => {
    if (t.closest('.table-scroll')) return;
    const wrap = document.createElement('div');
    wrap.className = 'table-scroll';
    t.parentNode.insertBefore(wrap, t);
    wrap.appendChild(t);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderDashboard() {
  try {
    const today = new Date().toISOString().slice(0,10);
    const [ordersR, pendingR, custR, lowStockR, milkSubsR, udharSumR] = await Promise.all([
      fetch('/api/admin/orders?date=today',{headers:ah()}),
      fetch('/api/admin/orders?status=pending',{headers:ah()}),
      fetch('/api/admin/customers',{headers:ah()}),
      fetch('/api/admin/products/low-stock',{headers:ah()}),
      fetch('/api/admin/milk/customers',{headers:ah()}),
      fetch('/api/admin/udhar-summary',{headers:ah()}),
    ]);
    const todayOrders   = ordersR.ok   ? await ordersR.json()   : [];
    const pendingOrders = pendingR.ok  ? await pendingR.json()  : [];
    const customers     = custR.ok     ? await custR.json()     : [];
    const lowStockProducts = lowStockR.ok ? await lowStockR.json() : [];
    const milkSubs      = milkSubsR.ok ? await milkSubsR.json() : [];
    const udharSummary  = udharSumR.ok ? await udharSumR.json() : [];
    const milkCount     = customers.filter(c=>c.milkSubscription).length;
    const todayRevenue  = todayOrders.filter(o=>o.status==='delivered').reduce((s,o)=>s+(parseFloat(o.total)||0),0);
    const milkActive    = milkSubs.filter(c=>c.active);
    // Count how many active milk customers already have a log entry today
    const milkMarked    = milkActive.filter(c=>milkLogs&&milkLogs.find&&milkLogs.find(l=>l.customerId===c.id&&l.date===today)).length;
    const milkTotal     = milkActive.length;
    const milkPct       = milkTotal ? Math.round(milkMarked/milkTotal*100) : 0;
    const milkColor     = milkPct===100?'var(--green)':milkPct>60?'var(--yellow)':'var(--red)';
    const overdueCount  = udharSummary.filter(s=>(s.balance||0)>0).length;

    document.getElementById('content').innerHTML = `
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-val">${customers.length}</div><div class="stat-lbl">Customers</div></div>
        <div class="stat-card"><div class="stat-val" style="color:var(--yellow)">${pendingOrders.length}</div><div class="stat-lbl">Pending Orders</div></div>
        <div class="stat-card"><div class="stat-val" style="color:var(--green)">â‚¹${todayRevenue.toFixed(0)}</div><div class="stat-lbl">Today's Revenue</div></div>
        <div class="stat-card"><div class="stat-val">${allProducts.length}</div><div class="stat-lbl">Products</div></div>
      </div>
      <div class="stats-grid" style="margin-top:-.4rem">
        <div class="stat-card" style="grid-column:span 2">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <div>
              <div class="stat-val" style="color:${milkColor};font-size:1.4rem">${milkMarked}/${milkTotal}</div>
              <div class="stat-lbl">ğŸ¥› Milk Delivered Today</div>
            </div>
            <div style="font-size:1.3rem;font-weight:900;color:${milkColor}">${milkPct}%</div>
          </div>
          <div style="height:6px;background:var(--bg);border-radius:3px;overflow:hidden">
            <div style="height:100%;width:${milkPct}%;background:${milkColor};border-radius:3px"></div>
          </div>
        </div>
        <div class="stat-card" onclick="goTo('udhar')" style="cursor:pointer" title="View udhar">
          <div class="stat-val" style="color:${overdueCount>0?'var(--red)':'var(--green)'}">${overdueCount}</div>
          <div class="stat-lbl">ğŸ“’ Overdue Udhar</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" style="color:var(--blue)">${milkCount}</div>
          <div class="stat-lbl">Milk Subscribers</div>
        </div>
      </div>
      ${lowStockProducts.length > 0 ? `
      <div class="low-stock-alert">
        <h3>âš ï¸ Low / Out of Stock Alert (${lowStockProducts.length} product${lowStockProducts.length>1?'s':''})</h3>
        <div class="low-stock-list">
          ${lowStockProducts.map(p=>`<div class="low-stock-item">
            <span style="font-weight:600">${p.name}</span>
            <span>${stockBadge(p)}</span>
            <span style="font-size:.78rem;color:var(--text2)">${p.stockQuantity===0?'ğŸš« OUT':'âš ï¸ '+p.stockQuantity+' left'}</span>
            <button class="btn btn-yellow" style="font-size:.72rem;padding:.25rem .6rem" onclick="goTo('products');setTimeout(()=>editProduct(${p.id}),200)">Update</button>
          </div>`).join('')}
        </div>
      </div>` : ''}
      <div class="card">
        <div class="card-header"><h2>âš¡ Quick Actions</h2></div>
        <div class="card-body" style="display:flex;gap:.8rem;flex-wrap:wrap">
          <button class="btn btn-green" onclick="goTo('customers');setTimeout(openAddCustomerModal,100)">+ Add Customer</button>
          <button class="btn btn-blue" onclick="goTo('orders')">View Orders</button>
          <button class="btn btn-gray" onclick="goTo('milk')">ğŸ¥› Milk Delivery</button>
          <button class="btn btn-yellow" onclick="goTo('udhar')">ğŸ“’ Udhar Summary</button>
          <button class="btn btn-purple" onclick="goTo('scanner')">ğŸ“· Barcode Scanner</button>
          <a href="/" target="_blank"><button class="btn btn-gray">View Store</button></a>
        </div>
      </div>
      ${pendingOrders.length > 0 ? `
      <div class="card">
        <div class="card-header"><h2>ğŸ“¦ Pending Orders (${pendingOrders.length})</h2><button class="btn btn-blue" onclick="goTo('orders')">View All</button></div>
        <table>
          <thead><tr><th>#</th><th>Customer</th><th>Items</th><th>Total</th><th>Action</th></tr></thead>
          <tbody>${pendingOrders.slice(0,5).map(o=>`<tr>
            <td>#${o.id}</td>
            <td><div style="font-weight:600">${o.customerName}</div><div style="font-size:.75rem;color:var(--text2)">${o.phone}</div></td>
            <td style="font-size:.82rem">${(o.items||[]).slice(0,2).map(i=>i.name+'Ã—'+i.qty).join(', ')}${(o.items||[]).length>2?'...':''}</td>
            <td style="font-weight:700;color:var(--green)">â‚¹${o.total}</td>
            <td><button class="btn btn-green" style="font-size:.75rem" onclick="quickUpdateOrder(${o.id},'delivered')">âœ“ Delivered</button></td>
          </tr>`).join('')}</tbody>
        </table>
      </div>` : ''}`;
  } catch(e) { toast('Dashboard load error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CUSTOMERS â€” Main control panel
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allCustomers = [], udharSummaries = [], accountSelectedId = null;

async function renderCustomers() {
  await loadCustomersData();
  renderCustomersPage();
}

async function loadCustomersData() {
  const [cR, sR] = await Promise.all([
    fetch('/api/admin/customers',{headers:ah()}),
    fetch('/api/admin/udhar-summary',{headers:ah()}),
  ]);
  allCustomers = cR.ok ? await cR.json() : [];
  udharSummaries = sR.ok ? await sR.json() : [];
}

function renderCustomersPage() {
  const udharMap = {};
  udharSummaries.forEach(s => { udharMap[s.customer.id] = s; });
  const totalOut = udharSummaries.reduce((s,x)=>s+(x.balance>0?x.balance:0),0);
  const milkCount = allCustomers.filter(c=>c.milkSubscription).length;

  document.getElementById('content').innerHTML = `
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-val">${allCustomers.length}</div><div class="stat-lbl">All Customers</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--red)">â‚¹${totalOut.toFixed(0)}</div><div class="stat-lbl">Total Outstanding</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--blue)">${milkCount}</div><div class="stat-lbl">Milk Subscribers</div></div>
      <div class="stat-card"><div class="stat-val">${udharSummaries.length}</div><div class="stat-lbl">Have Udhar</div></div>
    </div>
    <div style="display:flex;gap:.6rem;align-items:center;margin-bottom:1rem;flex-wrap:wrap">
      <input type="text" id="custSearch" placeholder="ğŸ” Search name or phone..." class="search-input" style="flex:1;min-width:180px" oninput="filterCustTable(this.value)">
      <button class="btn btn-green" onclick="openAddCustomerModal()">+ Add Customer</button>
    </div>
    <div class="card">
      <div class="card-header"><h2>ğŸ‘¥ All Customers (${allCustomers.length})</h2></div>
      <div class="table-scroll"><table id="custTable">
        <thead><tr><th>Customer</th><th>Address</th><th>Milk</th><th>Balance</th><th>Actions</th></tr></thead>
        <tbody>${allCustomers.map(c => {
          const s = udharMap[c.customerId] || {totalUdhar:0,totalPaid:0,balance:0};
          const bal = c.balance || s.balance || 0;
          const hasMilk = !!c.milkSubscription;
          const milkBadge = hasMilk
            ? `<span class="badge ${c.milkSubscription.status==='active'?'badge-green':'badge-yellow'}">${c.milkSubscription.status==='active'?'ğŸ¥› Active':'â¸ Paused'}</span>`
            : '<span style="color:var(--text3);font-size:.75rem">â€”</span>';
          const balColor = bal>0?'var(--red)':bal<0?'var(--blue)':'var(--green)';
          const balText = bal>0?'â‚¹'+bal.toFixed(0)+' due':bal<0?'Adv â‚¹'+Math.abs(bal).toFixed(0):'Settled';
          const n = c.name.replace(/'/g,"\\'");
          return `<tr onclick="openCustomerProfile(${c.customerId})" style="cursor:pointer">
            <td>
              <div style="font-weight:700">${c.name}</div>
              <div style="font-size:.73rem;color:var(--text2)">${c.phone}</div>
            </td>
            <td style="font-size:.82rem;color:var(--text2)">${c.address||'â€”'}</td>
            <td>${milkBadge}</td>
            <td style="font-weight:700;color:${balColor}">${balText}</td>
            <td onclick="event.stopPropagation()"><div class="actions">
              <button class="btn btn-blue" onclick="openCustomerProfile(${c.customerId})">ğŸ‘¤ Open</button>
              <button class="btn btn-green" onclick="quickAddCredit(${c.customerId},'${n}')">+ Udhar</button>
              ${bal>0?`<button class="btn btn-gray" onclick="quickPayment(${c.customerId},'${n}',${bal.toFixed(0)})">Paid</button>`:''}
            </div></td>
          </tr>`;
        }).join('')}</tbody>
      </table></div>
    </div>
    <div id="customerProfile"></div>`;
}

function filterCustTable(q) {
  q = q.toLowerCase();
  document.querySelectorAll('#custTable tbody tr').forEach(r => {
    r.style.display = r.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}

// â”€â”€ CUSTOMER PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _profileData = null;

async function openCustomerProfile(customerId) {
  accountSelectedId = customerId;
  const profDiv = document.getElementById('customerProfile');
  if (!profDiv) return goTo('customers');
  profDiv.innerHTML = `<div class="card" style="margin-top:1.2rem"><div class="card-body" style="text-align:center;padding:2rem;color:var(--text2)">Loading profile...</div></div>`;
  profDiv.scrollIntoView({behavior:'smooth'});

  const r = await fetch('/api/admin/customers/'+customerId, {headers:ah()});
  if (!r.ok) { toast('Could not load customer'); return; }
  _profileData = await r.json();
  renderProfileUI(customerId, 'ledger');
}

function renderProfileUI(customerId, activeTab) {
  const data = _profileData;
  if (!data) return;
  const c = data.customer;
  const sub = data.milkSubscription;
  const profDiv = document.getElementById('customerProfile');
  if (!profDiv) return;

  const bal = data.balance || 0;
  const _curMonth = new Date().toISOString().slice(0,7);
  const _mLogs = (data.milkLogs||[]).filter(l=>l.date&&l.date.slice(0,7)===_curMonth);
  const totalL = _mLogs.reduce((s,l)=>s+l.qty,0);
  const milkAmt = _mLogs.reduce((s,l)=>{
    if (l.items&&l.items.length) return s+l.items.reduce((is,i)=>is+parseFloat(i.qty||0)*parseFloat(i.price||0),0);
    return s+l.qty*(l.price||sub?.pricePerLitre||60);
  },0);
  const n = c.name.replace(/'/g,"\\'");

  profDiv.innerHTML = `
    <div class="card" style="margin-top:1.2rem">
      <div class="card-header" style="background:linear-gradient(135deg,#f0fdf4,#fff)">
        <div>
          <div style="font-size:1.05rem;font-weight:800">${c.name}</div>
          <div style="font-size:.8rem;color:var(--text2)">${c.phone}${c.address?' Â· '+c.address:''}</div>
        </div>
        <div class="actions">
          <button class="btn btn-green" onclick="quickAddCredit(${customerId},'${n}')">+ Udhar</button>
          <button class="btn btn-blue" onclick="quickPayment(${customerId},'${n}',${bal.toFixed(0)})">ğŸ’° Payment</button>
          <button class="btn btn-gray" onclick="document.getElementById('customerProfile').innerHTML=''">âœ• Close</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:.8rem;padding:1rem 1.4rem;background:var(--bg);border-bottom:1px solid var(--border)">
        <div class="stat-card" style="margin:0;padding:.7rem 1rem"><div class="stat-val" style="font-size:1.1rem;color:${bal>0?'var(--red)':'var(--green)'}">${bal>0?'â‚¹'+bal.toFixed(0)+' due':bal<0?'Adv â‚¹'+Math.abs(bal).toFixed(0):'Settled'}</div><div class="stat-lbl">Balance</div></div>
        <div class="stat-card" style="margin:0;padding:.7rem 1rem"><div class="stat-val" style="font-size:1.1rem">${(data.orders||[]).length}</div><div class="stat-lbl">Orders</div></div>
        <div class="stat-card" style="margin:0;padding:.7rem 1rem"><div class="stat-val" style="font-size:1.1rem">${totalL.toFixed(1)}L</div><div class="stat-lbl">Milk (Month)</div></div>
        <div class="stat-card" style="margin:0;padding:.7rem 1rem"><div class="stat-val" style="font-size:1.1rem">â‚¹${milkAmt.toFixed(0)}</div><div class="stat-lbl">Milk Bill</div></div>
      </div>
      <div class="profile-tabs">
        ${[['ledger','ğŸ“’ Udhar Ledger'],['orders','ğŸ›’ Orders'],['milk','ğŸ¥› Milk'],['info','ğŸ‘¤ Profile']].map(([tab,label])=>`
          <button class="ptab-btn ${tab===activeTab?'active':''}" onclick="switchProfileTab('${tab}',${customerId})">${label}</button>`).join('')}
      </div>
      <div id="profileTabContent">
        ${activeTab==='ledger'?renderLedgerTab(data,customerId):''}
        ${activeTab==='orders'?renderOrdersTab(data,customerId):''}
        ${activeTab==='milk'?renderMilkTab(data,customerId):''}
        ${activeTab==='info'?renderInfoTab(data,customerId):''}
      </div>
    </div>`;
  profDiv.scrollIntoView({behavior:'smooth'});
}

function switchProfileTab(tab, customerId) {
  document.querySelectorAll('.ptab-btn').forEach(b => {
    const t = b.getAttribute('onclick').match(/'(\w+)'/)[1];
    b.classList.toggle('active', t===tab);
  });
  const content = document.getElementById('profileTabContent');
  if (!content) return;
  if (tab==='ledger') content.innerHTML = renderLedgerTab(_profileData, customerId);
  else if (tab==='orders') content.innerHTML = renderOrdersTab(_profileData, customerId);
  else if (tab==='milk') content.innerHTML = renderMilkTab(_profileData, customerId);
  else if (tab==='info') content.innerHTML = renderInfoTab(_profileData, customerId);
}

function renderLedgerTab(data, customerId) {
  const ledger = [
    ...(data.ledgerEntries||[]).map(e=>({...e,_src:'ledger'})),
    ...(data.udharEntries||[]).map(e=>({...e,_t:'credit',_src:'old',_d:e.date})),
    ...(data.udharPayments||[]).map(p=>({...p,_t:'payment',_src:'old',_d:p.date||p.paidAt?.slice(0,10)||''}))
  ].sort((a,b)=>(b.date||b._d||'').localeCompare(a.date||a._d||''));

  const rows = ledger.length===0
    ? `<tr><td colspan="5" style="text-align:center;color:var(--text2);padding:2rem">No transactions yet</td></tr>`
    : ledger.map(entry => {
        if (entry._src === 'ledger') {
          const isCredit = entry.type === 'credit';
          return `<tr>
            <td style="white-space:nowrap">${fmtDate(entry.date)}</td>
            <td>${isCredit?'<span class="badge badge-red">Udhar</span>':'<span class="badge badge-green">Payment</span>'}</td>
            <td>${entry.note||'â€”'}</td>
            <td style="font-weight:700;color:${isCredit?'var(--red)':'var(--green)'}">${isCredit?'+':'âˆ’'}â‚¹${(entry.amount||0).toFixed(0)}</td>
            <td><div class="actions">
              <button class="btn btn-red" style="font-size:.7rem;padding:.22rem .55rem" onclick="delLedgerEntry(${entry.id},${customerId})">Del</button>
            </div></td>
          </tr>`;
        } else if (entry._t === 'credit') {
          const desc = (entry.items||[]).map(i=>i.name+(i.qty>1?' Ã—'+i.qty:'')).join(', ')||entry.note||'Purchase';
          return `<tr>
            <td style="white-space:nowrap">${fmtDate(entry._d)}</td>
            <td><span class="badge badge-red">Udhar</span></td>
            <td>${desc}</td>
            <td style="font-weight:700;color:var(--red)">+â‚¹${(entry.amount||0).toFixed(0)}</td>
            <td><div class="actions">
              <button class="btn btn-blue" style="font-size:.7rem;padding:.22rem .55rem" onclick="editUdharEntry(${entry.id},${customerId})">Edit</button>
              <button class="btn btn-red" style="font-size:.7rem;padding:.22rem .55rem" onclick="delUdharEntry(${entry.id},${customerId})">Del</button>
            </div></td>
          </tr>`;
        } else {
          return `<tr style="background:#f0fdf4">
            <td style="white-space:nowrap">${fmtDate(entry._d)}</td>
            <td><span class="badge badge-green">Payment</span></td>
            <td>${entry.note||entry.method||'Cash'}</td>
            <td style="font-weight:700;color:var(--green)">âˆ’â‚¹${(entry.amount||0).toFixed(0)}</td>
            <td><button class="btn btn-red" style="font-size:.7rem;padding:.22rem .55rem" onclick="delUdharPayment(${entry.id},${customerId})">Del</button></td>
          </tr>`;
        }
      }).join('');

  return `
    <div style="padding:1rem 1.4rem;border-bottom:1px solid var(--border);background:#fffbeb">
      <div style="font-size:.85rem;font-weight:700;margin-bottom:.7rem">+ Add Udhar / Credit Entry</div>
      <div id="udharItemsContainer">
        <div class="udhar-item-row" style="display:grid;grid-template-columns:3fr 1fr 1fr auto;gap:.4rem;margin-bottom:.4rem">
          <input type="text" placeholder="Item name" class="ui_name" style="border:1.5px solid var(--border);border-radius:8px;padding:.4rem .7rem;font-size:.84rem;font-family:inherit">
          <input type="number" placeholder="Qty" class="ui_qty" value="1" style="border:1.5px solid var(--border);border-radius:8px;padding:.4rem .6rem;font-size:.84rem;font-family:inherit">
          <input type="number" placeholder="â‚¹" class="ui_price" style="border:1.5px solid var(--border);border-radius:8px;padding:.4rem .6rem;font-size:.84rem;font-family:inherit">
          <button onclick="this.parentElement.remove()" style="background:var(--red-bg);color:var(--red);border:none;border-radius:8px;padding:.4rem .6rem;cursor:pointer">âœ•</button>
        </div>
      </div>
      <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin-top:.4rem">
        <button class="btn btn-gray" style="font-size:.78rem" onclick="addUdharItemRow()">+ More items</button>
        <input type="date" id="ud_date" value="${new Date().toISOString().slice(0,10)}" style="border:1.5px solid var(--border);border-radius:8px;padding:.4rem .6rem;font-size:.82rem;font-family:inherit">
        <input type="text" id="ud_note" placeholder="Note (optional)" style="border:1.5px solid var(--border);border-radius:8px;padding:.4rem .7rem;font-size:.82rem;font-family:inherit;flex:1;min-width:100px">
        <input type="number" id="ud_manual_total" placeholder="Or total â‚¹" style="border:1.5px solid var(--border);border-radius:8px;padding:.4rem .7rem;font-size:.82rem;font-family:inherit;width:120px">
        <button class="btn btn-red" style="font-weight:700" onclick="saveUdharEntry(${customerId})">Save Udhar</button>
      </div>
    </div>
    <div style="padding:1rem 1.4rem">
      <div style="font-size:.82rem;font-weight:700;margin-bottom:.6rem">ğŸ“’ Transaction Ledger</div>
      <table>
        <thead><tr><th>Date</th><th>Type</th><th>Description</th><th>Amount</th><th></th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
}

function renderOrdersTab(data, customerId) {
  const orders = (data.orders||[]).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
  if (!orders.length) return `<div class="empty-state"><div class="ei">ğŸ›’</div><p>No orders yet.</p></div>`;
  return `<div style="padding:1rem 1.4rem">
    <div style="font-size:.82rem;font-weight:700;margin-bottom:.8rem">ğŸ›’ Orders (${orders.length})</div>
    ${orders.map(o=>`
      <div style="border:1px solid var(--border);border-radius:10px;padding:1rem;margin-bottom:.7rem">
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:.5rem">
          <div>
            <div style="font-weight:700">Order #${o.id}</div>
            <div style="font-size:.75rem;color:var(--text2)">${fmtDateTime(o.createdAt)}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:800;color:var(--green)">â‚¹${o.total}</div>
            <span class="badge ${o.status==='delivered'?'badge-green':o.status==='cancelled'?'badge-red':'badge-yellow'}">${o.status}</span>
          </div>
        </div>
        <div style="font-size:.82rem;color:var(--text2);margin-bottom:.6rem">${(o.items||[]).map(i=>i.name+' Ã—'+i.qty).join(', ')}</div>
        <div class="actions">
          <button class="btn btn-green" style="font-size:.75rem" onclick="quickUpdateOrder(${o.id},'delivered')">âœ“ Delivered</button>
          <button class="btn btn-blue" style="font-size:.75rem" onclick="quickUpdateOrder(${o.id},'accepted')">Accept</button>
          <button class="btn btn-yellow" style="font-size:.75rem" onclick="convertOrderToUdhar(${o.id},${customerId})" ${o.addedToUdhar?'disabled':''}>
            ${o.addedToUdhar?'âœ“ In Udhar':'â†’ Add to Udhar'}
          </button>
          <button class="btn btn-gray" style="font-size:.75rem" onclick="markOrderPaid(${o.id},${customerId})">Mark Paid</button>
          <button class="btn btn-red" style="font-size:.75rem" onclick="deleteOrderFromProfile(${o.id},${customerId})">Delete</button>
        </div>
      </div>`).join('')}
  </div>`;
}

function renderMilkTab(data, customerId) {
  const sub = data.milkSubscription;
  const allLogs = [...(data.milkLogs||[])].sort((a,b)=>b.date.localeCompare(a.date));
  const thisMonth = new Date().toISOString().slice(0,7);
  const monthLogs = allLogs.filter(l=>l.date.slice(0,7)===thisMonth);
  const totalL = monthLogs.reduce((s,l)=>s+l.qty,0);
  const milkAmt = monthLogs.reduce((s,l)=>{
    if (l.items&&l.items.length) return s+l.items.reduce((is,i)=>is+parseFloat(i.qty||0)*parseFloat(i.price||0),0);
    return s+l.qty*(l.price||sub?.pricePerLitre||60);
  },0);

  // Build subscription default items display
  let subItemsDisplay = '';
  if (sub) {
    if (sub.defaultItems && sub.defaultItems.length) {
      subItemsDisplay = sub.defaultItems.map(i=>`<span class="badge badge-blue">${i.qty}L ${i.type} @ â‚¹${i.price}/L</span>`).join(' ');
    } else {
      subItemsDisplay = `<span class="badge badge-blue">${sub.defaultQty}L @ â‚¹${sub.pricePerLitre||60}/L</span>`;
    }
  }

  return `
    <div style="padding:1rem 1.4rem">
      ${sub ? `
        <div style="background:var(--bg);border-radius:12px;padding:1rem;margin-bottom:1rem;border:1px solid var(--border)">
          <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:.6rem">
            <div>
              <div style="font-weight:700;font-size:.95rem">ğŸ¥› Milk Subscription</div>
              <div style="font-size:.75rem;color:var(--text2);margin-top:.1rem">Since ${fmtDate(sub.startDate)} Â· <span class="badge ${sub.status==='active'?'badge-green':'badge-yellow'}" style="font-size:.7rem">${sub.status}</span></div>
            </div>
            <div class="actions">
              ${sub.status==='active'
                ?`<button class="btn btn-gray" style="font-size:.72rem" onclick="pauseMilkSub(${customerId})">Pause</button>`
                :`<button class="btn btn-green" style="font-size:.72rem" onclick="resumeMilkSub(${customerId})">Resume</button>`}
              <button class="btn btn-blue" style="font-size:.72rem" onclick="editMilkSubModal(${customerId})">âœï¸ Edit</button>
              <button class="btn btn-red" style="font-size:.72rem" onclick="deleteMilkSub(${customerId})">Remove</button>
            </div>
          </div>
          <div style="font-size:.78rem;font-weight:600;color:var(--text2);margin-bottom:.3rem">DAILY DELIVERY</div>
          <div style="display:flex;flex-wrap:wrap;gap:.3rem">${subItemsDisplay}</div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem;margin-bottom:1rem">
          <div class="stat-card" style="margin:0;padding:.7rem 1rem"><div class="stat-val" style="font-size:1.1rem">${sub.defaultQty}L</div><div class="stat-lbl">Daily Total</div></div>
          <div class="stat-card" style="margin:0;padding:.7rem 1rem"><div class="stat-val" style="font-size:1.1rem">${totalL.toFixed(1)}L</div><div class="stat-lbl">This Month</div></div>
          <div class="stat-card" style="margin:0;padding:.7rem 1rem"><div class="stat-val" style="font-size:1.1rem">â‚¹${milkAmt.toFixed(0)}</div><div class="stat-lbl">Month Bill</div></div>
        </div>
        <div style="margin-bottom:.7rem;display:flex;align-items:center;justify-content:space-between">
          <div style="font-size:.82rem;font-weight:700">Delivery Log</div>
          <button class="btn ${(data.milkLogs||[]).find(l=>l.date===new Date().toISOString().slice(0,10))?'btn-blue':'btn-green'}" style="font-size:.75rem" onclick="markTodayFromProfile(${customerId})">${(data.milkLogs||[]).find(l=>l.date===new Date().toISOString().slice(0,10))?'âœï¸ Edit Today':'+ Mark Today'}</button>
        </div>
        <table>
          <thead><tr><th>Date</th><th>Delivery</th><th>Amount</th><th></th></tr></thead>
          <tbody>${allLogs.slice(0,60).map(l=>{
            const amt = l.items&&l.items.length ? l.items.reduce((s,i)=>s+parseFloat(i.qty||0)*parseFloat(i.price||0),0) : l.qty*(l.price||sub?.pricePerLitre||60);
            const desc = l.items&&l.items.length ? l.items.map(i=>`${i.qty}L ${i.type}`).join(', ') : `${l.qty}L`;
            return `<tr>
            <td>${fmtDate(l.date)}</td>
            <td style="font-size:.8rem">${desc}</td>
            <td>â‚¹${amt.toFixed(0)}</td>
            <td><button class="btn btn-gray" style="font-size:.7rem;padding:.2rem .5rem" onclick="editMilkLogFromProfile(${customerId},'${l.date}')">Edit</button></td>
          </tr>`;}).join('')}</tbody>
        </table>
      ` : `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:.5rem 0">
          <div style="color:var(--text2);font-size:.88rem">No milk subscription yet</div>
          <button class="btn btn-blue" onclick="addMilkSubForCustomer(${customerId})">+ Add Milk Subscription</button>
        </div>`}
    </div>`;
}

function renderInfoTab(data, customerId) {
  const c = data.customer;
  return `
    <div style="padding:1.2rem 1.4rem">
      <div style="font-size:.82rem;font-weight:700;margin-bottom:.8rem">ğŸ‘¤ Customer Info</div>
      <div class="form-row">
        <div class="form-group" style="margin:0"><label>Full Name</label><input type="text" id="ei_name" value="${c.name}" style="width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.5rem .8rem;font-size:.88rem"></div>
        <div class="form-group" style="margin:0"><label>Phone</label><input type="text" id="ei_phone" value="${c.phone}" style="width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.5rem .8rem;font-size:.88rem"></div>
      </div>
      <div class="form-group" style="margin-top:.7rem"><label>Address</label><input type="text" id="ei_address" value="${c.address||''}" style="width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.5rem .8rem;font-size:.88rem"></div>
      <div class="form-row">
        <div class="form-group" style="margin:0"><label>Block</label><input type="text" id="ei_block" value="${c.block||''}" style="width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.5rem .8rem;font-size:.88rem"></div>
        <div class="form-group" style="margin:0"><label>Villa / Flat</label><input type="text" id="ei_villa" value="${c.villa||''}" style="width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.5rem .8rem;font-size:.88rem"></div>
      </div>
      <div class="form-group" style="margin-top:.7rem"><label>Notes</label><textarea id="ei_notes" rows="2" style="width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.5rem .8rem;font-size:.88rem;resize:vertical">${c.notes||''}</textarea></div>
      <div class="form-group"><label>Customer PIN</label>
        ${c.pinPlain
          ? `<div style="display:flex;align-items:center;gap:.8rem;background:#f0fdf4;border:1.5px solid #86efac;border-radius:8px;padding:.6rem .9rem">
               <span style="font-size:1.3rem;font-weight:800;font-family:monospace;letter-spacing:.15em;color:#15803d">${c.pinPlain}</span>
               <span class="badge badge-green" style="font-size:.7rem">âœ“ Active</span>
             </div>
             <div style="font-size:.75rem;color:var(--text2);margin-top:.3rem">Customer has registered. Share this PIN only if they forget it.</div>`
          : `<div style="background:#fffbeb;border:1.5px solid #f59e0b;border-radius:8px;padding:.6rem .9rem;font-size:.82rem;color:#92400e">
               â³ <strong>Waiting for customer to register</strong><br>
               <span style="font-size:.78rem">Ask them to open the app and sign up with <strong>${c.phone}</strong>. Their PIN will appear here automatically.</span>
             </div>`}
      </div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn btn-green" onclick="saveCustomerInfo(${customerId})">ğŸ’¾ Save Info</button>
        <button class="btn btn-red" onclick="deleteCustomer(${customerId})">ğŸ—‘ï¸ Delete Customer</button>
      </div>
    </div>`;
}

// â”€â”€ CUSTOMER CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddCustomerModal() {
  document.body.insertAdjacentHTML('beforeend',`
    <div id="addCustModal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:3000;display:flex;align-items:center;justify-content:center;padding:1rem">
      <div style="background:#fff;border-radius:18px;width:min(500px,100%);max-height:90vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,.25)">
        <div style="padding:1.2rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:#fff">
          <div><div style="font-weight:700;font-size:1rem">Add New Customer</div><div style="font-size:.74rem;color:var(--text2)">Customer only. Milk added separately by admin.</div></div>
          <button onclick="document.getElementById('addCustModal').remove()" style="background:none;font-size:1.3rem;cursor:pointer;border:none;color:var(--text2)">âœ•</button>
        </div>
        <div style="padding:1.4rem">
          <div class="form-row">
            <div class="form-group" style="margin:0"><label>Full Name *</label><input type="text" id="nc_name" placeholder="e.g. Raj Kumar" style="width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.5rem .8rem;font-size:.88rem"></div>
            <div class="form-group" style="margin:0"><label>Phone *</label><input type="tel" id="nc_phone" placeholder="10-digit" maxlength="10" style="width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.5rem .8rem;font-size:.88rem"></div>
          </div>
          <div class="form-group" style="margin-top:.7rem"><label>Address</label><input type="text" id="nc_address" placeholder="Villa / Block" style="width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.5rem .8rem;font-size:.88rem"></div>
          <div class="form-row" style="margin-top:.7rem">
            <div class="form-group" style="margin:0"><label>Block</label><input type="text" id="nc_block" placeholder="A / B / C..." style="width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.5rem .8rem;font-size:.88rem"></div>
            <div class="form-group" style="margin:0"><label>Villa / Flat</label><input type="text" id="nc_villa" placeholder="14" style="width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.5rem .8rem;font-size:.88rem"></div>
          </div>
          <div class="form-group" style="margin-top:.7rem"><label>PIN</label>
            <div style="background:#fffbeb;border:1.5px solid #f59e0b;border-radius:8px;padding:.7rem .9rem;font-size:.82rem;color:#92400e;line-height:1.5">
              ğŸ“± <strong>No PIN needed from you.</strong><br>
              Just add their phone number. When the customer opens the app and registers with the <strong>same number</strong>, the system will automatically link to this account and save their PIN â€” which you'll see here.
            </div>
          </div>
          <hr style="border:none;border-top:1px solid var(--border);margin:.8rem 0">
          <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.6rem">
            <input type="checkbox" id="nc_addMilk" onchange="toggleMilkSection()" style="width:16px;height:16px;accent-color:var(--green)">
            <label for="nc_addMilk" style="font-size:.88rem;font-weight:600;cursor:pointer">ğŸ¥› Also add milk subscription</label>
          </div>
          <div id="nc_milkSection" style="display:none;background:var(--bg);border-radius:10px;padding:.8rem 1rem;border:1px solid var(--border)">
            <div style="font-size:.8rem;color:var(--text2)">âœ… A milk subscription will be added after customer is created. You can set the exact milk types and prices from the customer's profile.</div>
            <div class="form-group" style="margin-top:.7rem;margin-bottom:0"><label>Start Date</label><input type="date" id="nc_milkStart" value="${new Date().toISOString().slice(0,10)}" style="width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.5rem .8rem;font-size:.88rem"></div>
          </div>
        </div>
        <div style="padding:1rem 1.5rem;border-top:1px solid var(--border);display:flex;gap:.5rem;justify-content:flex-end">
          <button class="btn btn-gray" onclick="document.getElementById('addCustModal').remove()">Cancel</button>
          <button class="btn btn-green" onclick="saveNewCustomer()">Add Customer</button>
        </div>
      </div>
    </div>`);
}

function toggleMilkSection() {
  document.getElementById('nc_milkSection').style.display = document.getElementById('nc_addMilk').checked ? 'block' : 'none';
}

async function saveNewCustomer() {
  const name = document.getElementById('nc_name')?.value.trim();
  const phone = document.getElementById('nc_phone')?.value.trim();
  if (!name) return toast('Name is required');
  if (!phone || phone.length < 10) return toast('Valid 10-digit phone required');
  const body = {name, phone, address: document.getElementById('nc_address')?.value.trim()||'', block: document.getElementById('nc_block')?.value.trim()||'', villa: document.getElementById('nc_villa')?.value.trim()||''};
  const r = await fetch('/api/admin/customers',{method:'POST',headers:ah(),body:JSON.stringify(body)});
  const d = await r.json();
  if (!r.ok) return toast(d.error||'Failed to add customer');
  const cid = d.customer.customerId;
  if (document.getElementById('nc_addMilk')?.checked) {
    await fetch('/api/admin/milk/subscriptions',{method:'POST',headers:ah(),body:JSON.stringify({customerId:cid,defaultQty:0.5,startDate:document.getElementById('nc_milkStart')?.value||new Date().toISOString().slice(0,10)})});
  }
  document.getElementById('addCustModal')?.remove();
  toast('Customer added!');
  await loadCustomersData();
  renderCustomersPage();
}

async function saveCustomerInfo(customerId) {
  const body = {name:document.getElementById('ei_name')?.value.trim(),phone:document.getElementById('ei_phone')?.value.trim(),address:document.getElementById('ei_address')?.value.trim(),block:document.getElementById('ei_block')?.value.trim(),villa:document.getElementById('ei_villa')?.value.trim(),notes:document.getElementById('ei_notes')?.value.trim()};
  const r = await fetch('/api/admin/customers/'+customerId,{method:'PUT',headers:ah(),body:JSON.stringify(body)});
  if (!r.ok) return toast('Failed to save');
  toast('Customer info saved!');
  await refreshProfile(customerId);
}

async function deleteCustomer(customerId) {
  if (!confirm('Soft delete this customer? Their data will be preserved but account hidden.')) return;
  await fetch('/api/admin/customers/'+customerId,{method:'DELETE',headers:ah()});
  toast('Customer deleted (soft)');
  document.getElementById('customerProfile').innerHTML = '';
  await loadCustomersData();
  renderCustomersPage();
}

async function refreshProfile(customerId) {
  const r = await fetch('/api/admin/customers/'+customerId,{headers:ah()});
  if (r.ok) { _profileData = await r.json(); renderProfileUI(customerId,'ledger'); }
}

// â”€â”€ UNDO TOAST helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function undoToast(message, onConfirm, onUndo) {
  document.getElementById('_undoToast')?.remove();
  document.body.insertAdjacentHTML('beforeend', `
    <div id="_undoToast" style="position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);background:#1a1a2e;color:#fff;padding:.65rem 1rem .65rem 1.2rem;border-radius:12px;font-size:.83rem;font-weight:500;z-index:9999;display:flex;align-items:center;gap:.8rem;box-shadow:0 6px 24px rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.08)">
      <span>${message}</span>
      <button onclick="undoAction()" style="background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:7px;padding:4px 10px;font-size:.78rem;font-weight:700;cursor:pointer;white-space:nowrap">â†© Undo</button>
      <div id="_undoBar" style="position:absolute;bottom:0;left:0;height:3px;background:var(--green);border-radius:0 0 0 12px;animation:undoShrink 5s linear forwards"></div>
    </div>
    <style>@keyframes undoShrink{from{width:100%}to{width:0%}}</style>`);
  window._undoAction = onUndo;
  window._undoTimer = setTimeout(() => {
    document.getElementById('_undoToast')?.remove();
    onConfirm();
  }, 5000);
}
function undoAction() {
  clearTimeout(window._undoTimer);
  document.getElementById('_undoToast')?.remove();
  if (window._undoAction) window._undoAction();
  toast('Deletion cancelled');
}

// â”€â”€ LEDGER ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function delLedgerEntry(id, customerId) {
  undoToast('Ledger entry deleted',
    async () => { // confirmed after 5s â€” actually delete
      await fetch('/api/admin/ledger/'+id,{method:'DELETE',headers:ah()});
      await refreshProfile(customerId);
    },
    () => {} // undo â€” do nothing (entry not deleted yet)
  );
}

async function delUdharEntry(id, customerId) {
  undoToast('Udhar entry deleted',
    async () => {
      await fetch('/api/admin/udhar/'+id,{method:'DELETE',headers:ah()});
      await refreshProfile(customerId);
    },
    () => {}
  );
}

async function editUdharEntry(id, customerId) {
  const e = (_profileData.udharEntries||[]).find(x=>x.id===id);
  if (!e) return;
  miniModal({
    title: 'âœï¸ Edit Udhar Entry',
    fields: [
      { id: 'amount', label: 'Amount (â‚¹)', type: 'number', value: e.amount, min: 0 },
      { id: 'note', label: 'Note', value: e.note||'' },
    ],
    confirmLabel: 'Update', confirmClass: 'btn-blue',
    onConfirm: async ({ amount, note }) => {
      await fetch('/api/admin/udhar/'+id,{method:'PUT',headers:ah(),body:JSON.stringify({amount:parseFloat(amount)||e.amount,note:note||''})});
      toast('Updated!');
      await refreshProfile(customerId);
    }
  });
}

async function delUdharPayment(id, customerId) {
  undoToast('Payment record deleted',
    async () => {
      await fetch('/api/admin/udhar-payments/'+id,{method:'DELETE',headers:ah()});
      await refreshProfile(customerId);
    },
    () => {}
  );
}

function addUdharItemRow() {
  document.getElementById('udharItemsContainer').insertAdjacentHTML('beforeend',`
    <div class="udhar-item-row" style="display:grid;grid-template-columns:3fr 1fr 1fr auto;gap:.4rem;margin-bottom:.4rem">
      <input type="text" placeholder="Item name" class="ui_name" style="border:1.5px solid var(--border);border-radius:8px;padding:.4rem .7rem;font-size:.84rem;font-family:inherit">
      <input type="number" placeholder="Qty" class="ui_qty" value="1" style="border:1.5px solid var(--border);border-radius:8px;padding:.4rem .6rem;font-size:.84rem;font-family:inherit">
      <input type="number" placeholder="â‚¹" class="ui_price" style="border:1.5px solid var(--border);border-radius:8px;padding:.4rem .6rem;font-size:.84rem;font-family:inherit">
      <button onclick="this.parentElement.remove()" style="background:var(--red-bg);color:var(--red);border:none;border-radius:8px;padding:.4rem .6rem;cursor:pointer">âœ•</button>
    </div>`);
}

async function saveUdharEntry(customerId) {
  const rows = document.querySelectorAll('.udhar-item-row');
  const items = []; let total = 0;
  rows.forEach(row => {
    const name = row.querySelector('.ui_name')?.value.trim();
    const qty = parseFloat(row.querySelector('.ui_qty')?.value)||1;
    const price = parseFloat(row.querySelector('.ui_price')?.value)||0;
    if (name) { items.push({name,qty,price}); total += qty*price; }
  });
  const manual = parseFloat(document.getElementById('ud_manual_total')?.value)||0;
  const amount = manual || total;
  if (!amount) return toast('Enter items with prices or a manual total');
  await fetch('/api/admin/ledger',{method:'POST',headers:ah(),body:JSON.stringify({customerId,type:'credit',amount,note:document.getElementById('ud_note')?.value.trim()||(items.length?items.map(i=>i.name).join(', '):''),date:document.getElementById('ud_date')?.value})});
  // Also save to legacy udhar for customer portal compat
  await fetch('/api/admin/udhar',{method:'POST',headers:ah(),body:JSON.stringify({customerId,items,amount,date:document.getElementById('ud_date')?.value,note:document.getElementById('ud_note')?.value.trim()||''})});
  toast('Udhar â‚¹'+amount+' saved!');
  await refreshProfile(customerId);
}

// â”€â”€ ORDER ACTIONS FROM PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function convertOrderToUdhar(orderId, customerId) {
  const r = await fetch('/api/admin/orders/'+orderId+'/convert-to-udhar',{method:'POST',headers:ah()});
  const d = await r.json();
  if (!r.ok) return toast(d.error||'Failed');
  toast('Order added to udhar!');
  await refreshProfile(customerId);
}

async function markOrderPaid(orderId, customerId) {
  const r = await fetch('/api/admin/orders/'+orderId+'/mark-paid',{method:'POST',headers:ah()});
  if (!r.ok) return toast('Failed');
  toast('Order marked as paid!');
  await refreshProfile(customerId);
}

async function deleteOrderFromProfile(orderId, customerId) {
  if (!confirm('Delete this order?')) return;
  await fetch('/api/admin/orders/'+orderId,{method:'DELETE',headers:ah()});
  toast('Order deleted');
  await refreshProfile(customerId);
}

// â”€â”€ MILK SUBSCRIPTION MODAL (shared for add & edit) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildMilkSubModal({customerId, isEdit=false, existingSub=null, defaultMilkPrice=60}) {
  const items = existingSub?.defaultItems?.length
    ? existingSub.defaultItems
    : existingSub
      ? [{type:'Full Cream', qty: existingSub.defaultQty, price: existingSub.pricePerLitre||defaultMilkPrice}]
      : [{type:'Full Cream', qty:0.5, price:defaultMilkPrice}];
  const startDate = existingSub?.startDate || new Date().toISOString().slice(0,10);

  const DAILY_ITEMS = ['Full Cream','Toned','Double Toned','Skimmed','Buffalo','Curd','Paneer','Buttermilk','A2 Milk','Other'];

  const renderItemRow = (item, idx) => `
    <div class="sub-item-row" style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
      <div style="flex:1.5;position:relative">
        <input list="dailyItemsList" value="${item.type}" placeholder="Product name"
          style="width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.38rem .5rem;font-size:.83rem;font-family:inherit;box-sizing:border-box">
        <datalist id="dailyItemsList">
          ${DAILY_ITEMS.map(t=>`<option value="${t}">`).join('')}
        </datalist>
      </div>
      <input type="number" placeholder="Qty (L)" value="${item.qty}" min="0.25" max="20" step="0.25"
        style="width:75px;border:1.5px solid var(--border);border-radius:8px;padding:.38rem .4rem;font-size:.83rem">
      <span style="font-size:.78rem;color:var(--text2);white-space:nowrap">L @ â‚¹</span>
      <input type="number" placeholder="Price/L" value="${item.price}" min="1" step="0.5"
        style="width:72px;border:1.5px solid var(--border);border-radius:8px;padding:.38rem .4rem;font-size:.83rem">
      <span style="font-size:.75rem;color:var(--text2)">/L</span>
      <button onclick="this.closest('.sub-item-row').remove();updateSubTotal()" style="background:none;border:none;color:var(--red);font-size:1.1rem;cursor:pointer;flex-shrink:0">âœ•</button>
    </div>`;

  const modalId = 'milkSubModal';
  document.getElementById(modalId)?.remove();
  document.body.insertAdjacentHTML('beforeend',`
    <div id="${modalId}" style="position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:3000;display:flex;align-items:center;justify-content:center;padding:1rem">
      <div style="background:#fff;border-radius:18px;width:min(500px,100%);max-height:92vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,.28)">
        <div style="padding:1.1rem 1.4rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:#fff;z-index:1">
          <div>
            <div style="font-weight:700;font-size:1rem">ğŸ¥› ${isEdit?'Edit':'Add'} Milk Subscription</div>
            <div style="font-size:.74rem;color:var(--text2)">Set daily milk items with individual prices</div>
          </div>
          <button onclick="document.getElementById('${modalId}').remove()" style="background:none;font-size:1.3rem;cursor:pointer;border:none;color:var(--text2)">âœ•</button>
        </div>
        <div style="padding:1.3rem 1.4rem">
          <div style="font-size:.78rem;font-weight:700;color:var(--text2);margin-bottom:.5rem;text-transform:uppercase;letter-spacing:.05em">Daily Milk Items</div>
          <div id="subItemsList">${items.map((item,i)=>renderItemRow(item,i)).join('')}</div>
          <button class="btn btn-gray" style="font-size:.8rem;margin-top:.2rem;margin-bottom:1rem"
            onclick="
              const row = document.createElement('div');
              row.className='sub-item-row';
              row.style='display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem';
              row.innerHTML='<div style=\'flex:1.5;position:relative\'><input list=\'dailyItemsList\' placeholder=\'Product name\' value=\'Full Cream\' style=\'width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.38rem .5rem;font-size:.83rem;font-family:inherit;box-sizing:border-box\'></div><input type=\'number\' placeholder=\'Qty (L)\' value=\'0.5\' min=\'0.25\' max=\'20\' step=\'0.25\' style=\'width:75px;border:1.5px solid var(--border);border-radius:8px;padding:.38rem .4rem;font-size:.83rem\'><span style=\'font-size:.78rem;color:var(--text2);white-space:nowrap\'>L @ â‚¹</span><input type=\'number\' placeholder=\'Price/L\' value=\'' + defaultMilkPrice + '\' min=\'1\' step=\'0.5\' style=\'width:72px;border:1.5px solid var(--border);border-radius:8px;padding:.38rem .4rem;font-size:.83rem\'><span style=\'font-size:.75rem;color:var(--text2)\'>/L</span><button onclick=\'this.closest(&quot;.sub-item-row&quot;).remove();updateSubTotal()\' style=\'background:none;border:none;color:var(--red);font-size:1.1rem;cursor:pointer;flex-shrink:0\'>âœ•</button>';
              document.getElementById('subItemsList').appendChild(row);
              updateSubTotal();">
            + Add Another Milk Type
          </button>
          <div style="background:var(--bg);border-radius:10px;padding:.8rem 1rem;margin-bottom:1rem;display:flex;align-items:center;justify-content:space-between">
            <div style="font-size:.83rem;color:var(--text2)">Daily Total</div>
            <div id="subTotalDisplay" style="font-weight:700;font-size:1rem;color:var(--green)">â‚¹0</div>
          </div>
          ${!isEdit ? `<div class="form-group" style="margin-bottom:.8rem"><label>Start Date</label><input type="date" id="subStartDate" value="${startDate}" style="width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.5rem .8rem;font-size:.88rem"></div>` : ''}
        </div>
        <div style="padding:1rem 1.4rem;border-top:1px solid var(--border);display:flex;gap:.5rem;justify-content:flex-end">
          <button class="btn btn-gray" onclick="document.getElementById('${modalId}').remove()">Cancel</button>
          <button class="btn btn-green" onclick="${isEdit?`saveEditedMilkSub(${customerId})`:`saveNewMilkSub(${customerId})`}">ğŸ’¾ ${isEdit?'Save Changes':'Add Subscription'}</button>
        </div>
      </div>
    </div>`);
  // Calculate initial total
  updateSubTotal();
}

function updateSubTotal() {
  let total = 0;
  document.querySelectorAll('#subItemsList .sub-item-row').forEach(row => {
    const inputs = row.querySelectorAll('input[type=number]');
    const qty = parseFloat(inputs[0]?.value)||0;
    const price = parseFloat(inputs[1]?.value)||0;
    total += qty * price;
  });
  const el = document.getElementById('subTotalDisplay');
  if (el) el.textContent = 'â‚¹' + total.toFixed(0) + '/day';
}

function getSubItemsFromModal() {
  const items = [];
  document.querySelectorAll('#subItemsList .sub-item-row').forEach(row => {
    const nameInput = row.querySelector('input[list]');
    const inputs = row.querySelectorAll('input[type=number]');
    const qty = parseFloat(inputs[0]?.value)||0;
    const price = parseFloat(inputs[1]?.value)||0;
    const type = (nameInput?.value||'Full Cream').trim();
    if (qty > 0) items.push({type, qty, price});
  });
  return items;
}

async function addMilkSubForCustomer(customerId) {
  const settings = await fetch('/api/admin/settings',{headers:ah()}).then(r=>r.json()).catch(()=>({milkPrice:60}));
  buildMilkSubModal({customerId, isEdit:false, defaultMilkPrice: settings.milkPrice||60});
}

async function saveNewMilkSub(customerId) {
  const items = getSubItemsFromModal();
  if (!items.length) return toast('Add at least one milk type');
  const totalQty = items.reduce((s,i)=>s+i.qty,0);
  const startDate = document.getElementById('subStartDate')?.value || new Date().toISOString().slice(0,10);
  const r = await fetch('/api/admin/milk/subscriptions',{method:'POST',headers:ah(),body:JSON.stringify({
    customerId, defaultQty:totalQty, defaultItems:items, startDate
  })});
  const d = await r.json();
  if (!r.ok) return toast(d.error||'Failed');
  document.getElementById('milkSubModal')?.remove();
  toast('Milk subscription added!');
  await loadMilkData();
  await refreshProfile(customerId);
}

async function editMilkSubModal(customerId) {
  const data = _profileData;
  const sub = data?.milkSubscription;
  const settings = await fetch('/api/admin/settings',{headers:ah()}).then(r=>r.json()).catch(()=>({milkPrice:60}));
  buildMilkSubModal({customerId, isEdit:true, existingSub:sub, defaultMilkPrice:settings.milkPrice||60});
}

async function saveEditedMilkSub(customerId) {
  const items = getSubItemsFromModal();
  if (!items.length) return toast('Add at least one milk type');
  const totalQty = items.reduce((s,i)=>s+i.qty,0);
  const r = await fetch('/api/admin/milk/subscriptions/'+customerId,{method:'PUT',headers:ah(),body:JSON.stringify({
    defaultQty:totalQty, defaultItems:items
  })});
  if (!r.ok) return toast('Failed to update');
  document.getElementById('milkSubModal')?.remove();
  toast('Subscription updated!');
  await loadMilkData();
  await refreshProfile(customerId);
}

// Keep old saveMilkSubForCustomer for backward compat (add customer modal)
async function saveMilkSubForCustomer(customerId) { await saveNewMilkSub(customerId); }

async function editMilkSub(customerId, currentQty, currentPrice) {
  await editMilkSubModal(customerId);
}

async function pauseMilkSub(customerId) {
  await fetch('/api/admin/milk/subscriptions/'+customerId+'/pause',{method:'POST',headers:ah(),body:JSON.stringify({})});
  toast('Subscription paused');
  await refreshProfile(customerId);
}

async function resumeMilkSub(customerId) {
  await fetch('/api/admin/milk/subscriptions/'+customerId+'/resume',{method:'POST',headers:ah(),body:JSON.stringify({})});
  toast('Subscription resumed!');
  await refreshProfile(customerId);
}

async function deleteMilkSub(customerId) {
  if (!confirm('Remove milk subscription? Delivery logs will be kept.')) return;
  await fetch('/api/admin/milk/subscriptions/'+customerId,{method:'DELETE',headers:ah()});
  toast('Subscription removed');
  await refreshProfile(customerId);
}

// Mark today using subscription's defaultItems as pre-fill
async function markTodayFromProfile(customerId) {
  const today = new Date().toISOString().slice(0,10);
  editMilkLogFromProfile(customerId, today);
}

async function editMilkLogFromProfile(customerId, date) {
  const sub = _profileData?.milkSubscription;
  const profileLogs = _profileData?.milkLogs || [];
  const existingLog = profileLogs.find(l=>l.date===date);

  // Pre-fill: existing log > subscription defaultItems > simple defaultQty
  let prefillItems;
  if (existingLog) {
    if (existingLog.items && existingLog.items.length) {
      prefillItems = existingLog.items;
    } else {
      prefillItems = [{type:'Full Cream', qty:existingLog.qty, price:existingLog.price||sub?.pricePerLitre||milkPrice||60}];
    }
  } else if (sub?.defaultItems && sub.defaultItems.length) {
    prefillItems = sub.defaultItems.map(i=>({...i})); // copy
  } else if (sub) {
    prefillItems = [{type:'Full Cream', qty:sub.defaultQty, price:sub.pricePerLitre||milkPrice||60}];
  } else {
    prefillItems = [{type:'Full Cream', qty:0.5, price:milkPrice||60}];
  }

  // Temporarily inject into milkLogs global so openMultiMilkEntry finds the entry
  const origLogs = milkLogs;
  milkLogs = profileLogs.map(l=>({...l, customerId}));
  window._multiMilkProfileCustomerId = customerId;
  // Override the entry with prefill items if no existing entry
  if (!existingLog && prefillItems) {
    // inject a fake entry so openMultiMilkEntry picks it up
    milkLogs.push({customerId, date, qty:0, items:prefillItems});
  }
  openMultiMilkEntry(customerId, date);
  milkLogs = origLogs;
}

// â”€â”€ QUICK MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ MINI MODAL HELPER (replaces browser prompt()) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function miniModal({ title, fields, confirmLabel='Save', confirmClass='btn-green', onConfirm }) {
  document.getElementById('_miniModal')?.remove();
  const fieldsHtml = fields.map(f => `
    <div>
      <label style="font-size:.77rem;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.04em;display:block;margin-bottom:.35rem">${f.label}</label>
      ${f.type === 'select'
        ? `<select id="mmf_${f.id}">${f.options.map(o=>`<option value="${o.value}" ${o.selected?'selected':''}>${o.label}</option>`).join('')}</select>`
        : `<input id="mmf_${f.id}" type="${f.type||'text'}" value="${f.value??''}" placeholder="${f.placeholder||''}" ${f.min!==undefined?`min="${f.min}"`:''}>`
      }
      ${f.hint ? `<div style="font-size:.74rem;color:var(--text3);margin-top:.3rem">${f.hint}</div>` : ''}
    </div>`).join('');
  document.body.insertAdjacentHTML('beforeend', `
    <div id="_miniModal" class="mini-modal-overlay" onclick="if(event.target===this)this.remove()">
      <div class="mini-modal">
        <div class="mini-modal-head">${title}<button onclick="document.getElementById('_miniModal').remove()" style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--text2)">âœ•</button></div>
        <div class="mini-modal-body">${fieldsHtml}</div>
        <div class="mini-modal-foot">
          <button class="btn btn-gray" onclick="document.getElementById('_miniModal').remove()">Cancel</button>
          <button class="btn ${confirmClass}" id="_mmConfirm">${confirmLabel}</button>
        </div>
      </div>
    </div>`);
  document.getElementById('_mmConfirm').onclick = () => {
    const vals = {};
    fields.forEach(f => { vals[f.id] = document.getElementById('mmf_'+f.id)?.value; });
    document.getElementById('_miniModal').remove();
    onConfirm(vals);
  };
  // Focus first input
  setTimeout(() => document.querySelector('#_miniModal input, #_miniModal select')?.focus(), 80);
}

async function quickAddCredit(customerId, name) {
  miniModal({
    title: `â• Add Udhar â€” ${name}`,
    fields: [
      { id: 'amount', label: 'Amount (â‚¹)', type: 'number', placeholder: 'e.g. 150', min: 0 },
      { id: 'note', label: 'Note / Item', placeholder: 'e.g. Milk, Bread...' },
    ],
    confirmLabel: 'Save Udhar', confirmClass: 'btn-red',
    onConfirm: async ({ amount, note }) => {
      if (!amount || isNaN(amount)) return toast('Enter a valid amount');
      await fetch('/api/admin/ledger',{method:'POST',headers:ah(),body:JSON.stringify({customerId,type:'credit',amount:parseFloat(amount),note:note||''})});
      await fetch('/api/admin/udhar',{method:'POST',headers:ah(),body:JSON.stringify({customerId,items:[],amount:parseFloat(amount),note:note||''})});
      toast('Udhar â‚¹'+amount+' added!');
      if (accountSelectedId===customerId) await refreshProfile(customerId);
      else { await loadCustomersData(); renderCustomersPage(); }
    }
  });
}

async function quickPayment(customerId, name, currentBalance) {
  miniModal({
    title: `ğŸ’° Record Payment â€” ${name}`,
    fields: [
      { id: 'amount', label: 'Amount (â‚¹)', type: 'number', placeholder: 'Amount received', min: 0, value: currentBalance > 0 ? currentBalance : '' },
      { id: 'method', label: 'Payment Method', type: 'select', options: [
        { value: 'cash', label: 'ğŸ’µ Cash', selected: true },
        { value: 'upi', label: 'ğŸ“± UPI' },
        { value: 'bank', label: 'ğŸ¦ Bank Transfer' },
        { value: 'other', label: 'Other' },
      ]},
    ],
    confirmLabel: 'Record Payment', confirmClass: 'btn-green',
    onConfirm: async ({ amount, method }) => {
      if (!amount || isNaN(amount)) return toast('Enter a valid amount');
      await fetch('/api/admin/ledger',{method:'POST',headers:ah(),body:JSON.stringify({customerId,type:'payment',amount:parseFloat(amount),note:method||'cash'})});
      await fetch('/api/admin/udhar-payments',{method:'POST',headers:ah(),body:JSON.stringify({customerId,amount:parseFloat(amount),method:method||'cash'})});
      toast('Payment â‚¹'+amount+' recorded!');
      if (accountSelectedId===customerId) await refreshProfile(customerId);
      else { await loadCustomersData(); renderCustomersPage(); }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ORDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ordersData = [];
let ordersDateFilter = 'today'; // 'today' | 'all'

async function renderOrders() {
  try {
    const qs = ordersDateFilter === 'today' ? '?date=today' : '';
    const r = await fetch('/api/admin/orders'+qs,{headers:ah()});
    ordersData = r.ok ? await r.json() : [];
    renderOrdersPage();
  } catch { toast('Failed to load orders'); }
}

function renderOrdersPage(filterStatus='') {
  const filtered = filterStatus ? ordersData.filter(o=>o.status===filterStatus) : ordersData;
  const statuses = ['pending','accepted','packed','delivered','cancelled'];
  const counts = {};
  statuses.forEach(s => { counts[s] = ordersData.filter(o=>o.status===s).length; });

  document.getElementById('content').innerHTML = `
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-val" style="color:var(--yellow)">${counts.pending||0}</div><div class="stat-lbl">Pending</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--blue)">${counts.accepted||0}</div><div class="stat-lbl">Accepted</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--green)">${counts.delivered||0}</div><div class="stat-lbl">Delivered</div></div>
      <div class="stat-card"><div class="stat-val">${ordersData.length}</div><div class="stat-lbl">${ordersDateFilter==='today'?'Today':'All Time'}</div></div>
    </div>
    <div style="display:flex;gap:.4rem;flex-wrap:wrap;margin-bottom:.6rem;align-items:center">
      <span style="font-size:.78rem;color:var(--text3);font-weight:600;margin-right:.2rem">Date:</span>
      <button class="btn ${ordersDateFilter==='today'?'btn-green':'btn-gray'}" onclick="ordersDateFilter='today';renderOrders()">ğŸ“… Today</button>
      <button class="btn ${ordersDateFilter==='all'?'btn-green':'btn-gray'}" onclick="ordersDateFilter='all';renderOrders()">All Orders</button>
    </div>
    <div style="display:flex;gap:.4rem;flex-wrap:wrap;margin-bottom:1rem">
      <button class="btn ${!filterStatus?'btn-blue':'btn-gray'}" onclick="renderOrdersPage('')">All (${ordersData.length})</button>
      ${statuses.map(s=>`<button class="btn ${filterStatus===s?'btn-blue':'btn-gray'}" onclick="renderOrdersPage('${s}')">${s} (${counts[s]||0})</button>`).join('')}
    </div>
    <div class="card">
      <div class="card-header"><h2>ğŸ“¦ Orders (${filtered.length})</h2></div>
      ${filtered.length===0?`<div class="empty-state"><div class="ei">ğŸ“¦</div><p>No orders.</p></div>`:
      filtered.map(o=>{
        const time = fmtDateTime(o.createdAt);
        const statusColors = {pending:'badge-yellow',accepted:'badge-blue',packed:'badge-purple',delivered:'badge-green',cancelled:'badge-red'};
        return `
        <div style="border-bottom:1px solid var(--border);padding:1rem 1.2rem">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:.4rem">
            <div>
              <div style="font-weight:800">Order #${o.id}</div>
              <div style="font-size:.75rem;color:var(--text2)">${time}</div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:800;font-size:1rem;color:var(--green)">â‚¹${o.total}</div>
              <span class="badge ${statusColors[o.status]||'badge-yellow'}">${o.status||'new'}</span>
            </div>
          </div>
          <div style="font-size:.85rem;margin-bottom:.3rem"><strong>${o.customerName||'Customer'}</strong> Â· ${o.phone||''}</div>
          ${o.block||o.villa?`<div style="font-size:.78rem;color:var(--text2);margin-bottom:.5rem">${[o.block,o.villa].filter(Boolean).join(' ')}</div>`:''}
          <div style="background:var(--bg);border-radius:8px;padding:.6rem .8rem;margin-bottom:.6rem">
            ${(o.items||[]).map(i=>`<div style="display:flex;justify-content:space-between;font-size:.83rem;padding:2px 0"><span>${i.name} Ã— ${i.qty}</span><span>â‚¹${i.price*i.qty}</span></div>`).join('')}
          </div>
          <div class="actions">
            <button class="btn btn-blue" onclick="quickUpdateOrder(${o.id},'accepted')">Accept</button>
            <button class="btn btn-gray" onclick="quickUpdateOrder(${o.id},'packed')">Packed</button>
            <button class="btn btn-green" onclick="quickUpdateOrder(${o.id},'delivered')">âœ“ Delivered</button>
            <button class="btn btn-yellow" onclick="convertOrderToUdharFromList(${o.id})" ${o.addedToUdhar?'disabled title=\"Already in Udhar\"':''}>
              ${o.addedToUdhar?'âœ“ Udhar':'â†’ Udhar'}
            </button>
            <button class="btn btn-red" onclick="quickUpdateOrder(${o.id},'cancelled')">Cancel</button>
            <button class="btn btn-red" style="background:var(--red-bg);color:var(--red)" onclick="deleteOrderFromList(${o.id})">ğŸ—‘ï¸</button>
          </div>
        </div>`;
      }).join('')}
    </div>`;
}

async function quickUpdateOrder(id, status) {
  const r = await fetch('/api/admin/orders/'+id,{method:'PUT',headers:ah(),body:JSON.stringify({status})});
  const result = r.ok ? await r.json() : null;
  toast('Order â†’ '+status);
  // #5: If server returns a WhatsApp notify URL (order delivered), open it
  if (result?._waNotifyUrl) {
    setTimeout(() => {
      if (confirm('Order marked delivered! Send WhatsApp notification to customer?')) {
        window.open(result._waNotifyUrl, '_blank');
      }
    }, 300);
  }
  // Refresh with current date filter
  const qs = ordersDateFilter === 'today' ? '?date=today' : '';
  const r2 = await fetch('/api/admin/orders'+qs,{headers:ah()});
  ordersData = r2.ok ? await r2.json() : ordersData;
  renderOrdersPage();
}

async function convertOrderToUdharFromList(orderId) {
  const r = await fetch('/api/admin/orders/'+orderId+'/convert-to-udhar',{method:'POST',headers:ah()});
  const d = await r.json();
  if (!r.ok) return toast(d.error||'Failed: '+d.error);
  toast('Added to udhar!');
  const qs = ordersDateFilter === 'today' ? '?date=today' : '';
  const r2 = await fetch('/api/admin/orders'+qs,{headers:ah()});
  ordersData = r2.ok ? await r2.json() : ordersData;
  renderOrdersPage();
}

async function deleteOrderFromList(orderId) {
  if (!confirm('Delete this order?')) return;
  await fetch('/api/admin/orders/'+orderId,{method:'DELETE',headers:ah()});
  toast('Order deleted');
  ordersData = ordersData.filter(o=>o.id!==orderId);
  renderOrdersPage();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UDHAR SUMMARY PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderUdhar() {
  try {
    const r = await fetch('/api/admin/udhar-summary',{headers:ah()});
    const summary = r.ok ? await r.json() : [];
    const totalOut = summary.reduce((s,x)=>s+(x.balance>0?x.balance:0),0);
    const totalRec = summary.reduce((s,x)=>s+x.totalPaid,0);

    document.getElementById('content').innerHTML = `
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-val">${summary.length}</div><div class="stat-lbl">Customers with Udhar</div></div>
        <div class="stat-card"><div class="stat-val" style="color:var(--red)">â‚¹${totalOut.toFixed(0)}</div><div class="stat-lbl">Total Outstanding</div></div>
        <div class="stat-card"><div class="stat-val" style="color:var(--green)">â‚¹${totalRec.toFixed(0)}</div><div class="stat-lbl">Total Received</div></div>
        <div class="stat-card"><div class="stat-val" style="color:var(--blue)">${summary.filter(x=>x.balance<=0).length}</div><div class="stat-lbl">Settled</div></div>
      </div>
      <div class="card">
        <div class="card-header"><h2>ğŸ“’ Udhar Balances</h2></div>
        <table>
          <thead><tr><th>Customer</th><th>Total Udhar</th><th>Paid</th><th>Balance</th><th>Actions</th></tr></thead>
          <tbody>${summary.map(s=>{
            const bal = s.balance;
            return `<tr>
              <td>
                <div style="font-weight:700;cursor:pointer;color:var(--blue)" onclick="goTo('customers');setTimeout(()=>openCustomerProfile(${s.customer.id}),200)">${s.customer.name}</div>
                <div style="font-size:.73rem;color:var(--text2)">${s.customer.phone}</div>
              </td>
              <td style="font-weight:700;color:var(--red)">â‚¹${s.totalUdhar.toFixed(0)}</td>
              <td style="color:var(--green)">â‚¹${s.totalPaid.toFixed(0)}</td>
              <td style="font-weight:800;color:${bal>0?'var(--red)':bal<0?'var(--blue)':'var(--green)'}">
                ${bal>0?'â‚¹'+bal.toFixed(0)+' due':bal<0?'Advance â‚¹'+Math.abs(bal).toFixed(0):'âœ“ Settled'}
              </td>
              <td><div class="actions">
                <button class="btn btn-green" onclick="quickAddCredit(${s.customer.id},'${s.customer.name.replace(/'/g,"\\'")}')">+ Udhar</button>
                ${bal>0?`<button class="btn btn-blue" onclick="quickPayment(${s.customer.id},'${s.customer.name.replace(/'/g,"\\'")}',${bal.toFixed(0)})">Paid</button>`:''}
              </div></td>
            </tr>`;
          }).join('')}</tbody>
        </table>
      </div>`;
  } catch(e) { toast('Failed to load udhar summary'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MILK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let milkCustomers=[], milkLogs=[], milkPayments=[], milkPrice=60;
let milkMonth=new Date().toISOString().slice(0,7);
let milkTab='deliveries';

async function renderMilk() {
  await loadMilkData();
  renderMilkPage();
}

async function loadMilkData() {
  try {
    const [cR,lR,pR] = await Promise.all([
      fetch('/api/admin/milk/customers',{headers:ah()}),
      fetch('/api/admin/milk/logs?month='+milkMonth,{headers:ah()}),
      fetch('/api/admin/milk/payments?month='+milkMonth,{headers:ah()}),
    ]);
    milkCustomers = await cR.json();
    const ld = await lR.json();
    milkLogs = ld.logs||[];
    milkPrice = ld.settings?.milkPrice||60;
    milkPayments = await pR.json();
  } catch(e) { toast('Could not load milk data'); }
}

function renderMilkPage() {
  const billed = milkLogs.reduce((s,l)=>{
    if (l.items&&l.items.length) return s+l.items.reduce((is,i)=>is+parseFloat(i.qty||0)*parseFloat(i.price||0),0);
    return s+l.qty*(l.price||milkPrice);
  },0);
  const paid = milkPayments.reduce((s,p)=>s+p.amount,0);
  const active = milkCustomers.filter(c=>c.active).length;
  const monthLabel = new Date(milkMonth+'-02').toLocaleString('default',{month:'long',year:'numeric'});

  document.getElementById('content').innerHTML=`
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-val">${active}</div><div class="stat-lbl">Active Customers</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--green)">â‚¹${billed.toFixed(0)}</div><div class="stat-lbl">Billed â€” ${monthLabel}</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--blue)">â‚¹${paid.toFixed(0)}</div><div class="stat-lbl">Collected</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--red)">â‚¹${(billed-paid).toFixed(0)}</div><div class="stat-lbl">Outstanding</div></div>
    </div>
    <div class="card">
      <div class="card-header">
        <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
          <input type="month" value="${milkMonth}" onchange="milkMonth=this.value;renderMilk()" style="border:1.5px solid var(--border);border-radius:8px;padding:.4rem .8rem;font-family:Inter,sans-serif;font-size:.85rem">
          <button class="btn ${milkTab==='deliveries'?'btn-green':'btn-gray'}" onclick="milkTab='deliveries';renderMilkPage()">Deliveries</button>
          <button class="btn ${milkTab==='customers'?'btn-green':'btn-gray'}" onclick="milkTab='customers';renderMilkPage()">Customers</button>
          <button class="btn ${milkTab==='billing'?'btn-green':'btn-gray'}" onclick="milkTab='billing';renderMilkPage()">Billing</button>
        </div>
        <button class="btn btn-blue" onclick="goTo('customers');setTimeout(openAddCustomerModal,100)">+ Add Customer</button>
      </div>
    </div>
    <div id="milkTabContent"></div>`;

  if (milkTab==='deliveries') renderMilkDeliveries();
  else if (milkTab==='customers') renderMilkCustomers();
  else renderMilkBilling();
}

function renderMilkDeliveries() {
  const today = new Date().toISOString().slice(0,10);
  const active = milkCustomers.filter(c=>c.active);
  const rows = active.map(c=>{
    const cl = milkLogs.filter(l=>l.customerId===c.id);
    const totalL = cl.reduce((s,l)=>s+l.qty,0);
    const totalAmt = cl.reduce((s,l)=>{
      if (l.items&&l.items.length) return s+l.items.reduce((is,i)=>is+parseFloat(i.qty||0)*parseFloat(i.price||0),0);
      return s+l.qty*(l.price||milkPrice);
    },0);
    const todayE = cl.find(l=>l.date===today);
    let todayBadge = `<span class="badge badge-red">Not marked</span>`;
    if (todayE) {
      if (todayE.items&&todayE.items.length) {
        const shortNames = todayE.items.map(i=>`${i.qty}L ${i.type.split(' ')[0]}`).join(', ');
        todayBadge = `<span class="badge badge-green" title="${todayE.items.map(i=>i.qty+'L '+i.type).join(', ')}">âœ“ ${shortNames}</span>`;
      } else {
        todayBadge = `<span class="badge badge-green">âœ“ ${todayE.qty}L</span>`;
      }
    }
    return `<tr>
      <td><div style="font-weight:600">${c.name}</div><div style="font-size:.73rem;color:var(--text2)">${c.phone}</div></td>
      <td style="font-size:.78rem">${
        c.defaultItems&&c.defaultItems.length
          ? c.defaultItems.map(i=>`${i.qty}L ${i.type}`).join('<br>')
          : c.defaultQty+'L/day'
      }</td>
      <td><span class="badge badge-blue">${totalL.toFixed(1)}L</span></td>
      <td style="font-weight:700;color:var(--green)">â‚¹${totalAmt.toFixed(0)}</td>
      <td>${todayBadge}</td>
      <td><div class="actions">
        <button class="btn ${todayE?'btn-blue':'btn-green'}" style="font-size:.75rem" onclick="markOne(${c.id},'${today}',${c.defaultQty})">${todayE?'âœï¸ Edit Today':'Mark Today'}</button>
        <button class="btn btn-gray" style="font-size:.75rem" onclick="openDayLog(${c.id})">Edit Log</button>
      </div></td>
    </tr>`;
  }).join('');

  document.getElementById('milkTabContent').innerHTML=`
    <div class="card">
      <div class="card-header">
        <h2>Today â€” ${new Date(today+'T12:00:00').toLocaleDateString('default',{weekday:'long',day:'numeric',month:'short'})}</h2>
        <button class="btn btn-green" onclick="bulkMark('${today}')">âœ“ Mark All Delivered</button>
      </div>
      ${active.length===0?`<div class="empty-state"><div class="ei">ğŸ¥›</div><p>No active milk customers yet.</p></div>`:`
      <table>
        <thead><tr><th>Customer</th><th>Default</th><th>This Month</th><th>Amount</th><th>Today</th><th>Actions</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`}
    </div>`;
}

function renderMilkCustomers() {
  document.getElementById('milkTabContent').innerHTML=`
    <div class="card">
      <div class="card-header"><h2>Milk Subscribers (${milkCustomers.length})</h2></div>
      ${milkCustomers.length===0?`<div class="empty-state"><div class="ei">ğŸ‘¥</div><p>No milk subscribers yet. Add from Customers section.</p></div>`:`
      <table>
        <thead><tr><th>Name</th><th>Phone</th><th>Address</th><th>Qty/day</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody>${milkCustomers.map(c=>`<tr>
          <td style="font-weight:600;cursor:pointer;color:var(--blue)" onclick="goTo('customers');setTimeout(()=>openCustomerProfile(${c.id}),200)">${c.name}</td>
          <td>${c.phone}</td>
          <td style="color:var(--text2)">${c.address||'â€”'}</td>
          <td>${c.defaultQty}L</td>
          <td>${c.active?'<span class="badge badge-green">Active</span>':'<span class="badge badge-red">Paused</span>'}</td>
          <td><div class="actions">
            <button class="btn btn-blue" onclick="toggleMilkCustomer(${c.id},${!c.active})">${c.active?'Pause':'Resume'}</button>
            <button class="btn btn-red" onclick="delMilkCustomer(${c.id})">Remove</button>
          </div></td>
        </tr>`).join('')}</tbody>
      </table>`}
    </div>`;
}

function renderMilkBilling() {
  const monthLabel = new Date(milkMonth+'-02').toLocaleString('default',{month:'long',year:'numeric'});
  const rows = milkCustomers.filter(c=>c.active).map(c=>{
    const cl = milkLogs.filter(l=>l.customerId===c.id);
    const totalL = cl.reduce((s,l)=>s+l.qty,0);
    const billed = cl.reduce((s,l)=>{
      if (l.items&&l.items.length) return s+l.items.reduce((is,i)=>is+parseFloat(i.qty||0)*parseFloat(i.price||0),0);
      return s+l.qty*(l.price||milkPrice);
    },0);
    const paid = milkPayments.filter(p=>p.customerId===c.id).reduce((s,p)=>s+p.amount,0);
    const due = billed-paid;
    const waMsg = encodeURIComponent(`Hi ${c.name}, your milk bill for this month is â‚¹${due.toFixed(0)}. Please make the payment at your earliest convenience. Thank you!`);
    const waUrl = `https://wa.me/${(c.phone||'').replace(/\D/g,'')}?text=${waMsg}`;
    return `<tr>
      <td><div style="font-weight:600">${c.name}</div><div style="font-size:.73rem;color:var(--text2)">${c.phone}</div></td>
      <td>${totalL.toFixed(1)}L</td>
      <td style="font-weight:700">â‚¹${billed.toFixed(0)}</td>
      <td style="color:var(--green);font-weight:600">â‚¹${paid.toFixed(0)}</td>
      <td style="font-weight:800;color:${due>0?'var(--red)':'var(--green)'}">â‚¹${due.toFixed(0)}</td>
      <td style="display:flex;gap:.4rem;flex-wrap:wrap">
        ${due>0?`<button class="btn btn-green" style="font-size:.75rem" onclick="recordMilkPayment(${c.id},'${milkMonth}',${due.toFixed(0)})">Paid â‚¹${due.toFixed(0)}</button>
        <a href="${waUrl}" target="_blank"><button class="btn btn-gray" style="font-size:.75rem" title="Send WhatsApp reminder">ğŸ“± Remind</button></a>`
        :'<span class="badge badge-green">Settled</span>'}
      </td>
    </tr>`;
  }).join('');

  document.getElementById('milkTabContent').innerHTML=`
    <div class="card" style="margin-bottom:1rem">
      <div class="card-header"><h2>Billing â€” ${monthLabel}</h2></div>
      <table>
        <thead><tr><th>Customer</th><th>Litres</th><th>Billed</th><th>Paid</th><th>Due</th><th>Action</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
    <div class="card" style="max-width:340px">
      <div class="card-header"><h2>Milk Price</h2></div>
      <div class="card-body">
        <div class="form-group"><label>Price per Litre (â‚¹)</label><input type="number" id="milkPriceInp" value="${milkPrice}" min="1" step="0.5"><div class="form-hint">Applies to new deliveries</div></div>
        <button class="btn btn-green" onclick="saveMilkPrice()">Save Price</button>
      </div>
    </div>`;
}

async function markOne(customerId, date, qty) {
  // Pre-fill from customer's subscription defaultItems
  const c = milkCustomers.find(x=>x.id===customerId);
  if (c && (c.defaultItems && c.defaultItems.length)) {
    // Temporarily inject into milkLogs so openMultiMilkEntry finds the right pre-fill
    const existing = milkLogs.find(l=>l.customerId===customerId&&l.date===date);
    if (!existing) {
      // Inject a fake entry with subscription defaults
      milkLogs.push({customerId, date, qty:c.defaultQty, items:c.defaultItems});
    }
  }
  openMultiMilkEntry(customerId, date);
}

async function bulkMark(date) {
  const active = milkCustomers.filter(c=>c.active);
  const unmarked = active.filter(c=>!milkLogs.find(l=>l.customerId===c.id&&l.date===date));
  if (!unmarked.length) return toast('All customers already marked for today!');

  document.getElementById('_miniModal')?.remove();
  const listHtml = unmarked.slice(0,20).map(c =>
    `<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:.84rem">
      <span style="font-weight:600">${c.name}</span>
      <span style="color:var(--text3);font-size:.76rem">${c.phone} &middot; ${c.defaultQty||1}L</span>
    </div>`
  ).join('') + (unmarked.length>20?`<div style="font-size:.8rem;color:var(--text3);padding:8px 0">...and ${unmarked.length-20} more</div>`:'');

  document.body.insertAdjacentHTML('beforeend', `
    <div id="_miniModal" class="mini-modal-overlay" onclick="if(event.target===this)this.remove()">
      <div class="mini-modal" style="max-width:480px">
        <div class="mini-modal-head">
          Milk Bulk Mark
          <button onclick="document.getElementById('_miniModal').remove()" style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--text2)">x</button>
        </div>
        <div class="mini-modal-body" style="max-height:55vh;overflow-y:auto">
          <div style="font-size:.78rem;color:var(--text3);margin-bottom:10px">
            Will mark <strong>${unmarked.length} customers</strong> as delivered for <strong>${date}</strong>:
          </div>
          ${listHtml}
        </div>
        <div class="mini-modal-foot">
          <button class="btn btn-gray" onclick="document.getElementById('_miniModal').remove()">Cancel</button>
          <button class="btn btn-green" id="_mmConfirm">Mark All ${unmarked.length} Delivered</button>
        </div>
      </div>
    </div>`);
  document.getElementById('_mmConfirm').onclick = async () => {
    document.getElementById('_miniModal').remove();
    const r = await fetch('/api/admin/milk/bulk-mark',{method:'POST',headers:ah(),body:JSON.stringify({date})});
    const d = await r.json();
    await loadMilkData(); renderMilkPage(); toast('Marked '+d.marked+' customers delivered');
  };
}

async function toggleMilkCustomer(id, active) {
  if (active) await fetch('/api/admin/milk/subscriptions/'+id+'/resume',{method:'POST',headers:ah(),body:JSON.stringify({})});
  else await fetch('/api/admin/milk/subscriptions/'+id+'/pause',{method:'POST',headers:ah(),body:JSON.stringify({})});
  await loadMilkData(); renderMilkPage();
}

async function delMilkCustomer(id) {
  if (!confirm('Remove milk subscription for this customer?')) return;
  await fetch('/api/admin/milk/subscriptions/'+id,{method:'DELETE',headers:ah()});
  await loadMilkData(); renderMilkPage(); toast('Subscription removed');
}

async function recordMilkPayment(customerId, month, amount) {
  const confirmed = confirm(`Record payment of â‚¹${amount} for this customer?`);
  if (!confirmed) return;
  await fetch('/api/admin/milk/payment',{method:'POST',headers:ah(),body:JSON.stringify({customerId,month,amount,note:'Manual'})});
  await loadMilkData(); renderMilkPage(); toast('Payment â‚¹'+amount+' recorded');
}

async function saveMilkPrice() {
  const price = parseFloat(document.getElementById('milkPriceInp').value);
  if (!price||price<=0) return toast('Invalid price');
  await fetch('/api/admin/milk/settings',{method:'PUT',headers:ah(),body:JSON.stringify({milkPrice:price})});
  milkPrice = price; toast('Price updated to â‚¹'+price+'/L');
}

function openDayLog(customerId) {
  const c = milkCustomers.find(x=>x.id===customerId);
  const cl = milkLogs.filter(l=>l.customerId===customerId);
  const [yr,mo] = milkMonth.split('-').map(Number);
  const days = new Date(yr,mo,0).getDate();
  let rows = '';
  for (let d=days;d>=1;d--) {
    const ds = milkMonth+'-'+String(d).padStart(2,'0');
    if (new Date(ds)>new Date()) continue;
    const entry = cl.find(l=>l.date===ds);
    // If entry has items array, show multi-type summary, otherwise show simple qty
    let entryDisplay = '';
    if (entry) {
      if (entry.items && entry.items.length) {
        entryDisplay = entry.items.map(i=>`${i.qty}L ${i.type} @â‚¹${i.price}`).join(', ');
      } else {
        entryDisplay = entry.qty+'L';
      }
    }
    rows += `<div style="padding:.5rem 0;border-bottom:1px solid var(--border)">
      <div style="display:flex;align-items:center;gap:.6rem">
        <div style="width:28px;text-align:center;font-weight:700;font-size:.82rem;color:var(--text2)">${d}</div>
        ${entry
          ? `<span style="font-size:.8rem;color:var(--green);flex:1">âœ“ ${entryDisplay}</span>
             <button class="btn btn-gray" style="font-size:.7rem;padding:.2rem .5rem" onclick="openMultiMilkEntry(${customerId},'${ds}')">Edit</button>
             <button class="btn btn-red" style="font-size:.7rem;padding:.2rem .5rem" onclick="saveLogEntry(${customerId},'${ds}',0)">âœ•</button>`
          : `<span style="font-size:.78rem;color:var(--text2);flex:1">Not delivered</span>
             <button class="btn btn-green" style="font-size:.7rem;padding:.2rem .5rem" onclick="openMultiMilkEntry(${customerId},'${ds}')">+ Mark</button>`}
      </div>
    </div>`;
  }
  document.body.insertAdjacentHTML('beforeend',`
    <div id="dlModal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:2000;display:flex;align-items:center;justify-content:center;padding:1rem">
      <div style="background:#fff;border-radius:18px;width:min(420px,100%);max-height:85vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,.2)">
        <div style="padding:1.2rem 1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:#fff">
          <div><div style="font-weight:700">${c?.name}</div><div style="font-size:.75rem;color:var(--text2)">Edit delivery log</div></div>
          <button onclick="document.getElementById('dlModal').remove();renderMilk()" style="background:none;font-size:1.3rem;color:var(--text2);cursor:pointer;border:none">âœ•</button>
        </div>
        <div style="padding:1rem 1.5rem">${rows}</div>
      </div>
    </div>`);
}

// Open a modal to enter multiple milk types for a specific date
function openMultiMilkEntry(customerId, date) {
  const cl = milkLogs.filter(l=>l.customerId===customerId);
  const entry = cl.find(l=>l.date===date);
  let existingItems = [];
  if (entry) {
    if (entry.items && entry.items.length) {
      existingItems = entry.items;
    } else {
      existingItems = [{type:'Full Cream', qty:entry.qty, price:entry.price||milkPrice}];
    }
  } else {
    existingItems = [{type:'Full Cream', qty:0.5, price:milkPrice}];
  }

  const DAILY_ITEMS_D = ['Full Cream','Toned','Double Toned','Skimmed','Buffalo','Curd','Paneer','Buttermilk','A2 Milk','Other'];
  const modalId = 'multiMilkModal';
  document.getElementById(modalId)?.remove();

  const renderItemRow = (item) => `
    <div class="milk-item-row" style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
      <div style="flex:1.5;position:relative">
        <input list="deliveryItemsList" value="${item.type}" placeholder="Product name"
          oninput="updateDeliveryTotal()"
          style="width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.35rem .5rem;font-size:.83rem;font-family:inherit;box-sizing:border-box">
        <datalist id="deliveryItemsList">
          ${DAILY_ITEMS_D.map(t=>`<option value="${t}">`).join('')}
        </datalist>
      </div>
      <input type="number" placeholder="Qty" value="${item.qty}" min="0" max="20" step="0.25"
        onchange="updateDeliveryTotal()"
        style="width:68px;border:1.5px solid var(--border);border-radius:8px;padding:.35rem .4rem;font-size:.83rem">
      <span style="font-size:.75rem;color:var(--text2)">L@â‚¹</span>
      <input type="number" placeholder="â‚¹/L" value="${item.price}" min="1" step="0.5"
        onchange="updateDeliveryTotal()"
        style="width:65px;border:1.5px solid var(--border);border-radius:8px;padding:.35rem .4rem;font-size:.83rem">
      <button onclick="this.closest('.milk-item-row').remove();updateDeliveryTotal()" style="background:none;border:none;color:var(--red);font-size:1.1rem;cursor:pointer;padding:0;flex-shrink:0">Ã—</button>
    </div>`;

  document.body.insertAdjacentHTML('beforeend',`
    <div id="${modalId}" style="position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:3000;display:flex;align-items:center;justify-content:center;padding:1rem">
      <div style="background:#fff;border-radius:18px;width:min(460px,100%);box-shadow:0 24px 64px rgba(0,0,0,.25)">
        <div style="padding:1.1rem 1.4rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-weight:700">ğŸ¥› Mark Delivery</div>
            <div style="font-size:.75rem;color:var(--text2)">${date}${entry ? ' Â· Editing' : ' Â· New'}</div>
          </div>
          <button onclick="document.getElementById('${modalId}').remove()" style="background:none;font-size:1.3rem;cursor:pointer;border:none;color:var(--text2)">Ã—</button>
        </div>
        <div style="padding:1.2rem 1.4rem">
          <div style="font-size:.75rem;font-weight:700;color:var(--text2);margin-bottom:.5rem">MILK DELIVERED</div>
          <div id="milkItemsList">${existingItems.map(i=>renderItemRow(i)).join('')}</div>
          <button class="btn btn-gray" style="font-size:.78rem;margin-top:.3rem"
            onclick="
              const row = document.createElement('div');
              row.className = 'milk-item-row';
              row.style.cssText = 'display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem';
              row.innerHTML = '<div style=\'flex:1.5;position:relative\'><input list=\'deliveryItemsList\' placeholder=\'Product name\' value=\'Full Cream\' oninput=\'updateDeliveryTotal()\' style=\'width:100%;border:1.5px solid var(--border);border-radius:8px;padding:.35rem .5rem;font-size:.83rem;font-family:inherit;box-sizing:border-box\'></div><input type=\'number\' placeholder=\'Qty\' value=\'0.5\' min=\'0\' max=\'20\' step=\'0.25\' onchange=\'updateDeliveryTotal()\' style=\'width:68px;border:1.5px solid var(--border);border-radius:8px;padding:.35rem .4rem;font-size:.83rem\'><span style=\'font-size:.75rem;color:var(--text2)\'>L@â‚¹</span><input type=\'number\' placeholder=\'â‚¹/L\' value=\'' + milkPrice + '\' min=\'1\' step=\'0.5\' onchange=\'updateDeliveryTotal()\' style=\'width:65px;border:1.5px solid var(--border);border-radius:8px;padding:.35rem .4rem;font-size:.83rem\'><button onclick=\'this.closest(&quot;.milk-item-row&quot;).remove();updateDeliveryTotal()\' style=\'background:none;border:none;color:var(--red);font-size:1.1rem;cursor:pointer;padding:0;flex-shrink:0\'>Ã—</button>';
              document.getElementById('milkItemsList').appendChild(row);
              updateDeliveryTotal();">
            + Add Type
          </button>
          <div style="background:var(--bg);border-radius:8px;padding:.6rem 1rem;margin-top:.8rem;display:flex;justify-content:space-between;align-items:center">
            <span style="font-size:.82rem;color:var(--text2)">Total for this delivery</span>
            <span id="deliveryTotal" style="font-weight:700;color:var(--green);font-size:1rem">â‚¹0</span>
          </div>
          <div style="display:flex;gap:.6rem;margin-top:1rem">
            <button class="btn btn-green" style="flex:1" onclick="saveMultiMilkEntry(${customerId},'${date}')">Save Delivery</button>
            <button class="btn btn-gray" onclick="document.getElementById('${modalId}').remove()">Cancel</button>
          </div>
        </div>
      </div>
    </div>`);
  updateDeliveryTotal();
}

function updateDeliveryTotal() {
  let total = 0;
  document.querySelectorAll('#milkItemsList .milk-item-row').forEach(row => {
    const inputs = row.querySelectorAll('input[type=number]');
    total += (parseFloat(inputs[0]?.value)||0) * (parseFloat(inputs[1]?.value)||0);
  });
  const el = document.getElementById('deliveryTotal');
  if (el) el.textContent = '\u20b9' + total.toFixed(0);
}

async function saveMultiMilkEntry(customerId, date) {
  const rows = document.querySelectorAll('#milkItemsList .milk-item-row');
  const items = [];
  rows.forEach(row => {
    const inputs = row.querySelectorAll('input[type=number]');
    const nameInp = row.querySelector('input[list]');
    const qty = parseFloat(inputs[0]?.value) || 0;
    const price = parseFloat(inputs[1]?.value) || milkPrice;
    const type = (nameInp?.value || 'Full Cream').trim();
    if (qty > 0) items.push({type, qty, price});
  });
  if (!items.length) return toast('Enter at least one milk item');
  const totalQty = items.reduce((s,i)=>s+i.qty,0);
  await fetch('/api/admin/milk/logs',{method:'POST',headers:ah(),body:JSON.stringify({customerId,date,qty:totalQty,items})});
  document.getElementById('multiMilkModal')?.remove();
  await loadMilkData();
  if (window._multiMilkProfileCustomerId === customerId) {
    window._multiMilkProfileCustomerId = null;
    await refreshProfile(customerId);
  }
  const dlModal = document.getElementById('dlModal');
  if (dlModal) { dlModal.remove(); openDayLog(customerId); }
  else if (!_profileData || window._profilePage !== 'milk') { renderMilkPage(); }
  toast('Delivery saved!');
}

async function saveLogEntry(customerId, date, qty) {
  // Only used for deleting (qty=0) now
  await fetch('/api/admin/milk/logs',{method:'POST',headers:ah(),body:JSON.stringify({customerId,date,qty:0,price:milkPrice})});
  await loadMilkData();
  const dlModal = document.getElementById('dlModal');
  if (dlModal) { dlModal.remove(); openDayLog(customerId); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRODUCTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _editVariants = [];

function stockBadge(p) {
  if (p.stockQuantity === null || p.stockQuantity === undefined) return '<span class="badge badge-blue">Not Tracked</span>';
  if (p.stockQuantity === 0) return `<span class="stock-out">ğŸš« Out of Stock</span>`;
  if (p.isLowStock) return `<span class="stock-low">âš ï¸ Low (${p.stockQuantity})</span>`;
  return `<span class="stock-in">âœ“ ${p.stockQuantity} in stock</span>`;
}

let productSearch = '';
let _productSearchTimer = null;

async function searchProductsAndRender() {
  const q = productSearch.trim();
  if (!q) {
    renderProducts(); return;
  }
  // Use the scanner search endpoint which searches name, SKU, barcode, brand
  try {
    const r = await fetch('/api/admin/products/search?q='+encodeURIComponent(q)+'&limit=100',{headers:ah()});
    const results = r.ok ? await r.json() : [];
    _renderProductTable(results, q);
  } catch {
    // Fallback to client-side
    const filtered = allProducts.filter(p => {
      const s = q.toLowerCase();
      return p.name?.toLowerCase().includes(s) || p.sku?.toLowerCase().includes(s) ||
             p.barcode?.includes(s) || p.brand?.toLowerCase().includes(s);
    });
    _renderProductTable(filtered, q);
  }
}

function renderProducts() {
  _renderProductTable(allProducts, '');
}

function _renderProductTable(products, searchTerm) {
  document.getElementById('content').innerHTML = `
    <div class="card">
      <div class="card-header">
        <h2>Products (${products.length}${searchTerm?' found':''}${!searchTerm?' total':''})</h2>
        <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
          <input class="search-input" placeholder="Search name, SKU, barcode, brand..." value="${productSearch}" oninput="productSearch=this.value;clearTimeout(_productSearchTimer);_productSearchTimer=setTimeout(searchProductsAndRender,300)">
          <button class="btn btn-purple" onclick="goTo('scanner')">ğŸ“· Scan</button>
          <button class="btn btn-green" onclick="openProductModal()">+ Add Product</button>
        </div>
      </div>
      ${products.length===0?`<div class="empty-state"><div class="ei">ğŸ›ï¸</div><p>${searchTerm?'No products match "'+searchTerm+'"':'No products yet.'}</p></div>`:`
      <table>
        <thead><tr><th>Image</th><th>Name / SKU</th><th>Category</th><th>Variants</th><th>Price Range</th><th>Stock Status</th><th>Actions</th></tr></thead>
        <tbody>${products.map(p=>{
          const cat = allCategories.find(c=>c.id===p.catId);
          const variants = p.variants||[];
          const allPrices = variants.flatMap(v=>(v.priceTiers||[]).map(t=>t.price));
          const minP = allPrices.length?Math.min(...allPrices):0;
          const maxP = allPrices.length?Math.max(...allPrices):0;
          const imgUrl = variants[0]?.imageUrl||p.imageUrl||'';
          return `<tr style="${p.disabled?'opacity:.5':''}">
            <td>${imgUrl?`<img class="td-img" src="${imgUrl}">`:`<div class="td-img-ph">ğŸ“¦</div>`}</td>
            <td>
              <div style="font-weight:600">${p.name}${p.disabled?' <span class="badge badge-red" style="font-size:.65rem">Disabled</span>':''}</div>
              ${p.sku?`<div style="font-size:.72rem;color:var(--text2)">SKU: ${p.sku}</div>`:''}
              ${p.barcode?`<div style="font-size:.72rem;color:var(--text3);font-family:monospace">${p.barcode}</div>`:''}
            </td>
            <td>${cat?cat.name:'<span style="color:var(--text3)">â€”</span>'}</td>
            <td><div style="display:flex;flex-wrap:wrap;gap:3px">${variants.length===0?'<span style="color:var(--text3)">â€”</span>':variants.map(v=>`<span class="badge badge-blue">${v.label||'â€”'}</span>`).join('')}</div></td>
            <td style="font-weight:700">${minP===maxP?`â‚¹${minP}`:`â‚¹${minP}â€“${maxP}`}</td>
            <td>${stockBadge(p)}</td>
            <td><div class="actions">
              <button class="btn btn-blue" onclick="editProduct(${p.id})">Edit</button>
              <button class="btn btn-green" onclick="quickStockUpdate(${p.id})" title="Quick stock update">ğŸ“¦</button>
              <button class="btn btn-red" onclick="deleteProduct(${p.id})">Del</button>
            </div></td>
          </tr>`;
        }).join('')}</tbody>
      </table>`}
    </div>`;
}

function editProduct(id) { openProductModal(id); }

function openProductModal(id) {
  const p = id ? allProducts.find(x=>x.id===id) : null;
  document.getElementById('productModalTitle').textContent = p ? 'Edit Product' : 'Add Product';
  document.getElementById('pEditId').value = p?.id||'';
  document.getElementById('pName').value = p?.name||'';
  document.getElementById('pTag').value = p?.featured?'featured':p?.isNew?'new':'';
  document.getElementById('pBrand').value = p?.brand||'';
  document.getElementById('pKeywords').value = Array.isArray(p?.keywords) ? p.keywords.join(', ') : (p?.keywords||'');
  document.getElementById('pSku').value = p?.sku||'';
  document.getElementById('pBarcode').value = p?.barcode||'';
  document.getElementById('pMrp').value = p?.mrp||'';
  document.getElementById('pStock').value = p?.stockQuantity !== null && p?.stockQuantity !== undefined ? p.stockQuantity : '';
  document.getElementById('pLowStock').value = p?.lowStockThreshold !== undefined ? p.lowStockThreshold : 5;
  document.getElementById('pDisabled').checked = p?.disabled||false;
  const imgUrl = p?.imageUrl||'';
  document.getElementById('pImgUrl').value = imgUrl;
  previewUrlImg('pImgPreview', imgUrl);
  document.getElementById('pCat').innerHTML = `<option value="0">No Category</option>`+allCategories.map(c=>`<option value="${c.id}" ${c.id===p?.catId?'selected':''}>${c.name}</option>`).join('');
  updateSubcatDropdown(p?.subCatId||null);
  _editVariants = p?.variants ? JSON.parse(JSON.stringify(p.variants)) : [{ id:'v1', label:'1 unit', imageUrl:'', mrp:null, inStock:true, priceTiers:[{minQty:1,price:0}] }];
  renderVariantEditor();
  document.getElementById('productModal').classList.add('open');
}

function updateSubcatDropdown(selectedSubCatId) {
  const catId = parseInt(document.getElementById('pCat').value) || 0;
  const subcats = allSubcategories.filter(sc => sc.catId === catId);
  const sel = selectedSubCatId !== undefined ? selectedSubCatId : (parseInt(document.getElementById('pSubCat').value) || null);
  document.getElementById('pSubCat').innerHTML = `<option value="">â€” None â€”</option>` +
    subcats.map(sc => `<option value="${sc.id}" ${sc.id === sel ? 'selected' : ''}>${sc.name}</option>`).join('');
}

function renderVariantEditor() {
  const el = document.getElementById('variantEditor');
  if (!el) return;
  el.innerHTML = _editVariants.map((v,i) => `
    <div style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <span style="font-size:.8rem;font-weight:700;color:var(--text2)">VARIANT ${i+1}</span>
        ${_editVariants.length>1?`<button class="btn btn-red" style="padding:.3rem .6rem;font-size:.72rem" onclick="removeVariant(${i})">Remove</button>`:''}
      </div>
      <div class="form-row">
        <div class="form-group"><label>Label (e.g. 500g, 1L)</label><input type="text" value="${v.label||''}" oninput="_editVariants[${i}].label=this.value" placeholder="e.g. 500g"></div>
        <div class="form-group"><label>MRP (â‚¹) â€” optional</label><input type="number" value="${v.mrp||''}" oninput="_editVariants[${i}].mrp=parseFloat(this.value)||null" min="0" placeholder="e.g. 50"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Image URL</label><input type="text" value="${v.imageUrl||''}" oninput="_editVariants[${i}].imageUrl=this.value" placeholder="Leave blank to use product image"></div>
        <div class="form-group"><label>Stock</label><select oninput="_editVariants[${i}].inStock=this.value==='true'">
          <option value="true" ${v.inStock!==false?'selected':''}>In Stock</option>
          <option value="false" ${v.inStock===false?'selected':''}>Out of Stock</option>
        </select></div>
      </div>
      <div class="form-group">
        <label>Bulk Pricing Tiers</label>
        <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:.5rem;padding:0 .6rem;margin-bottom:.2rem">
          <span style="font-size:.7rem;font-weight:600;color:var(--text3);text-transform:uppercase">Min Qty</span>
          <span style="font-size:.7rem;font-weight:600;color:var(--text3);text-transform:uppercase">Price (â‚¹)</span>
          <span></span>
        </div>
        <div class="tiers-list">
          ${(v.priceTiers||[]).map((t,ti) => `
            <div class="tier-row">
              <input type="number" min="1" value="${t.minQty}" oninput="updateTier(${i},${ti},'minQty',parseInt(this.value))">
              <input type="number" min="0" step="0.5" value="${t.price}" oninput="updateTier(${i},${ti},'price',parseFloat(this.value))">
              <button class="tier-del" onclick="removeTier(${i},${ti})">âœ•</button>
            </div>`).join('')}
        </div>
        <button class="btn btn-gray" style="font-size:.75rem;padding:.35rem .7rem;margin-top:4px" onclick="addTierToVariant(${i})">+ Add Tier</button>
      </div>
    </div>`).join('');
}

function updateTier(vi,ti,field,val){if(_editVariants[vi]?.priceTiers?.[ti])_editVariants[vi].priceTiers[ti][field]=val;}
function removeTier(vi,ti){if(_editVariants[vi]?.priceTiers){_editVariants[vi].priceTiers.splice(ti,1);renderVariantEditor();}}
function addTierToVariant(vi){if(!_editVariants[vi].priceTiers)_editVariants[vi].priceTiers=[];_editVariants[vi].priceTiers.push({minQty:1,price:0});renderVariantEditor();}
function removeVariant(i){_editVariants.splice(i,1);renderVariantEditor();}
function addVariant(){_editVariants.push({id:'v'+(_editVariants.length+1),label:'',imageUrl:'',mrp:null,inStock:true,priceTiers:[{minQty:1,price:0}]});renderVariantEditor();}

async function saveProduct() {
  const id = document.getElementById('pEditId').value;
  const name = document.getElementById('pName').value.trim();
  if (!name) return toast('Product name required');
  if (!_editVariants.length) return toast('At least one variant required');
  for (const v of _editVariants) {
    if (!v.label?.trim()) return toast('Each variant needs a label');
    if (!v.priceTiers?.length) return toast(`Variant "${v.label}" needs price tiers`);
    if ([...v.priceTiers].sort((a,b)=>a.minQty-b.minQty)[0].minQty !== 1) return toast(`Variant "${v.label}" first tier must start at qty 1`);
  }
  const tag = document.getElementById('pTag').value;
  const subCatId = parseInt(document.getElementById('pSubCat').value) || null;
  const brand = document.getElementById('pBrand').value.trim();
  const keywords = document.getElementById('pKeywords').value.split(',').map(k=>k.trim()).filter(Boolean);
  const stockVal = document.getElementById('pStock').value;
  const body = {
    name, catId:parseInt(document.getElementById('pCat').value)||0, subCatId,
    imageUrl:document.getElementById('pImgUrl').value, brand, keywords,
    featured:tag==='featured', isNew:tag==='new',
    sku: document.getElementById('pSku').value.trim(),
    barcode: document.getElementById('pBarcode').value.trim(),
    mrp: document.getElementById('pMrp').value ? parseFloat(document.getElementById('pMrp').value) : null,
    stockQuantity: stockVal !== '' ? parseInt(stockVal) : null,
    lowStockThreshold: parseInt(document.getElementById('pLowStock').value) || 5,
    disabled: document.getElementById('pDisabled').checked,
    variants:_editVariants.map((v,i)=>({...v,id:v.id||('v'+(i+1)),priceTiers:[...v.priceTiers].sort((a,b)=>a.minQty-b.minQty)}))
  };
  const r = await fetch(id?`/api/admin/products/${id}`:'/api/admin/products',{method:id?'PUT':'POST',headers:ah(),body:JSON.stringify(body)});
  if (!r.ok) { const err=await r.json(); return toast(err.error||'Save failed'); }
  await loadAll(true); closeModal('productModal'); renderProducts();
  toast(id?'Product updated!':'Product added!');
}

async function deleteProduct(id) {
  if (!confirm('Delete this product?')) return;
  await fetch(`/api/admin/products/${id}`,{method:'DELETE',headers:ah()});
  await loadAll(true); renderProducts(); toast('Product deleted');
}

async function quickStockUpdate(id) {
  const p = allProducts.find(x=>x.id===id);
  if (!p) return;
  const current = typeof p.stockQuantity === 'number' ? p.stockQuantity : '';
  miniModal({
    title: `ğŸ“¦ Update Stock â€” ${p.name}`,
    fields: [
      { id: 'qty', label: 'New Quantity', type: 'number', value: current, placeholder: 'Enter stock count', min: 0,
        hint: current !== '' ? `Current: ${current} units` : 'Currently: Not tracked' },
    ],
    confirmLabel: 'Update Stock', confirmClass: 'btn-green',
    onConfirm: async ({ qty }) => {
      const q = parseInt(qty);
      if (isNaN(q) || q < 0) return toast('Invalid quantity');
      const r = await fetch(`/api/admin/products/${id}/stock`, {method:'PATCH', headers:ah(), body:JSON.stringify({stockQuantity:q})});
      if (r.ok) { await loadAll(true); if(currentPage==='products') renderProducts(); toast('Stock updated!'); }
      else { const e=await r.json(); toast(e.error||'Failed to update'); }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BARCODE SCANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let scanHistory = [];
let scanDebounceTimer = null;

function renderScanner() {
  document.getElementById('content').innerHTML = `
    <div class="scan-wrapper">
      <div class="scan-card">
        <div class="scan-title">ğŸ“· Barcode Scanner</div>
        <div class="scan-subtitle">Focus on the input below, then scan a product. USB barcode scanners work automatically â€” just scan!</div>
        <div class="scan-input-wrap">
          <input type="text" id="scanInput" class="scan-input" placeholder="Scan barcode or type SKU / name..." autocomplete="off" autocorrect="off" spellcheck="false"
            onkeydown="handleScanKey(event)" oninput="handleScanInput(event)">
          <span class="scan-icon">âŒ¨ï¸</span>
        </div>
        <div id="scanResult" style="display:none"></div>
        <div style="display:flex;gap:.6rem;margin-top:.8rem;flex-wrap:wrap">
          <button class="btn btn-gray" onclick="clearScan()">Clear</button>
          <button class="btn btn-green" onclick="doScanSearch()">ğŸ” Search</button>
          <span style="font-size:.78rem;color:var(--text2);align-self:center">Press Enter to search</span>
        </div>
      </div>
      <div class="scan-history" id="scanHistoryPanel" style="${scanHistory.length?'':'display:none'}">
        <div class="scan-history-head">Recent Scans</div>
        <div id="scanHistoryList"></div>
      </div>
    </div>`;
  // Auto-focus the input
  setTimeout(() => {
    const inp = document.getElementById('scanInput');
    if (inp) inp.focus();
  }, 80);
  renderScanHistory();
}

function handleScanKey(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    doScanSearch();
  }
}

// USB scanner types fast â€” debounce for manual typing
function handleScanInput(e) {
  clearTimeout(scanDebounceTimer);
  // If input has 8+ digits (typical barcode), auto-search after short delay
  const val = e.target.value.trim();
  if (/^\d{8,}$/.test(val)) {
    scanDebounceTimer = setTimeout(doScanSearch, 400);
  }
}

async function doScanSearch() {
  const inp = document.getElementById('scanInput');
  if (!inp) return;
  const q = inp.value.trim();
  if (!q) return;
  inp.classList.add('scanning');
  setTimeout(() => inp.classList.remove('scanning'), 600);

  showScanResult('loading', 'ğŸ” Searching...', '');
  try {
    const r = await fetch(`/api/admin/products/search?q=${encodeURIComponent(q)}`, {headers:ah()});
    const data = await r.json();
    if (data.results && data.results.length > 0) {
      const p = data.results[0];
      const matchType = data.matchType || 'name';
      addToScanHistory(q, p);
      showScanResultProduct(p, matchType, data.results.length > 1 ? data.results.slice(1, 5) : []);
    } else {
      showScanResult('not-found', 'âŒ Product Not Found', `No product matched: "${q}"`);
    }
  } catch(e) {
    showScanResult('not-found', 'âš ï¸ Error', 'Could not connect to server.');
  }
}

function showScanResult(type, title, msg) {
  const el = document.getElementById('scanResult');
  if (!el) return;
  el.style.display = 'block';
  el.className = 'scan-result ' + type;
  el.innerHTML = `<div class="scan-status">${title}</div><div style="font-size:.85rem;color:var(--text2)">${msg}</div>`;
}

function showScanResultProduct(p, matchType, others) {
  const el = document.getElementById('scanResult');
  if (!el) return;
  const imgUrl = p.variants?.[0]?.imageUrl || p.imageUrl || '';
  const cat = allCategories.find(c=>c.id===p.catId);
  const prices = (p.variants||[]).flatMap(v=>(v.priceTiers||[]).map(t=>t.price));
  const minP = prices.length ? Math.min(...prices) : 0;
  el.style.display = 'block';
  el.className = 'scan-result found';
  el.innerHTML = `
    <div class="scan-status">âœ… Product Found (${matchType === 'barcode' ? 'ğŸ”¢ Barcode' : matchType === 'sku' ? 'ğŸ·ï¸ SKU' : 'ğŸ“ Name'})</div>
    <div class="prod-view-header" style="margin-top:.6rem;margin-bottom:.4rem">
      ${imgUrl?`<img src="${imgUrl}" class="prod-view-img" onerror="this.style.display='none'">`:`<div class="prod-view-img-ph">ğŸ“¦</div>`}
      <div class="prod-view-info">
        <div class="prod-view-name">${p.name}</div>
        <div class="prod-view-meta">${cat?cat.name:''}${p.brand?' Â· '+p.brand:''}${p.sku?' Â· SKU: '+p.sku:''}${p.barcode?' Â· '+p.barcode:''}</div>
        <div class="prod-view-tags" style="margin-top:.5rem">
          ${stockBadge(p)}
          ${p.mrp?`<span class="badge badge-purple">MRP â‚¹${p.mrp}</span>`:''}
          <span class="badge badge-blue">â‚¹${minP}</span>
        </div>
        ${p.stockQuantity !== null && p.stockQuantity !== undefined ? `
        <div style="margin-top:.6rem;display:flex;align-items:center;gap:.5rem">
          <span style="font-size:.78rem;color:var(--text2)">Stock:</span>
          <input type="number" id="scanStockInput" class="quick-stock-input" value="${p.stockQuantity}" min="0">
          <button class="btn btn-green" style="font-size:.75rem;padding:.3rem .7rem" onclick="updateStockFromScan(${p.id})">Update Stock</button>
        </div>` : ''}
      </div>
    </div>
    <div style="display:flex;gap:.6rem;flex-wrap:wrap;margin-top:.6rem">
      <button class="btn btn-blue" onclick="goTo('products');setTimeout(()=>editProduct(${p.id}),150)">âœï¸ Edit Product</button>
      <button class="btn btn-gray" onclick="document.getElementById('scanInput').value='';document.getElementById('scanInput').focus()">ğŸ”„ Scan Next</button>
    </div>
    ${others.length ? `<div style="margin-top:.6rem;font-size:.8rem;color:var(--text2)">${others.length} more result${others.length>1?'s':''}: ${others.map(x=>x.name).join(', ')}</div>` : ''}`;
}

async function updateStockFromScan(productId) {
  const inp = document.getElementById('scanStockInput');
  if (!inp) return;
  const qty = parseInt(inp.value);
  if (isNaN(qty) || qty < 0) return toast('Invalid quantity');
  const r = await fetch(`/api/admin/products/${productId}/stock`, {method:'PATCH', headers:ah(), body:JSON.stringify({stockQuantity:qty})});
  if (r.ok) {
    await loadAll(true);
    toast('âœ… Stock updated!');
    const updated = allProducts.find(x=>x.id===productId);
    if (updated) {
      // Refresh the product info in scan result
      const scanInput = document.getElementById('scanInput');
      if (scanInput) doScanSearch();
    }
  } else toast('Failed to update stock');
}

function clearScan() {
  const inp = document.getElementById('scanInput');
  if (inp) { inp.value = ''; inp.focus(); }
  const el = document.getElementById('scanResult');
  if (el) el.style.display = 'none';
}

function addToScanHistory(barcode, product) {
  scanHistory.unshift({ barcode, name: product.name, id: product.id, time: new Date().toLocaleTimeString() });
  if (scanHistory.length > 10) scanHistory.pop();
  renderScanHistory();
}

function renderScanHistory() {
  const panel = document.getElementById('scanHistoryPanel');
  const list = document.getElementById('scanHistoryList');
  if (!panel || !list) return;
  if (!scanHistory.length) { panel.style.display='none'; return; }
  panel.style.display = 'block';
  list.innerHTML = scanHistory.map(h=>`
    <div class="scan-history-item" onclick="goTo('products');setTimeout(()=>editProduct(${h.id}),150)">
      <span class="shi-barcode">${h.barcode}</span>
      <span class="shi-name">${h.name}</span>
      <span class="shi-time">${h.time}</span>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CATEGORIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCategories() {
  document.getElementById('content').innerHTML=`
    <div class="card">
      <div class="card-header"><h2>Categories (${allCategories.length})</h2><button class="btn btn-green" onclick="openCatModal()">+ Add Category</button></div>
      ${allCategories.length===0?`<div class="empty-state"><div class="ei">ğŸ“‚</div><p>No categories yet.</p></div>`:`
      <table>
        <thead><tr><th>Image</th><th>Name</th><th>Products</th><th>Actions</th></tr></thead>
        <tbody>${allCategories.map(c=>{
          const count = allProducts.filter(p=>p.catId===c.id).length;
          return `<tr>
            <td>${c.imageUrl?`<img class="td-img" src="${c.imageUrl}">`:`<div class="td-img-ph">ğŸ“‚</div>`}</td>
            <td style="font-weight:600">${c.name}</td>
            <td><span class="badge badge-blue">${count} product${count!==1?'s':''}</span></td>
            <td><div class="actions">
              <button class="btn btn-blue" onclick="openCatModal(${c.id})">Edit</button>
              <button class="btn btn-red" onclick="deleteCat(${c.id})">Delete</button>
            </div></td>
          </tr>`;
        }).join('')}</tbody>
      </table>`}
    </div>`;
}

function openCatModal(id) {
  const c = id?allCategories.find(x=>x.id===id):null;
  document.getElementById('catModalTitle').textContent = c?'Edit Category':'Add Category';
  document.getElementById('cEditId').value = c?.id||'';
  document.getElementById('cName').value = c?.name||'';
  const imgUrl = c?.imageUrl||'';
  document.getElementById('cImgUrl').value = imgUrl;
  previewUrlImg('cImgPreview', imgUrl);
  document.getElementById('categoryModal').classList.add('open');
}

async function saveCat() {
  const id = document.getElementById('cEditId').value;
  if (!document.getElementById('cName').value.trim()) return toast('Category name required');
  const body = {name:document.getElementById('cName').value.trim(),imageUrl:document.getElementById('cImgUrl').value};
  await fetch(id?`/api/admin/categories/${id}`:'/api/admin/categories',{method:id?'PUT':'POST',headers:ah(),body:JSON.stringify(body)});
  await loadAll(true); closeModal('categoryModal'); renderCategories();
  toast(id?'Category updated!':'Category added!');
}

async function deleteCat(id) {
  const count = allProducts.filter(p=>p.catId===id).length;
  if (count>0&&!confirm(`Has ${count} product(s). Delete anyway?`)) return;
  await fetch(`/api/admin/categories/${id}`,{method:'DELETE',headers:ah()});
  await loadAll(true); renderCategories(); toast('Category deleted');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BANNERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBanners() {
  document.getElementById('content').innerHTML=`
    <div class="card">
      <div class="card-header"><h2>Banners (${allBanners.length})</h2><button class="btn btn-green" onclick="openBannerModal()">+ Add Banner</button></div>
      ${allBanners.length===0?`<div class="empty-state"><div class="ei">ğŸ–¼ï¸</div><p>No banners yet.</p></div>`:`
      <table>
        <thead><tr><th>Image</th><th>Title</th><th>Opens</th><th>Actions</th></tr></thead>
        <tbody>${allBanners.map(b=>{
          let action='Nothing';
          if(b.action?.type==='category'){const cat=allCategories.find(c=>c.id===b.action.catId);action='Category: '+(cat?.name||'?');}
          else if(b.action?.type==='products') action=`${b.action.productIds?.length||0} products`;
          return `<tr>
            <td>${b.imageUrl?`<img class="td-img" src="${b.imageUrl}" style="width:80px;height:44px;object-fit:cover;border-radius:6px">`:`<div style="width:80px;height:44px;border-radius:6px;background:${b.bgColor||'#1a1a2e'}"></div>`}</td>
            <td><div style="font-weight:600">${b.title||'â€”'}</div><div style="font-size:.75rem;color:var(--text2)">${b.subtitle||''}</div></td>
            <td><span class="badge badge-blue">${action}</span></td>
            <td><div class="actions">
              <button class="btn btn-blue" onclick="openBannerModal(${b.id})">Edit</button>
              <button class="btn btn-red" onclick="deleteBanner(${b.id})">Delete</button>
            </div></td>
          </tr>`;
        }).join('')}</tbody>
      </table>`}
    </div>`;
}

function openBannerModal(id) {
  const b = id?allBanners.find(x=>x.id===id):null;
  document.getElementById('bannerModalTitle').textContent = b?'Edit Banner':'Add Banner';
  document.getElementById('bEditId').value = b?.id||'';
  document.getElementById('bTitle').value = b?.title||'';
  document.getElementById('bSub').value = b?.subtitle||'';
  document.getElementById('bBgColor').value = b?.bgColor||'#1a1a2e';
  document.getElementById('bImgUrl').value = b?.imageUrl||'';
  document.getElementById('bActionType').value = b?.action?.type||'';
  previewUrlImg('bImgPreview', b?.imageUrl||'');
  document.getElementById('bCatId').innerHTML = allCategories.map(c=>`<option value="${c.id}" ${b?.action?.catId===c.id?'selected':''}>${c.name}</option>`).join('');
  onBannerActionChange();
  if (b?.action?.type==='products') {
    setTimeout(()=>{
      (b.action.productIds||[]).forEach(pid=>{const cb=document.querySelector(`#bProdList input[value="${pid}"]`);if(cb)cb.checked=true;});
      updatePickCount();
    },50);
  }
  document.getElementById('bannerModal').classList.add('open');
}

function onBannerActionChange() {
  const type = document.getElementById('bActionType').value;
  document.getElementById('bActionPicker').style.display = type?'block':'none';
  document.getElementById('bCatPicker').style.display = type==='category'?'block':'none';
  document.getElementById('bProdPicker').style.display = type==='products'?'block':'none';
  if (type==='products') renderBannerProdList('');
}

function renderBannerProdList(filter) {
  document.getElementById('bProdList').innerHTML = allProducts.filter(p=>!filter||p.name.toLowerCase().includes(filter.toLowerCase())).map(p=>`<div class="pick-item"><input type="checkbox" value="${p.id}" onchange="updatePickCount()"><span class="pname">${p.name}</span><span class="pprice">â‚¹${p.priceTiers?.[0]?.price??0}</span></div>`).join('');
}

function filterBannerProds(q){renderBannerProdList(q);}
function updatePickCount(){document.getElementById('bPickCount').textContent=document.querySelectorAll('#bProdList input:checked').length;}

async function saveBanner() {
  const id = document.getElementById('bEditId').value;
  const actionType = document.getElementById('bActionType').value;
  let action = null;
  if (actionType==='category') action = {type:'category',catId:parseInt(document.getElementById('bCatId').value)};
  else if (actionType==='products') {
    const picks = [...document.querySelectorAll('#bProdList input:checked')].map(c=>parseInt(c.value));
    if (!picks.length) return toast('Select at least one product');
    action = {type:'products',productIds:picks};
  }
  const body = {imageUrl:document.getElementById('bImgUrl').value,title:document.getElementById('bTitle').value.trim(),subtitle:document.getElementById('bSub').value.trim(),bgColor:document.getElementById('bBgColor').value,action};
  await fetch(id?`/api/admin/banners/${id}`:'/api/admin/banners',{method:id?'PUT':'POST',headers:ah(),body:JSON.stringify(body)});
  await loadAll(true); closeModal('bannerModal'); renderBanners();
  toast(id?'Banner updated!':'Banner added!');
}

async function deleteBanner(id) {
  if (!confirm('Delete this banner?')) return;
  await fetch(`/api/admin/banners/${id}`,{method:'DELETE',headers:ah()});
  await loadAll(true); renderBanners(); toast('Banner deleted');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderSettings() {
  const [sr, pr] = await Promise.all([
    fetch('/api/admin/settings',{headers:ah()}),
    fetch('/api/admin/products',{headers:ah()})
  ]);
  const s = await sr.json();
  const allProds = await pr.json();
  const upsellIds = s.upsellProductIds || [];
  window._upsellIds = new Set(upsellIds.map(Number));

  const prodCheckboxes = allProds.length ? allProds.map(p => `
    <label style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--bg);border-radius:8px;border:1px solid var(--border);cursor:pointer;margin-bottom:6px">
      <input type="checkbox" value="${p.id}" ${upsellIds.map(Number).includes(p.id)?'checked':''} onchange="window._upsellIds[this.checked?'add':'delete'](Number(this.value))" style="width:15px;height:15px;accent-color:var(--green);flex-shrink:0">
      <span style="flex:1;font-size:.85rem;font-weight:600">${p.name}</span>
      <span style="font-size:.78rem;font-weight:700;color:var(--green)">â‚¹${p.priceTiers?.[0]?.price||0}</span>
    </label>`).join('')
    : '<div style="color:var(--text2);font-size:.85rem;padding:10px 0">No products yet.</div>';

  document.getElementById('content').innerHTML=`
    <div style="display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:1.2rem;max-width:1000px;align-items:start">
      <div style="display:flex;flex-direction:column;gap:1.2rem">
        <div class="card">
          <div class="card-header"><h2>âš™ï¸ Store Settings</h2></div>
          <div class="card-body">
            <div class="form-group"><label>Store Name</label><input type="text" id="sName" value="${s.storeName||''}"></div>
            <div class="form-group"><label>WhatsApp Number</label><input type="text" id="sWA" value="${s.whatsapp||''}" placeholder="e.g. 919876543210"><div class="form-hint">Country code, no + sign</div></div>
            <div class="form-group"><label>UPI ID</label><input type="text" id="sUPI" value="${s.upiId||''}" placeholder="e.g. yourname@okaxis"></div>
            <div class="form-group"><label>Minimum Order (â‚¹)</label><input type="number" id="sMin" value="${s.minOrder||99}" min="0"></div>
            <div class="form-group"><label>Free Delivery Threshold (â‚¹)</label><input type="number" id="sFD" value="${s.freeDeliveryMin||s.minOrder||99}" min="0"></div>
            <hr style="border:none;border-top:1px solid var(--border);margin:1rem 0">
            <div class="form-group"><label>New Admin Password</label><input type="password" id="sPass" placeholder="Leave blank to keep current"></div>
            <button class="btn btn-green" style="width:100%;justify-content:center;padding:.72rem" onclick="saveSettings()">ğŸ’¾ Save Settings</button>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><h2>ğŸ Offer / Free Gift</h2></div>
          <div class="card-body">
            <div class="form-group"><label>Cart Total Threshold (â‚¹)</label><input type="number" id="sGiftThreshold" value="${(s.freeGift&&s.freeGift.threshold)||0}" min="0" placeholder="0 = off"></div>
            <div class="form-group"><label>Offer Product</label>
              <select id="sGiftProductId" style="width:100%;border:1.5px solid var(--border);border-radius:9px;padding:.58rem .8rem;font-size:.88rem">
                <option value="">â€” No product â€”</option>
                ${allProds.map(p=>`<option value="${p.id}" ${s.freeGift?.productId==p.id?'selected':''}>${p.name} Â· â‚¹${p.priceTiers?.[0]?.price||0}</option>`).join('')}
              </select>
            </div>
            <div class="form-group"><label>Gift Label</label><input type="text" id="sGiftLabel" value="${(s.freeGift&&s.freeGift.label)||''}" placeholder="e.g. 1kg Potatoes ğŸ¥”"></div>
            <div class="form-group"><label>Quantity</label><input type="number" id="sGiftQty" value="${(s.freeGift&&s.freeGift.qty)||1}" min="1"></div>
            <div class="form-group"><label>Offer Price (â‚¹) â€” 0 = free</label><input type="number" id="sGiftPrice" value="${(s.freeGift&&s.freeGift.discountPrice!=null)?s.freeGift.discountPrice:0}" min="0"></div>
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px 12px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;margin-bottom:14px">
              <input type="checkbox" id="sGiftAutoAdd" ${s.freeGift?.autoAdd!==false?'checked':''} style="width:16px;height:16px;accent-color:var(--green)">
              <span style="font-size:.85rem;font-weight:600">Auto-add to cart</span>
            </label>
            <button class="btn btn-green" style="width:100%;justify-content:center" onclick="saveSettings()">ğŸ’¾ Save Gift Settings</button>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><h2>ğŸ”§ Migration Tools</h2></div>
          <div class="card-body">
            <p style="font-size:.85rem;color:var(--text2);margin-bottom:1rem">Migrate old udhar entries to the new unified ledger system.</p>
            <button class="btn btn-blue" onclick="runMigration()">Run Migration</button>
          </div>
        </div>
      </div>
      <div class="card" style="align-self:start">
        <div class="card-header"><h2>âš¡ Upsell Strip</h2></div>
        <div class="card-body">
          <div style="font-size:.8rem;color:var(--text2);margin-bottom:12px">Products shown as "You may also need" inside the cart.</div>
          <div id="upsellList" style="max-height:420px;overflow-y:auto">${prodCheckboxes}</div>
          <button class="btn btn-green" style="width:100%;justify-content:center;margin-top:12px" onclick="saveSettings()">ğŸ’¾ Save Upsell</button>
        </div>
      </div>
    </div>`;
}

async function saveSettings() {
  const body = {
    storeName:(document.getElementById('sName')?.value||'').trim(),
    whatsapp:(document.getElementById('sWA')?.value||'').trim(),
    upiId:(document.getElementById('sUPI')?.value||'').trim(),
    minOrder:parseInt(document.getElementById('sMin')?.value)||99,
    freeDeliveryMin:parseInt(document.getElementById('sFD')?.value)||0,
    freeGift:{
      threshold:parseInt(document.getElementById('sGiftThreshold')?.value)||0,
      productId:document.getElementById('sGiftProductId')?.value?parseInt(document.getElementById('sGiftProductId').value):null,
      qty:parseInt(document.getElementById('sGiftQty')?.value)||1,
      autoAdd:document.getElementById('sGiftAutoAdd')?.checked===true,
      label:(document.getElementById('sGiftLabel')?.value||'').trim(),
      discountPrice:parseFloat(document.getElementById('sGiftPrice')?.value)||0,
    },
    upsellProductIds:window._upsellIds?[...window._upsellIds]:[],
  };
  const pass = document.getElementById('sPass')?.value;
  if (pass) body.newPassword = pass;
  await fetch('/api/admin/settings',{method:'PUT',headers:ah(),body:JSON.stringify(body)});
  toast('âœ… Settings saved!');
}

async function runMigration() {
  if (!confirm('Migrate old udhar data to new ledger system? This is safe and does not delete anything.')) return;
  const r = await fetch('/api/admin/migrate-to-ledger',{method:'POST',headers:ah()});
  const d = await r.json();
  if (r.ok) toast(`âœ… Migrated: ${d.migratedCredits} credits + ${d.migratedPayments} payments`);
  else toast('Migration failed');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtDate(d) {
  if (!d) return 'â€”';
  try { return new Date(d+'T12:00:00').toLocaleDateString('default',{day:'numeric',month:'short'}); }
  catch { return d; }
}

function fmtDateTime(d) {
  if (!d) return 'â€”';
  try { return new Date(d).toLocaleString('en-IN',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}); }
  catch { return d; }
}

// â”€â”€ IMAGE URL PREVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function previewUrlImg(imgId, url) {
  const img = document.getElementById(imgId);
  if (!img) return;
  if (url && url.startsWith('http')) {
    img.src = url;
    img.style.display = 'block';
    img.onerror = () => { img.style.display = 'none'; };
  } else if (url && url.startsWith('/')) {
    img.src = url;
    img.style.display = 'block';
    img.onerror = () => { img.style.display = 'none'; };
  } else {
    img.style.display = 'none';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUBCATEGORIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSubcategories() {
  document.getElementById('content').innerHTML = `
    <div class="card">
      <div class="card-header">
        <h2>Subcategories (${allSubcategories.length})</h2>
        <button class="btn btn-green" onclick="openSubcatModal()">+ Add Subcategory</button>
      </div>
      ${allSubcategories.length === 0 ? `<div class="empty-state"><div class="ei">ğŸ—‚ï¸</div><p>No subcategories yet.<br>Add subcategories to organise products within a category.</p></div>` : `
      <table>
        <thead><tr><th>Image</th><th>Name</th><th>Parent Category</th><th>Products</th><th>Actions</th></tr></thead>
        <tbody>${allSubcategories.map(sc => {
          const parentCat = allCategories.find(c => c.id === sc.catId);
          const count = allProducts.filter(p => p.subCatId === sc.id).length;
          return `<tr>
            <td>${sc.imageUrl ? `<img class="td-img" src="${sc.imageUrl}">` : `<div class="td-img-ph">ğŸ—‚ï¸</div>`}</td>
            <td style="font-weight:600">${sc.name}</td>
            <td><span class="badge badge-purple">${parentCat?.name || 'â€”'}</span></td>
            <td><span class="badge badge-blue">${count} product${count !== 1 ? 's' : ''}</span></td>
            <td><div class="actions">
              <button class="btn btn-blue" onclick="openSubcatModal(${sc.id})">Edit</button>
              <button class="btn btn-red" onclick="deleteSubcat(${sc.id})">Delete</button>
            </div></td>
          </tr>`;
        }).join('')}</tbody>
      </table>`}
    </div>`;
}

function openSubcatModal(id) {
  const sc = id ? allSubcategories.find(x => x.id === id) : null;
  document.getElementById('scModalTitle').textContent = sc ? 'Edit Subcategory' : 'Add Subcategory';
  document.getElementById('scEditId').value = sc?.id || '';
  document.getElementById('scName').value = sc?.name || '';
  const imgUrl = sc?.imageUrl || '';
  document.getElementById('scImgUrl').value = imgUrl;
  previewUrlImg('scImgPreview', imgUrl);
  document.getElementById('scCatId').innerHTML = allCategories.map(c =>
    `<option value="${c.id}" ${c.id === sc?.catId ? 'selected' : ''}>${c.name}</option>`
  ).join('');
  document.getElementById('subcategoryModal').classList.add('open');
}

async function saveSubcat() {
  const id = document.getElementById('scEditId').value;
  const name = document.getElementById('scName').value.trim();
  if (!name) return toast('Subcategory name required');
  const catId = parseInt(document.getElementById('scCatId').value) || 0;
  if (!catId) return toast('Please select a parent category');
  const body = { name, catId, imageUrl: document.getElementById('scImgUrl').value.trim() };
  await fetch(id ? `/api/admin/subcategories/${id}` : '/api/admin/subcategories', { method: id ? 'PUT' : 'POST', headers: ah(), body: JSON.stringify(body) });
  await loadAll(true); closeModal('subcategoryModal'); renderSubcategories();
  toast(id ? 'Subcategory updated!' : 'Subcategory added!');
}

async function deleteSubcat(id) {
  const count = allProducts.filter(p => p.subCatId === id).length;
  if (count > 0 && !confirm(`${count} product(s) use this subcategory. Delete anyway?`)) return;
  await fetch(`/api/admin/subcategories/${id}`, { method: 'DELETE', headers: ah() });
  await loadAll(true); renderSubcategories(); toast('Subcategory deleted');
}

function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');});
});

let toastTimer;
function toast(msg) { const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove('show'),2800); }
</script>
</body>
</html>
