<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>BSC Store</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0d0d0d; --bg2:#161616; --bg3:#1e1e1e; --bg4:#272727; --bg5:#303030;
  --border:#2a2a2a; --border2:#333;
  --text:#ffffff; --text2:#a0a0a0; --text3:#555;
  --green:#2dd36f; --green2:#25b35c; --green-dim:rgba(45,211,111,.12);
  --red:#ff4757; --yellow:#f0c040; --blue:#3b82f6;
  --radius:14px; --radius-sm:10px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{touch-action:manipulation;}
html,body{height:100%;overflow-x:hidden;}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;max-width:480px;margin:0 auto;}
button{font-family:'Inter',sans-serif;cursor:pointer;border:none;background:none;}
input,select{font-family:'Inter',sans-serif;}
::-webkit-scrollbar{display:none;}
img{display:block;max-width:100%;}

/* â”€â”€ PAGE TRANSITIONS â”€â”€ */
.fpage,.acc-page{transform:translateX(100%);opacity:0;transition:transform .35s cubic-bezier(.22,.61,.36,1),opacity .25s;position:fixed;inset:0;z-index:200;background:var(--bg);display:flex;flex-direction:column;}
.fpage.open,.acc-page.open{transform:translateX(0);opacity:1;}

/* â”€â”€ PRESS FEEDBACK â”€â”€ */
button:active,.cat-card:active,.pcard:active{transform:scale(.96);filter:brightness(.85);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topbar{flex-shrink:0;background:var(--bg);padding:0 16px;padding-top:max(env(safe-area-inset-top),0px);position:sticky;top:0;z-index:90;border-bottom:1px solid var(--border);}
.top-row{display:flex;align-items:center;justify-content:space-between;overflow:hidden;transition:max-height .32s cubic-bezier(.4,0,.2,1),opacity .25s,margin .28s cubic-bezier(.4,0,.2,1);max-height:56px;opacity:1;margin-bottom:0;}
.top-row.hidden{max-height:0;opacity:0;}
.logo{font-size:1.2rem;font-weight:900;letter-spacing:-.5px;}
.logo span{color:var(--green);}
.icon-btn{width:38px;height:38px;border-radius:10px;background:var(--bg2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:1.1rem;cursor:pointer;position:relative;}
.cart-badge{position:absolute;top:-5px;right:-5px;background:var(--green);color:#000;font-size:.55rem;font-weight:900;min-width:17px;height:17px;border-radius:50%;display:none;align-items:center;justify-content:center;border:2px solid var(--bg);}

/* Search bar â€” always visible */
.search-wrap{padding:8px 0;margin-bottom:0;}
.search-bar{background:var(--bg2);border-radius:12px;display:flex;align-items:center;gap:8px;padding:9px 12px;border:1.5px solid var(--border);}
.search-bar:focus-within{border-color:var(--green);}
.search-bar input{flex:1;background:none;border:none;outline:none;font-size:13.5px;color:var(--text);}
.search-bar input::placeholder{color:var(--text3);}
.search-icon{color:var(--text3);font-size:.95rem;}
/* Animated placeholder shimmer */
@keyframes phFade{0%,100%{opacity:0;transform:translateY(4px)}10%,85%{opacity:1;transform:translateY(0)}}
.ph-anim{animation:phFade 3s ease forwards;}

.cat-tabs{display:flex;overflow-x:auto;gap:0;border-top:1px solid var(--border);}
.ctab{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:3px;padding:6px 14px 8px;cursor:pointer;border-bottom:2.5px solid transparent;transition:all .15s;}
.ctab.active{border-bottom-color:var(--green);}
.ctab .ti{width:28px;height:28px;border-radius:8px;overflow:hidden;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:.9rem;}
.ctab .ti img{width:100%;height:100%;object-fit:cover;}
.ctab .tn{font-size:10px;font-weight:600;color:var(--text2);white-space:nowrap;}
.ctab.active .tn{color:var(--text);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCROLL AREA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.scroll{flex:1;overflow-y:auto;overflow-x:hidden;padding-bottom:100px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BANNER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.banner-wrap{padding:14px 14px 0;}
.banner-slider{border-radius:16px;overflow:hidden;}
.banner-track{display:flex;transition:transform .4s cubic-bezier(.4,0,.2,1);}
.banner-slide{min-width:100%;height:140px;cursor:pointer;flex-shrink:0;position:relative;background:var(--bg2);}
.banner-slide img{width:100%;height:100%;object-fit:cover;}
.b-text{position:absolute;inset:0;background:linear-gradient(to right,rgba(0,0,0,.7) 0%,transparent 65%);display:flex;flex-direction:column;justify-content:center;padding:18px;}
.b-title{font-size:15px;font-weight:900;line-height:1.25;}
.b-sub{font-size:11px;color:rgba(255,255,255,.7);margin-top:3px;}
.bdots{display:flex;justify-content:center;gap:5px;margin-top:8px;}
.bdot{width:5px;height:5px;border-radius:50%;background:var(--bg4);transition:all .3s;cursor:pointer;}
.bdot.active{width:16px;border-radius:3px;background:#fff;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SECTION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sec{padding:18px 14px 0;}
.sec-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.sec-title{font-size:15px;font-weight:800;letter-spacing:-.3px;}
.see-all{font-size:11px;font-weight:700;color:var(--green);cursor:pointer;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CATEGORY GRID (Blinkit style) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}

/* Category color palettes */
.cat-card{border-radius:12px;overflow:hidden;cursor:pointer;transition:transform .15s; position:relative;}
.cat-card:active{transform:scale(.94);}
.cc-img{
  aspect-ratio:1;
  position:relative;
  overflow:hidden;
  padding:0;
}
.cc-img img{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  border-radius:0;
}
.cc-img::after{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(
    to top,
    rgba(0,0,0,0.85) 0%,
    rgba(0,0,0,0.45) 35%,
    rgba(0,0,0,0.15) 60%,
    transparent 85%
  );
  z-index:1;
}
.cc-emoji{font-size:2rem;line-height:1;}
.cc-name{
  position:absolute;
  bottom:10px;
  left:10px;
  right:10px;
  font-size:13px;
  font-weight:900;
  text-align:center;
  color:#fff;
  z-index:2;
  text-shadow:0 3px 10px rgba(0,0,0,.9);
  line-height:1.15;
}
  .cat-card:active .cc-img img{
  transform:scale(1.06);
  transition:transform .25s ease;
}
/* Soft colored backgrounds per category index */
.cc-bg-0{background:linear-gradient(145deg,#1a3a2a,#0d2018);}
.cc-bg-1{background:linear-gradient(145deg,#2a1a3a,#18102a);}
.cc-bg-2{background:linear-gradient(145deg,#3a2a1a,#241808);}
.cc-bg-3{background:linear-gradient(145deg,#1a2a3a,#0d1824);}
.cc-bg-4{background:linear-gradient(145deg,#3a1a2a,#240d18);}
.cc-bg-5{background:linear-gradient(145deg,#2a3a1a,#18240d);}
.cc-bg-6{background:linear-gradient(145deg,#1a3a3a,#0d2424);}
.cc-bg-7{background:linear-gradient(145deg,#3a3a1a,#242408);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PRODUCT STRIP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pstrip{display:flex;gap:10px;overflow-x:auto;padding-bottom:4px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PRODUCT CARD (Blinkit style) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pcard{flex-shrink:0;width:150px;background:var(--bg2);border-radius:14px;border:1px solid var(--border);overflow:visible;position:relative;}
.pc-img-wrap{height:120px;background:var(--bg3);border-radius:14px 14px 0 0;display:flex;align-items:center;justify-content:center;padding:10px;overflow:hidden;position:relative;}
.pc-img-wrap img{width:100%;height:100%;object-fit:contain;}
.pc-discount-badge{position:absolute;top:7px;left:7px;background:var(--green);color:#000;font-size:.6rem;font-weight:900;padding:2px 6px;border-radius:5px;letter-spacing:.02em;}
.pc-new-badge{position:absolute;top:7px;right:7px;background:#3b82f6;color:#fff;font-size:.6rem;font-weight:800;padding:2px 6px;border-radius:5px;}
.pc-body{padding:8px 10px 10px;display:flex;flex-direction:column;}
.pc-variant-label{font-size:10px;color:var(--text3);font-weight:600;margin-bottom:2px;}
.pc-name{font-size:12px;font-weight:700;line-height:1.3;margin-bottom:4px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;letter-spacing:-.2px;}
.pc-delivery{display:none;}
.pc-price-row{display:flex;align-items:baseline;gap:4px;flex-wrap:wrap;margin-bottom:2px;}
.pc-price{font-size:14px;font-weight:900;letter-spacing:-.4px;}
.pc-mrp{font-size:10px;color:var(--text3);text-decoration:line-through;}
.pc-off{font-size:9px;background:rgba(255,71,87,.15);color:var(--red);border-radius:4px;padding:1px 5px;font-weight:800;}
.pc-bulk-hint{font-size:9px;color:var(--green);font-weight:600;margin-bottom:5px;}
.pc-bot{margin-top:6px;}
/* ADD button â€” full width */
.add-btn{width:100%;background:none;border:1.5px solid var(--green);color:var(--green);border-radius:9px;padding:7px 0;font-size:12px;font-weight:900;letter-spacing:.04em;transition:background .15s,color .15s,transform .1s;display:block;text-align:center;}
.add-btn:active{background:var(--green);color:#000;transform:scale(.97);}
/* Qty control â€” full width, âˆ’ N + layout */
.qty-ctrl{display:flex;align-items:center;justify-content:space-between;background:var(--green);border-radius:9px;overflow:hidden;width:100%;}
.qty-ctrl button{background:none;color:#000;font-size:17px;font-weight:900;padding:5px 11px;border:none;line-height:1;flex-shrink:0;}
.qty-ctrl button:active{background:rgba(0,0,0,.12);}
.qty-ctrl span{color:#000;font-size:12px;font-weight:900;flex:1;text-align:center;}

/* Variant selector inside card */
.pc-variant-btn{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:5px 8px;font-size:11px;color:var(--text);font-weight:600;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;text-align:left;transition:border-color .2s;}
.pc-variant-btn:active{border-color:var(--green);background:rgba(45,211,111,.06);}
.pc-variant-btn .vb-arrow{font-size:.7rem;color:var(--text3);transition:transform .3s cubic-bezier(.4,0,.2,1);}
.pc-variant-btn.open .vb-arrow{transform:rotate(180deg);}
/* Variant dropdown */
.pc-variant-dropdown{overflow:hidden;max-height:0;opacity:0;transition:max-height .32s cubic-bezier(.4,0,.2,1),opacity .22s ease;background:var(--bg3);border-radius:8px;border:1px solid var(--border);margin-bottom:6px;}
.pc-variant-dropdown.open{max-height:200px;opacity:1;}
.pc-vd-option{padding:7px 10px;font-size:11px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);transition:background .15s;}
.pc-vd-option:last-child{border:none;}
.pc-vd-option:active{background:rgba(45,211,111,.1);}
.pc-vd-option.selected{color:var(--green);}
.pc-vd-option .vd-price{font-size:10px;color:var(--text3);font-weight:500;}
.pc-vd-option.selected .vd-price{color:var(--green);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PRODUCT FULL PAGE (category page) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fp-head{flex-shrink:0;display:flex;align-items:center;gap:10px;padding:10px 14px;padding-top:max(env(safe-area-inset-top,10px),10px);background:var(--bg);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;}
.back-btn{width:36px;height:36px;border-radius:10px;background:var(--bg2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:1rem;color:var(--text);flex-shrink:0;}
.fp-title{font-size:.96rem;font-weight:800;letter-spacing:-.3px;}
.fp-body{flex:1;overflow-y:auto;padding:14px;}
.fp-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BULK PRICING TABLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bulk-table{width:100%;border-collapse:collapse;margin:4px 0 2px;}
.bulk-table tr{border-bottom:1px solid var(--border);}
.bulk-table tr:last-child{border:none;}
.bulk-table td{padding:2.5px 0;font-size:9.5px;line-height:1.3;}
.bulk-table .bt-qty{color:var(--text2);font-weight:500;}
.bulk-table .bt-price{text-align:right;font-weight:700;color:var(--text);}
.bulk-table tr.bt-active .bt-qty,.bulk-table tr.bt-active .bt-price{color:var(--green);font-weight:800;}
.bulk-table .bt-tag{font-size:8px;background:rgba(45,211,111,.15);color:var(--green);border-radius:3px;padding:1px 4px;margin-left:3px;font-weight:800;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FLOAT CART PILL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes cartBounce{0%{transform:translateX(-50%) scale(1)}30%{transform:translateX(-50%) translateY(-8px) scale(1.08)}60%{transform:translateX(-50%) translateY(0) scale(.96)}100%{transform:translateX(-50%) scale(1)}}
@keyframes pillPulse{0%,100%{box-shadow:0 4px 24px rgba(45,211,111,.4)}50%{box-shadow:0 4px 36px rgba(45,211,111,.7)}}
.fcart{position:fixed;bottom:68px;left:50%;transform:translateX(-50%) translateY(20px);background:linear-gradient(135deg,#2dd36f,#1da856);border-radius:14px;display:flex;align-items:center;padding:0;overflow:hidden;cursor:pointer;box-shadow:0 6px 28px rgba(45,211,111,.45);z-index:250;opacity:0;pointer-events:none;transition:opacity .25s,transform .3s cubic-bezier(.34,1.56,.64,1);min-width:0;}
.fcart.show{opacity:1;pointer-events:auto;transform:translateX(-50%) translateY(0);animation:pillPulse 2.5s ease-in-out infinite;}
.fcart.bounce{animation:cartBounce .45s cubic-bezier(.36,.07,.19,.97)!important;}
.fc-left{padding:9px 12px 9px 14px;display:flex;align-items:center;gap:7px;}
.fc-icon{font-size:.9rem;}
.fc-cnt-badge{background:rgba(0,0,0,.2);border-radius:6px;padding:2px 7px;font-size:.72rem;font-weight:800;color:#000;}
.fc-label{font-size:.82rem;font-weight:800;color:#000;}
.fc-divider{width:1px;background:rgba(0,0,0,.15);height:36px;}
.fc-amt{padding:9px 14px;font-size:.9rem;font-weight:900;color:#000;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CART OVERLAY & DRAWER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cart-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:300;opacity:0;pointer-events:none;transition:opacity .3s;backdrop-filter:blur(4px);}
.cart-overlay.open{opacity:1;pointer-events:auto;}
.cart-drawer{position:fixed;bottom:0;left:50%;transform:translateX(-50%) translateY(100%);width:100%;max-width:480px;background:var(--bg2);border-radius:22px 22px 0 0;z-index:301;display:flex;flex-direction:column;max-height:92vh;padding-bottom:env(safe-area-inset-bottom,0);transition:transform .38s cubic-bezier(.32,.72,0,1);box-shadow:0 -8px 40px rgba(0,0,0,.6);}
.cart-drawer.open{transform:translateX(-50%) translateY(0);}
.cart-drag{width:40px;height:4px;border-radius:2px;background:var(--bg5);margin:10px auto 0;flex-shrink:0;}
.cart-hd{padding:10px 18px 12px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;border-bottom:1px solid var(--border);}
.cart-hd-left{display:flex;align-items:center;gap:8px;}
.cart-hd-icon{width:32px;height:32px;background:var(--green-dim);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:.95rem;}
.cart-hd h2{font-size:.95rem;font-weight:800;}
.cart-hd-count{font-size:.68rem;font-weight:600;color:var(--text2);background:var(--bg3);border-radius:20px;padding:2px 8px;border:1px solid var(--border);}
.close-x{width:30px;height:30px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:.85rem;color:var(--text2);border:1px solid var(--border);cursor:pointer;}
.cart-body{flex:0 1 auto;overflow-y:auto;padding:8px 16px 4px;max-height:44vh;}
.cart-foot{border-top:1px solid var(--border);flex-shrink:0;background:var(--bg2);overflow-y:auto;max-height:50vh;}

/* â”€â”€ CART ITEM â”€â”€ */
@keyframes ciIn{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}
.ci{display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid var(--border);animation:ciIn .2s ease both;}
.ci:last-child{border:none;}
.ci-img{width:52px;height:52px;border-radius:10px;background:var(--bg3);overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;border:1px solid var(--border);}
.ci-img img{width:100%;height:100%;object-fit:contain;padding:4px;}
.ci-info{flex:1;min-width:0;}
.ci-name{font-size:.82rem;font-weight:700;line-height:1.3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ci-meta{font-size:.66rem;color:var(--text3);margin-top:1px;}
.ci-price-row{display:flex;align-items:center;gap:6px;margin-top:4px;flex-wrap:wrap;}
.ci-total{font-size:.88rem;font-weight:900;}
.ci-each{font-size:.66rem;color:var(--text2);background:var(--bg3);padding:1px 5px;border-radius:4px;}
.tier-coach{display:inline-flex;align-items:center;gap:3px;background:rgba(45,211,111,.08);border:1px solid rgba(45,211,111,.2);border-radius:5px;padding:2px 6px;margin-top:3px;font-size:.62rem;font-weight:700;color:var(--green);}
.ci-ctrl{display:flex;align-items:center;background:var(--bg3);border-radius:9px;flex-shrink:0;border:1px solid var(--border);}
.ci-ctrl button{background:none;color:var(--text);font-size:15px;font-weight:700;padding:5px 10px;border:none;line-height:1;}
.ci-ctrl span{font-size:.82rem;font-weight:800;min-width:22px;text-align:center;color:var(--text);}

/* â”€â”€ FREE DELIVERY BAR â”€â”€ */
.fd-wrap{padding:12px 16px 0;}
.fd-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;}
.fd-label{font-size:.72rem;font-weight:700;}
.fd-label em{font-style:normal;font-weight:900;color:var(--green);}
.fd-label.unlocked{color:var(--green);}
.fd-pct{font-size:.67rem;color:var(--text3);}
.fd-track{height:5px;background:var(--bg4);border-radius:3px;overflow:hidden;}
.fd-fill{height:100%;border-radius:3px;transition:width .55s cubic-bezier(.34,1.56,.64,1);}
.fd-fill.pending{background:linear-gradient(90deg,var(--green),#06d6a0);}
.fd-fill.unlocked{background:linear-gradient(90deg,var(--green),#00e5a0);}

/* â”€â”€ SAVINGS STRIP â”€â”€ */
.savings-strip{display:flex;align-items:center;gap:8px;background:var(--green-dim);border:1px solid rgba(45,211,111,.18);border-radius:10px;padding:8px 12px;font-size:.74rem;font-weight:700;color:var(--green);}

/* â”€â”€ UPSELL â”€â”€ */
.upsell-wrap{padding:10px 16px 0;}
.upsell-label{font-size:.6rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:7px;}
.upsell-scroll{display:flex;gap:7px;overflow-x:auto;padding-bottom:4px;}
.upsell-card{flex-shrink:0;width:88px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:8px 7px;text-align:center;cursor:pointer;}
.upsell-card-img{width:36px;height:36px;border-radius:7px;background:var(--bg4);margin:0 auto 5px;display:flex;align-items:center;justify-content:center;overflow:hidden;}
.upsell-card-img img{width:100%;height:100%;object-fit:contain;}
.upsell-card-name{font-size:.6rem;font-weight:700;line-height:1.2;margin-bottom:3px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
.upsell-card-price{font-size:.68rem;font-weight:800;color:var(--green);margin-bottom:4px;}
.upsell-add-btn{width:100%;background:var(--green);color:#000;border-radius:6px;padding:4px 0;font-size:.6rem;font-weight:800;border:none;cursor:pointer;}
.upsell-add-btn.added{background:var(--bg4);color:var(--text3);}

/* â”€â”€ GIFT PROGRESS â”€â”€ */
@keyframes giftPulse{0%,100%{box-shadow:0 0 0 0 rgba(251,191,36,.2)}50%{box-shadow:0 0 0 6px rgba(251,191,36,0)}}
.gift-progress-card{margin:0;background:linear-gradient(135deg,rgba(251,191,36,.07),rgba(245,158,11,.03));border:1px solid rgba(251,191,36,.2);border-radius:12px;padding:10px 12px;transition:border-color .3s;}
.gift-progress-card.near{border-color:rgba(251,191,36,.4);animation:giftPulse 2s ease-in-out infinite;}
.gift-progress-header{display:flex;align-items:center;gap:8px;margin-bottom:7px;}
.gift-progress-text{flex:1;}
.gift-progress-title{font-size:.73rem;font-weight:700;line-height:1.3;}
.gift-progress-title em{font-style:normal;color:#fbbf24;font-weight:900;}
.gift-progress-remaining{font-size:.62rem;color:var(--text3);margin-top:1px;}
.gift-progress-bar-track{height:4px;background:rgba(255,255,255,.07);border-radius:4px;overflow:hidden;}
.gift-progress-bar-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,#f59e0b,#fbbf24);transition:width .55s cubic-bezier(.34,1.56,.64,1);}
.gift-claim-btn{width:100%;margin-top:8px;background:linear-gradient(135deg,rgba(251,191,36,.15),rgba(245,158,11,.1));border:1px solid rgba(251,191,36,.35);border-radius:10px;padding:9px;font-size:.78rem;font-weight:800;color:#fbbf24;cursor:pointer;}
.gift-unlocked-banner{display:flex;align-items:center;gap:10px;background:linear-gradient(135deg,rgba(251,191,36,.1),rgba(245,158,11,.05));border:1px solid rgba(251,191,36,.3);border-radius:12px;padding:10px 12px;}
.gift-unlocked-icon{width:36px;height:36px;border-radius:10px;background:rgba(251,191,36,.15);border:1px solid rgba(251,191,36,.25);display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
.gift-unlocked-body{flex:1;min-width:0;}
.gift-unlocked-title{font-size:.78rem;font-weight:800;color:#fbbf24;line-height:1.2;}
.gift-unlocked-sub{font-size:.65rem;color:var(--text3);margin-top:2px;}
.gift-free-pill{font-size:.65rem;font-weight:900;padding:3px 8px;border-radius:20px;background:rgba(251,191,36,.2);border:1px solid rgba(251,191,36,.4);color:#fbbf24;flex-shrink:0;}

/* Gift cart item */
.ci-gift{background:rgba(251,191,36,.04);border-radius:10px;border:1px solid rgba(251,191,36,.15)!important;padding:8px 10px!important;margin:0 0 6px;}
.ci-gift-price{font-size:.88rem;font-weight:900;color:var(--green);}
.ci-gift-original{font-size:.7rem;color:var(--text3);text-decoration:line-through;}
.ci-gift-badge{display:inline-block;font-size:.65rem;font-weight:800;padding:2px 7px;border-radius:20px;background:rgba(45,211,111,.15);border:1px solid rgba(45,211,111,.25);color:var(--green);margin-top:3px;}
.ci-gift-remove{width:26px;height:26px;border-radius:8px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;color:var(--text3);cursor:pointer;}

/* â”€â”€ CART CTA BAR â”€â”€ */
.cart-cta-bar{padding:12px 16px;padding-bottom:max(12px,env(safe-area-inset-bottom,12px));background:var(--bg2);border-top:1px solid var(--border);flex-shrink:0;}
.cart-cta-btn{width:100%;background:linear-gradient(135deg,#2dd36f,#1da856);color:#000;border-radius:14px;padding:.88rem 1.2rem;font-size:.94rem;font-weight:900;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 22px rgba(45,211,111,.3);transition:filter .15s,transform .12s;}
.cart-cta-btn:active{transform:scale(.98);filter:brightness(.92);}
.cart-cta-btn:disabled{background:var(--bg3);color:var(--text3);box-shadow:none;}
.cart-cta-total{font-size:1rem;font-weight:900;background:rgba(0,0,0,.12);padding:4px 12px;border-radius:9px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHECKOUT PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cko-page{position:fixed;inset:0;background:var(--bg);z-index:400;display:flex;flex-direction:column;max-width:480px;margin:0 auto;transform:translateY(100%);transition:transform .38s cubic-bezier(.32,.72,0,1);}
.cko-page.open{transform:translateY(0);}
.cko-topbar{flex-shrink:0;display:flex;align-items:center;gap:10px;padding:12px 16px;padding-top:max(env(safe-area-inset-top,12px),12px);border-bottom:1px solid var(--border);background:var(--bg);}
.cko-back{width:36px;height:36px;border-radius:10px;background:var(--bg2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:1rem;cursor:pointer;}
.cko-topbar-title{font-size:.96rem;font-weight:800;}
.cko-topbar-sub{font-size:.65rem;color:var(--text3);margin-top:1px;}
.cko-body{flex:1;overflow-y:auto;padding:0 0 120px;}
.cko-section{padding:16px 16px 0;}
.cko-sec-label{font-size:.6rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.12em;margin-bottom:10px;display:flex;align-items:center;gap:6px;}
.cko-sec-label::after{content:'';flex:1;height:1px;background:var(--border);}

/* Delivery card */
.ck-dlv-card{background:var(--bg2);border:1.5px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:4px;transition:border-color .25s;}
.ck-dlv-card.has-data{border-color:rgba(45,211,111,.3);}
.ck-dlv-card.editing{border-color:rgba(45,211,111,.4);}
.ck-dlv-collapsed{display:flex;align-items:center;gap:12px;padding:13px 15px;cursor:pointer;}
.ck-dlv-addr-icon{width:38px;height:38px;border-radius:10px;background:var(--green-dim);border:1px solid rgba(45,211,111,.2);display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
.ck-dlv-addr-body{flex:1;min-width:0;}
.ck-dlv-addr-line1{font-size:.82rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ck-dlv-addr-line2{font-size:.68rem;color:var(--text3);margin-top:2px;}
.ck-dlv-change{font-size:.68rem;font-weight:700;color:var(--green);background:var(--green-dim);border:1px solid rgba(45,211,111,.2);border-radius:8px;padding:5px 10px;flex-shrink:0;cursor:pointer;}
.ck-dlv-form{max-height:0;overflow:hidden;transition:max-height .38s cubic-bezier(.4,0,.2,1),opacity .28s;opacity:0;}
.ck-dlv-card.editing .ck-dlv-form{max-height:540px;opacity:1;}
.ck-dlv-form-inner{padding:14px 15px 15px;border-top:1px solid var(--border);}
.ck-field-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;}
.ck-field{display:flex;flex-direction:column;gap:5px;margin-bottom:8px;}
.ck-label{font-size:.6rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.07em;}
.ck-inp{width:100%;background:var(--bg3);border:1.5px solid var(--border);border-radius:11px;padding:.62rem .9rem;font-size:.88rem;color:var(--text);outline:none;transition:border-color .2s;}
.ck-inp:focus{border-color:var(--green);}
.ck-inp::placeholder{color:var(--text3);}
select.ck-inp option{background:var(--bg2);}
.ck-save-btn{width:100%;background:var(--green);color:#000;border-radius:11px;padding:.7rem;font-size:.84rem;font-weight:800;margin-top:4px;}

/* Payment cards */
.ck-pay-cards{display:flex;flex-direction:column;gap:8px;}
.ck-pay-card{position:relative;background:var(--bg2);border:1.5px solid var(--border);border-radius:14px;padding:12px 14px;cursor:pointer;display:flex;align-items:center;gap:12px;transition:border-color .2s,background .2s;}
.ck-pay-card.selected{border-color:var(--green);background:rgba(45,211,111,.04);}
.ck-pay-card-icon{width:40px;height:40px;border-radius:11px;background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;transition:background .2s;}
.ck-pay-card.selected .ck-pay-card-icon{background:var(--green-dim);border-color:rgba(45,211,111,.25);}
.ck-pay-card-body{flex:1;}
.ck-pay-card-title{font-size:.84rem;font-weight:700;}
.ck-pay-card-sub{font-size:.67rem;color:var(--text3);margin-top:2px;}
.ck-pay-radio{width:20px;height:20px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;transition:border-color .2s;flex-shrink:0;}
.ck-pay-card.selected .ck-pay-radio{border-color:var(--green);}
.ck-pay-radio::after{content:'';width:10px;height:10px;border-radius:50%;background:var(--green);transform:scale(0);transition:transform .2s cubic-bezier(.34,1.56,.64,1);}
.ck-pay-card.selected .ck-pay-radio::after{transform:scale(1);}

/* Order summary */
.ck-sum-box{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:14px;margin-top:4px;}
.ck-sum-row{display:flex;justify-content:space-between;align-items:center;font-size:.84rem;padding:5px 0;color:var(--text2);}
.ck-sum-row span:last-child{font-weight:700;color:var(--text);}
.ck-sum-row.free-dlv span:last-child{color:var(--green);}
.ck-sum-row.ck-row-save span:last-child{color:var(--green);}
.ck-sum-row.ck-row-save span:first-child{color:var(--text2);}
.ck-sum-row.ck-row-free span:last-child{color:var(--green);font-weight:800;}
.ck-sum-row.ck-row-gift span:last-child{color:#f59e0b;}
.ck-sum-divider{height:1px;background:var(--border);margin:8px 0;}
.ck-sum-total{display:flex;justify-content:space-between;align-items:center;font-size:.95rem;font-weight:900;padding:4px 0;}
.ck-sum-total span:first-child{color:var(--text2);font-size:.82rem;font-weight:600;}
.ck-sum-total-num{color:var(--green);font-size:1.15rem;}
/* Locked pay card (account not logged in) */
.ck-pay-locked{opacity:.55;}

/* Place order bar */
.ck-place-bar{flex-shrink:0;padding:12px 16px;padding-bottom:max(12px,env(safe-area-inset-bottom,12px));border-top:1px solid var(--border);background:var(--bg);}
.ck-place-btn{width:100%;background:linear-gradient(135deg,#2dd36f,#1da856);color:#000;border-radius:14px;padding:.9rem 1.2rem;font-size:.96rem;font-weight:900;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 20px rgba(45,211,111,.3);transition:filter .15s,transform .12s;}
.ck-place-btn:active{transform:scale(.98);filter:brightness(.9);}
.ck-place-amt{font-size:1rem;font-weight:900;background:rgba(0,0,0,.12);padding:4px 12px;border-radius:9px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BOTTOM NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bnav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:var(--bg2);border-top:1px solid var(--border);display:flex;z-index:100;padding-bottom:env(safe-area-inset-bottom,0);box-shadow:0 -4px 20px rgba(0,0,0,.4);}
.bn-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;padding:.55rem .3rem;cursor:pointer;color:var(--text3);transition:color .15s;}
.bn-item.active{color:var(--green);}
.bn-item .ni{font-size:1.2rem;line-height:1;}
.bn-item .nl{font-size:.58rem;font-weight:700;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SUCCESS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.success{position:fixed;inset:0;background:var(--bg);z-index:600;display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:30px;}
.success.show{display:flex;}
.s-icon{font-size:3.5rem;margin-bottom:16px;animation:bounce .6s ease both;}
@keyframes bounce{0%{transform:scale(0)}60%{transform:scale(1.2)}100%{transform:scale(1)}}
.s-title{font-size:1.5rem;font-weight:900;margin-bottom:8px;}
.s-sub{font-size:.85rem;color:var(--text2);line-height:1.6;margin-bottom:28px;}
.s-back{background:var(--green);color:#000;border-radius:14px;padding:.9rem 2rem;font-size:.9rem;font-weight:800;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ACCOUNT PAGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.acc-topbar{flex-shrink:0;display:flex;align-items:center;gap:10px;padding:12px 16px;padding-top:max(env(safe-area-inset-top,12px),12px);border-bottom:1px solid var(--border);background:var(--bg);}
.acc-back{width:36px;height:36px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.05rem;cursor:pointer;flex-shrink:0;}
.acc-topbar-title{font-size:.95rem;font-weight:800;}
.acc-topbar-sub{font-size:.65rem;color:var(--text3);}
.acc-tabs{display:flex;gap:6px;padding:12px 16px 0;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--bg);}
.acc-tab{flex:1;padding:9px 4px 11px;text-align:center;font-size:.78rem;font-weight:700;cursor:pointer;color:var(--text3);border-bottom:2.5px solid transparent;transition:all .18s;}
.acc-tab.active{color:var(--green);border-bottom-color:var(--green);}
.acc-body{flex:1;overflow-y:auto;padding:16px 16px 90px;}
.acc-card{background:var(--bg2);border-radius:18px;border:1px solid var(--border);overflow:hidden;margin-bottom:12px;}
.acc-card-hero{background:linear-gradient(145deg,#0d2218,#0e1c14,#091510);padding:22px 20px;position:relative;overflow:hidden;}
.acc-card-hero::after{content:'';position:absolute;top:-30px;right:-30px;width:120px;height:120px;background:radial-gradient(circle,rgba(45,211,111,.15),transparent 70%);}
.acc-hero-emoji{font-size:2.2rem;display:block;margin-bottom:8px;}
.acc-hero-title{font-size:1.05rem;font-weight:900;color:#fff;margin-bottom:4px;}
.acc-hero-sub{font-size:.74rem;color:rgba(255,255,255,.4);line-height:1.6;}
.acc-form-body{padding:18px 18px 20px;}
.acc-field{margin-bottom:13px;}
.acc-label{font-size:.68rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.07em;display:block;margin-bottom:6px;}
.acc-inp{width:100%;background:var(--bg3);border:1.5px solid var(--border);border-radius:12px;padding:.72rem 1rem;font-size:.9rem;color:var(--text);outline:none;transition:border-color .2s;}
.acc-inp:focus{border-color:var(--green);}
.acc-inp::placeholder{color:var(--text3);}
.acc-btn{width:100%;padding:.8rem;border-radius:12px;font-size:.9rem;font-weight:800;cursor:pointer;border:none;transition:transform .1s,filter .15s;}
.acc-btn:active{transform:scale(.98);}
.acc-btn-green{background:var(--green);color:#000;margin-bottom:8px;}
.acc-btn-outline{background:none;border:1.5px solid var(--border);color:var(--text2);}
.acc-btn-danger{background:rgba(255,71,87,.07);border:1.5px solid rgba(255,71,87,.2);color:var(--red);margin-top:8px;}
.dash-profile{background:linear-gradient(145deg,#0d2218,#0e1c14);border-radius:18px;padding:18px;margin-bottom:12px;position:relative;overflow:hidden;}
.dash-profile::after{content:'';position:absolute;top:-30px;right:-30px;width:120px;height:120px;background:radial-gradient(circle,rgba(45,211,111,.18),transparent 70%);}
.dash-avatar-row{display:flex;align-items:center;gap:12px;margin-bottom:12px;position:relative;z-index:1;}
.dash-avatar{width:44px;height:44px;border-radius:12px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;font-size:1.3rem;}
.dash-name{font-size:1.05rem;font-weight:900;color:#fff;}
.dash-phone{font-size:.72rem;color:rgba(255,255,255,.35);margin-top:2px;}
.dash-chips{display:flex;flex-wrap:wrap;gap:6px;position:relative;z-index:1;}
.dash-chip{font-size:.68rem;font-weight:700;padding:3px 10px;border-radius:20px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.06);color:rgba(255,255,255,.5);}
.dash-chip.g{background:rgba(45,211,111,.12);border-color:rgba(45,211,111,.2);color:#4ade80;}
.dash-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px;}
.dash-stat{background:var(--bg2);border-radius:14px;border:1px solid var(--border);padding:13px 8px;text-align:center;}
.ds-num{font-size:1.15rem;font-weight:900;margin-bottom:2px;}
.ds-num.b{color:#60a5fa;}.ds-num.g{color:var(--green);}.ds-num.y{color:#fbbf24;}
.ds-lbl{font-size:.6rem;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.05em;}
.sec-row{display:flex;align-items:center;justify-content:space-between;margin:14px 0 8px;}
.sec-label{font-size:.68rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;}
.sec-count{font-size:.68rem;color:var(--text3);background:var(--bg2);border:1px solid var(--border);padding:2px 9px;border-radius:20px;}
.milk-log-wrap{background:var(--bg2);border-radius:16px;border:1px solid var(--border);overflow:hidden;margin-bottom:12px;}
.milk-log-row{display:flex;align-items:center;gap:10px;padding:11px 14px;border-bottom:1px solid var(--border);}
.milk-log-row:last-child{border:none;}
.mlog-day{width:40px;text-align:center;flex-shrink:0;}
.mlog-day-num{font-size:.9rem;font-weight:900;}
.mlog-day-name{font-size:.55rem;font-weight:700;color:var(--text3);text-transform:uppercase;margin-top:1px;}
.mlog-divider{width:1px;height:30px;background:var(--border);flex-shrink:0;}
.mlog-info{flex:1;}
.mlog-qty{font-size:.84rem;font-weight:700;}
.mlog-amt{font-size:.72rem;color:var(--text3);margin-top:1px;}
.mlog-pill{font-size:.65rem;font-weight:700;padding:3px 8px;border-radius:20px;background:var(--green-dim);color:var(--green);border:1px solid rgba(45,211,111,.2);}
.milk-log-empty{text-align:center;padding:24px;color:var(--text3);font-size:.82rem;}
.grocery-item-card{background:var(--bg2);border-radius:14px;border:1px solid var(--border);padding:11px 14px;margin-bottom:7px;display:flex;align-items:center;gap:10px;}
.gi-icon{width:34px;height:34px;border-radius:9px;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:.95rem;flex-shrink:0;border:1px solid var(--border);}
.gi-info{flex:1;min-width:0;}
.gi-name{font-size:.84rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.gi-sub{font-size:.7rem;color:var(--text3);margin-top:1px;}
.gi-amt{font-size:.88rem;font-weight:800;color:var(--green);flex-shrink:0;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONFETTI & TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes confettiFall{0%{opacity:1;transform:translateY(0) rotate(0)}100%{opacity:0;transform:translateY(160px) rotate(600deg)}}
.cpiece{position:fixed;border-radius:2px;animation:confettiFall .9s ease forwards;z-index:9999;pointer-events:none;}
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(10px);background:#1a1a1a;color:#fff;padding:.65rem 1.2rem;border-radius:12px;font-size:.82rem;font-weight:600;z-index:9998;opacity:0;pointer-events:none;transition:opacity .25s,transform .25s;white-space:nowrap;border:1px solid var(--border);box-shadow:0 4px 20px rgba(0,0,0,.4);}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EMPTY STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty-state{text-align:center;padding:3rem 1rem;color:var(--text2);}
.empty-state .ei{font-size:2.5rem;margin-bottom:.5rem;}
.empty-state p{font-size:.88rem;line-height:1.6;color:var(--text3);}

/* Qty grid for milk reg */
.qty-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;}
.qty-opt{padding:10px 4px;text-align:center;border-radius:10px;border:1.5px solid var(--border);background:var(--bg3);font-size:.82rem;font-weight:700;cursor:pointer;color:var(--text3);transition:all .16s;}
.qty-opt.selected{border-color:var(--green);background:rgba(45,211,111,.1);color:var(--green);}

/* Udhar rows */
.su2,.su3,.su4{margin-bottom:12px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PIN INPUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pin-input-row{display:flex;gap:10px;justify-content:center;margin:6px 0;}
.pin-box{width:56px;height:60px;border-radius:14px;background:var(--bg3);border:2px solid var(--border);text-align:center;font-size:1.4rem;font-weight:900;color:var(--text);outline:none;transition:border-color .2s;-webkit-text-security:disc;}
.pin-box:focus{border-color:var(--green);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ACCOUNT QUICK BUTTONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.acc-quick-btn{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:14px 8px;display:flex;flex-direction:column;align-items:center;gap:7px;cursor:pointer;transition:all .18s;}
.acc-quick-btn:active{transform:scale(.94);border-color:var(--green);}
.aqb-icon{font-size:1.5rem;line-height:1;}
.aqb-label{font-size:.72rem;font-weight:700;color:var(--text2);text-align:center;}

/* stat card variant */
.ds-num-card{background:var(--bg2);border-radius:14px;border:1px solid var(--border);padding:13px 8px;text-align:center;}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CALENDAR LEDGER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* Month list */
.month-list{display:flex;flex-direction:column;gap:8px;margin-bottom:16px;}
.month-card{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:all .2s;}
.month-card:active{transform:scale(.98);border-color:var(--green);}
.month-card-left{display:flex;flex-direction:column;gap:3px;}
.month-card-name{font-size:.9rem;font-weight:800;}
.month-card-meta{font-size:.68rem;color:var(--text3);}
.month-card-right{display:flex;align-items:center;gap:8px;}
.month-card-amt{font-size:.82rem;font-weight:800;color:var(--red);}
.month-card-arr{font-size:.8rem;color:var(--text3);}
.month-card.current{border-color:rgba(45,211,111,.3);background:rgba(45,211,111,.04);}

/* Calendar grid */
.cal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg);border-bottom:1px solid var(--border);flex-shrink:0;}
.cal-header-title{font-size:1rem;font-weight:900;}
.cal-nav-btn{width:34px;height:34px;background:var(--bg2);border:1px solid var(--border);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:.9rem;cursor:pointer;color:var(--text);}
.cal-summary-bar{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;padding:10px 12px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0;}
.cs-item{text-align:center;}
.cs-val{font-size:.82rem;font-weight:900;}
.cs-lbl{font-size:.55rem;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.04em;margin-top:1px;}
.cs-val.red{color:var(--red);}
.cs-val.grn{color:var(--green);}
.cs-val.yel{color:#fbbf24;}
.cal-grid-wrap{padding:8px 12px 0;flex-shrink:0;}
.cal-dow-row{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:4px;}
.cal-dow{font-size:.58rem;font-weight:700;color:var(--text3);text-align:center;padding:3px 0;text-transform:uppercase;}
.cal-cells{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.cal-cell{min-height:48px;border-radius:10px;display:flex;flex-direction:column;align-items:center;padding:4px 2px;cursor:pointer;position:relative;border:1.5px solid transparent;transition:all .15s;}
.cal-cell.empty{cursor:default;}
.cal-cell.today{border-color:rgba(45,211,111,.4);background:rgba(45,211,111,.06);}
.cal-cell.selected{border-color:var(--green);background:rgba(45,211,111,.12);}
.cal-cell:not(.empty):active{transform:scale(.94);}
.cal-cell-day{font-size:.72rem;font-weight:700;color:var(--text);line-height:1.2;margin-bottom:2px;}
.cal-cell.empty .cal-cell-day{color:transparent;}
.cal-cell-dots{display:flex;flex-wrap:wrap;gap:2px;justify-content:center;align-items:center;}
.cal-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.dot-milk{background:#60a5fa;}
.dot-order{background:#a78bfa;}
.dot-udhar{background:#f59e0b;}
.dot-payment{background:var(--green);}
.cal-cell-total{font-size:.55rem;font-weight:800;color:var(--text3);margin-top:2px;line-height:1;}

/* Daily ledger */
.day-ledger{flex:1;overflow-y:auto;padding:12px 12px 90px;}
.day-header{padding:10px 14px;background:var(--bg2);border-radius:14px;border:1px solid var(--border);margin-bottom:10px;display:flex;align-items:center;justify-content:space-between;}
.day-date-title{font-size:.92rem;font-weight:900;}
.day-total-chip{font-size:.72rem;font-weight:800;padding:4px 10px;border-radius:20px;background:rgba(255,71,87,.08);color:var(--red);border:1px solid rgba(255,71,87,.15);}
.day-total-chip.zero{background:var(--green-dim);color:var(--green);border-color:rgba(45,211,111,.2);}
.ledger-entry{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:12px 14px;margin-bottom:8px;display:flex;align-items:flex-start;gap:10px;}
.le-icon-wrap{width:36px;height:36px;border-radius:10px;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:1.05rem;flex-shrink:0;border:1px solid var(--border);}
.le-body{flex:1;min-width:0;}
.le-source-row{display:flex;align-items:center;gap:6px;margin-bottom:2px;}
.le-source{font-size:.6rem;font-weight:800;padding:2px 6px;border-radius:4px;letter-spacing:.04em;}
.src-app{background:rgba(167,139,250,.12);color:#a78bfa;}
.src-store{background:rgba(245,158,11,.12);color:#f59e0b;}
.src-sub{background:rgba(96,165,250,.12);color:#60a5fa;}
.src-pay{background:rgba(45,211,111,.12);color:var(--green);}
.le-time{font-size:.6rem;color:var(--text3);}
.le-desc{font-size:.84rem;font-weight:700;line-height:1.35;margin-bottom:2px;}
.le-note{font-size:.7rem;color:var(--text3);}
.le-amt{flex-shrink:0;text-align:right;}
.le-amt-val{font-size:.92rem;font-weight:900;}
.le-amt-val.debit{color:var(--red);}
.le-amt-val.credit{color:var(--green);}
.le-amt-type{font-size:.6rem;color:var(--text3);font-weight:600;}
.legend-row{display:flex;align-items:center;gap:12px;padding:8px 0;flex-wrap:wrap;}
.legend-item{display:flex;align-items:center;gap:4px;font-size:.65rem;color:var(--text3);font-weight:600;}

/* Outstanding badge */
.outstanding-banner{background:rgba(255,71,87,.06);border:1px solid rgba(255,71,87,.15);border-radius:14px;padding:14px 16px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;}
.ob-label{font-size:.72rem;color:var(--text3);font-weight:600;}
.ob-amount{font-size:1.4rem;font-weight:900;color:var(--red);}
.ob-amount.clear{color:var(--green);}

/* Cal view toggle */
.cal-view-tabs{display:flex;gap:6px;padding:10px 12px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--bg);}
.cal-vtab{flex:1;padding:8px 4px;text-align:center;font-size:.75rem;font-weight:700;cursor:pointer;color:var(--text3);border-radius:9px;border:1.5px solid transparent;transition:all .18s;}
.cal-vtab.active{color:var(--green);border-color:rgba(45,211,111,.3);background:rgba(45,211,111,.07);}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="top-row" id="topRow">
    <div class="logo">ğŸ›’ <span>BSC</span></div>
    <div class="icon-btn" onclick="openCart()">ğŸ›’<div class="cart-badge" id="cartBadge">0</div></div>
  </div>
  <div class="search-wrap">
    <div class="search-bar">
      <span class="search-icon">ğŸ”</span>
      <input id="searchInput" placeholder="Search products..." oninput="onSearch(this.value)" onfocus="clearAnimatedPH()" onblur="startAnimatedPH()">
      <span id="searchClear" style="color:var(--text3);cursor:pointer;font-size:.8rem;display:none" onclick="clearSearch()">âœ•</span>
    </div>
  </div>
  <div class="cat-tabs" id="catTabs"></div>
</div>

<!-- ACCOUNT PAGE -->
<div class="acc-page" id="milkPage">
  <div class="acc-topbar">
    <button class="acc-back" onclick="closeMilkPage()">&#8592;</button>
    <div><div class="acc-topbar-title" id="accTopTitle">My Account</div><div class="acc-topbar-sub" id="accTopSub">BSC Store</div></div>
  </div>
  <div class="acc-body" id="milkBody" style="padding:0"></div>
</div>

<!-- MAIN SCROLL -->
<div class="scroll" id="scroll"><div id="home"></div></div>

<!-- CATEGORY / SEARCH FULL PAGE -->
<div class="fpage" id="fpage">
  <div class="fp-head">
    <button class="back-btn" onclick="closeFP()">&#8592;</button>
    <span class="fp-title" id="fpTitle"></span>
  </div>
  <div class="fp-body"><div class="fp-grid" id="fpGrid"></div></div>
</div>
<div class="fpage" id="searchPage">
  <div class="fp-head">
    <button class="back-btn" onclick="closeSearch()">&#8592;</button>
    <span class="fp-title">Search Results</span>
  </div>
  <div class="fp-body"><div class="fp-grid" id="searchGrid"></div></div>
</div>

<!-- CHECKOUT PAGE -->
<div class="cko-page" id="ckoPage">
  <div class="cko-topbar">
    <button class="cko-back" onclick="closeCkoPage()">&#8592;</button>
    <div><div class="cko-topbar-title">Checkout</div><div class="cko-topbar-sub" id="ckoTopSub">Review &amp; place order</div></div>
  </div>
  <div class="cko-body" id="ckoBody"></div>
  <div class="ck-place-bar">
    <button class="ck-place-btn" id="ckPlaceBtn" onclick="ckoPlace()">
      <span>Place Order</span>
      <span class="ck-place-amt" id="ckPlaceAmt">â‚¹0</span>
    </button>
  </div>
</div>

<!-- CART -->
<div class="cart-overlay" id="cartOverlay" onclick="closeCart()"></div>
<div class="cart-drawer" id="cartDrawer">
  <div class="cart-drag"></div>
  <div class="cart-hd">
    <div class="cart-hd-left">
      <div class="cart-hd-icon">ğŸ›’</div>
      <h2>My Cart</h2>
      <span class="cart-hd-count" id="cartHdCount">0 items</span>
    </div>
    <button class="close-x" onclick="closeCart()">âœ•</button>
  </div>
  <div class="cart-body" id="cartBody"></div>
  <div class="cart-foot" id="cartFoot"></div>
</div>

<!-- SUCCESS -->
<div class="success" id="success">
  <div class="s-icon">ğŸ‰</div>
  <div class="s-title">Order Placed!</div>
  <div class="s-sub" id="successMsg">Your order has been received!<br>We'll deliver to your villa soon ğŸš€</div>
  <button class="s-back" onclick="closeSuccess()">Continue Shopping</button>
</div>

<!-- FLOAT CART PILL -->
<div class="fcart" id="fcart" onclick="openCart()">
  <div class="fc-left">
    <span class="fc-icon">ğŸ›’</span>
    <span class="fc-cnt-badge" id="fcCnt">0</span>
    <span class="fc-label">View Cart</span>
  </div>
  <div class="fc-divider"></div>
  <span class="fc-amt" id="fcAmt">â‚¹0</span>
</div>

<!-- BOTTOM NAV -->
<div class="bnav">
  <div class="bn-item active" id="bn0" onclick="goHome()"><span class="ni">ğŸ </span><span class="nl">Home</span></div>
  <div class="bn-item" id="bn1" onclick="openCatsPage()"><span class="ni">âŠ</span><span class="nl">Categories</span></div>
  <div class="bn-item" id="bn3" onclick="openMilkPage()"><span class="ni">ğŸ‘¤</span><span class="nl">Account</span></div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ GLOBALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let prods=[], cats=[], banners=[], settings={};
// cart: { "productId_variantId": qty, ... }
let cart = {};
let giftState = { injected:false, claimed:false, prevUnlocked:false };
let bIdx=0, bTimer=null;

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getVariant(p, vid) {
  if (!p.variants?.length) return null;
  return p.variants.find(v => v.id === vid) || p.variants[0];
}
function defaultVariant(p) {
  return p.variants?.[0] || null;
}
function cartKey(pid, vid) { return pid + '_' + vid; }
function parseKey(k) { const i = k.indexOf('_'); return { pid: parseInt(k.slice(0,i)), vid: k.slice(i+1) }; }

function getPrice(priceTiers, qty) {
  if (!priceTiers?.length) return 0;
  const sorted = [...priceTiers].sort((a,b) => a.minQty - b.minQty);
  let price = sorted[0].price;
  for (const t of sorted) { if (qty >= t.minQty) price = t.price; }
  return price;
}
function getVariantPrice(p, vid, qty) {
  const v = getVariant(p, vid);
  if (!v) return 0;
  return getPrice(v.priceTiers, qty || 1);
}

function offPct(price, mrp) {
  if (!mrp || mrp <= price) return 0;
  return Math.round((mrp - price) / mrp * 100);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  try {
    const d = await fetch('/api/store').then(r=>r.json());
    prods=d.products||[]; cats=d.categories||[]; banners=d.banners||[]; settings=d.settings||{};
    buildTabs(); renderHome();
  } catch(e) {
    document.getElementById('home').innerHTML='<div class="empty-state"><div class="ei">âš ï¸</div><p>Cannot reach server.</p></div>';
  }
  const scroller = document.getElementById('scroll');
  let _lastScrollY = 0;
  scroller.addEventListener('scroll', () => {
    const y = scroller.scrollTop;
    const topRow = document.getElementById('topRow');
    // Hide logo+cart after scrolling down 50px, keep search always visible
    if (topRow) topRow.classList.toggle('hidden', y > 50);
    _lastScrollY = y;
  }, { passive:true });

  // Animated placeholder
  startAnimatedPH();
}

const _phTerms = ['Search onionâ€¦','Search milkâ€¦','Search breadâ€¦','Search potatoâ€¦','Search tomatoâ€¦','Search eggsâ€¦','Search butterâ€¦','Search chipsâ€¦','Search riceâ€¦','Search dalâ€¦'];
let _phIdx = 0, _phTimer = null;

function startAnimatedPH() {
  const inp = document.getElementById('searchInput');
  if (!inp || inp.value) return;
  clearTimeout(_phTimer);
  function cycle() {
    if (!inp || document.activeElement === inp || inp.value) return;
    inp.setAttribute('placeholder', _phTerms[_phIdx % _phTerms.length]);
    _phIdx++;
    _phTimer = setTimeout(cycle, 2400);
  }
  cycle();
}

function clearAnimatedPH() {
  clearTimeout(_phTimer);
  const inp = document.getElementById('searchInput');
  if (inp) inp.setAttribute('placeholder', 'Search productsâ€¦');
}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTabs() {
  document.getElementById('catTabs').innerHTML =
    `<div class="ctab active" onclick="tabClick('all',this)"><div class="ti">ğŸ›ï¸</div><div class="tn">All</div></div>` +
    cats.map(c=>`<div class="ctab" onclick="tabClick(${c.id},this)">
      <div class="ti">${c.imageUrl?`<img src="${c.imageUrl}">`:'ğŸ“‚'}</div>
      <div class="tn">${c.name}</div>
    </div>`).join('');
}
function tabClick(id, el) {
  document.querySelectorAll('.ctab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  if (id==='all') { closeFP(); renderHome(); } else openFP(id);
}

// â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setNav(id) {
  ['bn0','bn1','bn3'].forEach(b => { const el=document.getElementById(b); if(el) el.classList.toggle('active', b===id); });
}
function goHome() {
  document.querySelectorAll('.ctab')[0]?.classList.add('active');
  document.querySelectorAll('.ctab').forEach((t,i)=>{ if(i>0) t.classList.remove('active'); });
  closeFP(); closeSearch(); document.getElementById('milkPage')?.classList.remove('open');
  renderHome(); setNav('bn0');
}
function openCatsPage() {
  setNav('bn1');
  document.getElementById('fpTitle').textContent = 'All Categories';
  document.getElementById('fpGrid').innerHTML = cats.map((c,i) =>
    `<div class="cat-card ${getCcBg(i)}" onclick="openFP(${c.id})">
      <div class="cc-img" style="height:100px">${c.imageUrl?`<img src="${c.imageUrl}" style="width:80%;height:80%;object-fit:contain">`:`<span class="cc-emoji">ğŸ“‚</span>`}</div>
      <div class="cc-name">${c.name}</div>
    </div>`
  ).join('');
  document.getElementById('fpage').classList.add('open');
}
function closeFP() { document.getElementById('fpage')?.classList.remove('open'); setNav('bn0'); }
function closeSearch() { document.getElementById('searchPage')?.classList.remove('open'); }

// â”€â”€ HOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getCcBg(i) { return 'cc-bg-' + (i % 8); }

function renderHome() {
  let h = '';
  // Banners
  if (banners.length) {
    h += `<div class="banner-wrap"><div class="banner-slider"><div class="banner-track" id="btrack">
      ${banners.map(b=>`<div class="banner-slide" onclick="bannerClick(${b.id})" style="${!b.imageUrl?'background:'+b.bgColor:''}">
        ${b.imageUrl?`<img src="${b.imageUrl}" loading="lazy">`:''}
        ${b.title?`<div class="b-text"><div class="b-title">${b.title}</div>${b.subtitle?`<div class="b-sub">${b.subtitle}</div>`:''}</div>`:''}
      </div>`).join('')}
    </div></div>
    ${banners.length>1?`<div class="bdots" id="bdots">${banners.map((_,i)=>`<div class="bdot ${i===0?'active':''}" onclick="goBanner(${i})"></div>`).join('')}</div>`:''}</div>`;
    startBanner();
  }
  // Featured & New
  const feat = prods.filter(p => p.featured && p.variants?.some(v=>v.inStock));
  const newP  = prods.filter(p => p.isNew   && p.variants?.some(v=>v.inStock));
  if (feat.length) h += `<div class="sec"><div class="sec-hd"><span class="sec-title">â­ Featured</span></div><div class="pstrip">${feat.map(pCard).join('')}</div></div>`;
  if (newP.length) h += `<div class="sec"><div class="sec-hd"><span class="sec-title">âœ¨ New Arrivals</span></div><div class="pstrip">${newP.map(pCard).join('')}</div></div>`;

  // Category grid (Blinkit style)
  if (cats.length) h += `<div class="sec"><div class="sec-hd"><span class="sec-title">Shop by Category</span></div>
    <div class="cat-grid">${cats.map((c,i) =>
      `<div class="cat-card ${getCcBg(i)}" onclick="openFP(${c.id})">
        <div class="cc-img">${c.imageUrl?`<img src="${c.imageUrl}" loading="lazy">`:`<span class="cc-emoji">ğŸ“‚</span>`}</div>
        <div class="cc-name">${c.name}</div>
      </div>`
    ).join('')}</div></div>`;

  // Per-category strips
  cats.forEach(c => {
    const ps = prods.filter(p => p.catId===c.id && p.variants?.some(v=>v.inStock));
    if (!ps.length) return;
    h += `<div class="sec"><div class="sec-hd"><span class="sec-title">${c.name}</span><span class="see-all" onclick="openFP(${c.id})">See all â†’</span></div>
      <div class="pstrip">${ps.slice(0,8).map(pCard).join('')}</div></div>`;
  });

  if (!h) h = '<div class="empty-state" style="margin-top:4rem"><div class="ei">ğŸ›ï¸</div><p>No products yet.</p></div>';
  document.getElementById('home').innerHTML = h;
  document.getElementById('scroll').scrollTop = 0;
}

// â”€â”€ PRODUCT CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pCard(p) {
  const selVid = window._selVariant?.[p.id] || defaultVariant(p)?.id;
  const v = getVariant(p, selVid);
  if (!v) return '';
  const qty = cart[cartKey(p.id, selVid)] || 0;
  const price = getPrice(v.priceTiers, qty || 1);
  const mrp = v.mrp && v.mrp > price ? v.mrp : null;
  const off = offPct(price, mrp);
  const hasMultiVariants = p.variants.length > 1;
  const bulkHint = getBulkHint(v.priceTiers, qty || 1);
  const imgUrl = v.imageUrl || p.imageUrl || '';
  const dropId = 'vdrop_' + p.id;
  const btnId  = 'vbtn_' + p.id;

  // Premium variant button + smooth dropdown (no native select)
  const variantBlock = hasMultiVariants
    ? `<button class="pc-variant-btn" id="${btnId}" onclick="event.stopPropagation();toggleVariantDrop(${p.id},'${dropId}','${btnId}')">
        <span>${v.label}</span>
        <span class="vb-arrow">â–¾</span>
      </button>
      <div class="pc-variant-dropdown" id="${dropId}">
        ${p.variants.map(vv => {
          const vp = getPrice(vv.priceTiers, 1);
          return `<div class="pc-vd-option ${vv.id===selVid?'selected':''}" onclick="event.stopPropagation();pickVariant(${p.id},'${vv.id}','${dropId}','${btnId}')">
            <span>${vv.label}</span>
            <span class="vd-price">â‚¹${vp}</span>
          </div>`;
        }).join('')}
      </div>`
    : `<div class="pc-variant-label">${v.label}</div>`;

  const addCtrl = qty > 0
    ? `<div class="qty-ctrl">
        <button onclick="event.stopPropagation();chQty(${p.id},'${selVid}',-1)">âˆ’</button>
        <span>${qty}</span>
        <button onclick="event.stopPropagation();chQty(${p.id},'${selVid}',1)">+</button>
       </div>`
    : `<button class="add-btn" onclick="event.stopPropagation();chQty(${p.id},'${selVid}',1)">ADD</button>`;

  return `<div class="pcard" data-pid="${p.id}" data-vid="${selVid}" onclick="openProductDetail(${p.id})">
    <div class="pc-img-wrap">
      ${imgUrl ? `<img src="${imgUrl}" loading="lazy">` : '<span style="font-size:2.5rem">ğŸ“¦</span>'}
      ${off > 0 ? `<span class="pc-discount-badge">${off}% OFF</span>` : ''}
      ${p.isNew ? `<span class="pc-new-badge">NEW</span>` : ''}
    </div>
    <div class="pc-body">
      ${variantBlock}
      <div class="pc-name">${p.name}</div>
      <div class="pc-price-row">
        <span class="pc-price">â‚¹${price}</span>
        ${mrp ? `<span class="pc-mrp">â‚¹${mrp}</span><span class="pc-off">${off}% off</span>` : ''}
      </div>
      ${bulkHint ? `<div class="pc-bulk-hint">ğŸ“¦ ${bulkHint}</div>` : ''}
      <div class="pc-bot">${addCtrl}</div>
    </div>
  </div>`;
}

function getBulkHint(tiers, qty) {
  if (!tiers || tiers.length <= 1) return '';
  const sorted = [...tiers].sort((a,b) => a.minQty - b.minQty);
  const curPrice = getPrice(tiers, qty);
  for (const t of sorted) {
    if (t.minQty > qty && t.price < curPrice) return `Buy ${t.minQty}+ @ â‚¹${t.price}`;
  }
  const best = sorted[sorted.length-1];
  if (best.minQty <= 1) return '';
  return `Buy ${best.minQty}+ @ â‚¹${best.price}`;
}

// â”€â”€ VARIANT CHANGE & DROPDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window._selVariant = {};
window._openDropId = null;

// Close any open dropdown
function closeAllDropdowns() {
  if (window._openDropId) {
    const d = document.getElementById(window._openDropId);
    if (d) d.classList.remove('open');
    const b = document.getElementById(window._openDropId.replace('vdrop_','vbtn_'));
    if (b) b.classList.remove('open');
    window._openDropId = null;
  }
}

// Toggle dropdown â€” smooth open/close, NO page re-render, NO scroll
function toggleVariantDrop(pid, dropId, btnId) {
  const drop = document.getElementById(dropId);
  const btn  = document.getElementById(btnId);
  if (!drop) return;
  const isOpen = drop.classList.contains('open');
  closeAllDropdowns();
  if (!isOpen) {
    drop.classList.add('open');
    btn?.classList.add('open');
    window._openDropId = dropId;
  }
}

// User picks a variant from dropdown â€” update in-place, NO full re-render
function pickVariant(pid, vid, dropId, btnId) {
  closeAllDropdowns();
  window._selVariant[pid] = vid;

  // Find the card and update it in-place
  const btnEl  = document.getElementById(btnId);
  const dropEl = document.getElementById(dropId);
  const p = prods.find(x=>x.id===pid);
  if (!p || !btnEl || !dropEl) { reRenderCurrentPage(); return; }
  const v = getVariant(p, vid);
  if (!v) return;

  // Update button label
  btnEl.querySelector('span:first-child').textContent = v.label;

  // Update option highlights
  dropEl.querySelectorAll('.pc-vd-option').forEach(opt => {
    const optVid = opt.getAttribute('onclick')?.match(/'([^']+)'/g)?.[1]?.replace(/'/g,'');
    opt.classList.toggle('selected', optVid === vid);
  });

  // Find the card containing this button and update price/controls in-place
  const card = btnEl.closest('.pcard');
  if (card) {
    card.dataset.vid = vid; // keep data-vid in sync
    updateCardInPlace(card, p, vid);
  }
}

function updateCardInPlace(card, p, vid) {
  const qty   = cart[cartKey(p.id, vid)] || 0;
  const v     = getVariant(p, vid);
  if (!v) return;
  const price = getPrice(v.priceTiers, qty || 1);
  const mrp   = v.mrp && v.mrp > price ? v.mrp : null;
  const off   = offPct(price, mrp);
  const bulkHint = getBulkHint(v.priceTiers, qty || 1);

  // Update price row
  const priceRow = card.querySelector('.pc-price-row');
  if (priceRow) priceRow.innerHTML = `<span class="pc-price">â‚¹${price}</span>${mrp?`<span class="pc-mrp">â‚¹${mrp}</span><span class="pc-off">${off}% off</span>`:''}`;

  // Update bulk hint
  const hintEl = card.querySelector('.pc-bulk-hint');
  if (hintEl) hintEl.textContent = bulkHint ? 'ğŸ“¦ '+bulkHint : '';

  // Update discount badge
  const badge = card.querySelector('.pc-discount-badge');
  if (badge) badge.textContent = off > 0 ? off+'% OFF' : '';

  // Update add/qty control
  const bot = card.querySelector('.pc-bot');
  if (bot) {
    if (qty > 0) {
      bot.innerHTML = `<div class="qty-ctrl"><button onclick="event.stopPropagation();chQty(${p.id},'${vid}',-1)">âˆ’</button><span>${qty}</span><button onclick="event.stopPropagation();chQty(${p.id},'${vid}',1)">+</button></div>`;
    } else {
      bot.innerHTML = `<button class="add-btn" onclick="event.stopPropagation();chQty(${p.id},'${vid}',1)">ADD</button>`;
    }
  }
  // Also update price to reflect new qty-based tier pricing
  const newPrice = getPrice(v.priceTiers, qty || 1);
  const priceEl = card.querySelector('.pc-price');
  if (priceEl) priceEl.textContent = 'â‚¹' + newPrice;

  // Update image if variant has own image
  const img = card.querySelector('.pc-img-wrap img');
  const imgUrl = v.imageUrl || p.imageUrl || '';
  if (img && imgUrl) img.src = imgUrl;
}

function reRenderCurrentPage() {
  const fpOpen = document.getElementById('fpage')?.classList.contains('open');
  if (fpOpen && window._openCatId) renderFPContent(window._openCatId);
  else renderHome();
}

// Legacy â€” no longer called but keep for safety
function onVariantChange(pid, vid) {
  window._selVariant[pid] = vid;
  reRenderCurrentPage();
}

// â”€â”€ OPEN FP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window._openCatId = null;
function openFP(catId) {
  window._openCatId = catId;
  const cat = cats.find(c => c.id === catId);
  document.getElementById('fpTitle').textContent = cat?.name || '';
  renderFPContent(catId);
  document.getElementById('fpage').classList.add('open');
  document.getElementById('searchPage').classList.remove('open');
}
function renderFPContent(catId) {
  const ps = prods.filter(p => p.catId === catId && p.variants?.some(v=>v.inStock));
  document.getElementById('fpGrid').innerHTML = ps.length
    ? ps.map(pCard).join('')
    : '<div class="empty-state"><div class="ei">ğŸ›’</div><p>No products in this category.</p></div>';
}

// â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let searchTimer = null;
function onSearch(q) {
  const clearBtn = document.getElementById('searchClear');
  if (clearBtn) clearBtn.style.display = q ? 'block' : 'none';
  clearTimeout(searchTimer);
  if (!q.trim()) { closeSearch(); return; }
  searchTimer = setTimeout(() => {
    const results = prods.filter(p => p.name.toLowerCase().includes(q.toLowerCase()));
    document.getElementById('searchGrid').innerHTML = results.length
      ? results.map(pCard).join('')
      : `<div class="empty-state" style="grid-column:1/-1"><div class="ei">ğŸ”</div><p>No results for "${q}"</p></div>`;
    document.getElementById('searchPage').classList.add('open');
    document.getElementById('fpage').classList.remove('open');
  }, 200);
}
function clearSearch() {
  const inp = document.getElementById('searchInput');
  if (inp) inp.value = '';
  const clearBtn = document.getElementById('searchClear');
  if (clearBtn) clearBtn.style.display = 'none';
  closeSearch();
  startAnimatedPH();
}

// â”€â”€ PRODUCT DETAIL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openProductDetail(pid) {
  const p = prods.find(x => x.id === pid);
  if (!p) return;
  const selVid = window._selVariant?.[pid] || defaultVariant(p)?.id;
  const v = getVariant(p, selVid);
  if (!v) return;

  const existing = document.getElementById('pdModal');
  if (existing) existing.remove();

  const qty = cart[cartKey(pid, selVid)] || 0;
  const price = getPrice(v.priceTiers, qty || 1);
  const mrp = v.mrp && v.mrp > price ? v.mrp : null;
  const off = offPct(price, mrp);
  const imgUrl = v.imageUrl || p.imageUrl || '';
  const tiers = v.priceTiers || [];
  const sorted = [...tiers].sort((a,b) => a.minQty - b.minQty);

  const tiersHTML = sorted.length > 1 ? `
    <div style="margin-top:12px">
      <div style="font-size:.7rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px">Bulk Pricing</div>
      <div style="background:var(--bg3);border-radius:10px;overflow:hidden;border:1px solid var(--border)">
        ${sorted.map((t,i) => {
          const next = sorted[i+1]?.minQty;
          const label = next ? `${t.minQty}â€“${next-1} units` : `${t.minQty}+ units`;
          const isActive = t.price === price;
          const isBest = i === sorted.length - 1;
          return `<div style="display:flex;justify-content:space-between;align-items:center;padding:9px 12px;border-bottom:1px solid var(--border);${i===sorted.length-1?'border:none':''}${isActive?'background:rgba(45,211,111,.08)':''}">
            <span style="font-size:.82rem;color:${isActive?'var(--green)':'var(--text2)'};">${label}${isBest?` <span style="font-size:.65rem;background:rgba(45,211,111,.15);color:var(--green);padding:1px 5px;border-radius:4px;font-weight:800">BEST</span>`:''}${isActive?` <span style="font-size:.65rem;color:var(--green);font-weight:700">â† current</span>`:''}</span>
            <span style="font-size:.88rem;font-weight:800;color:${isActive?'var(--green)':'var(--text)'};">â‚¹${t.price}/unit</span>
          </div>`;
        }).join('')}
      </div>
    </div>` : '';

  const variantHTML = p.variants.length > 1 ? `
    <div style="margin-top:12px">
      <div style="font-size:.7rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px">Select Variant</div>
      <div style="display:flex;gap:7px;flex-wrap:wrap">
        ${p.variants.map(vv => {
          const vp = getPrice(vv.priceTiers, 1);
          const isActive = vv.id === selVid;
          return `<button onclick="selectDetailVariant(${pid},'${vv.id}')" style="padding:7px 12px;border-radius:9px;font-size:.8rem;font-weight:700;border:1.5px solid ${isActive?'var(--green)':'var(--border)'};background:${isActive?'rgba(45,211,111,.12)':'var(--bg3)'};color:${isActive?'var(--green)':'var(--text2)'};cursor:pointer;">${vv.label} Â· â‚¹${vp}</button>`;
        }).join('')}
      </div>
    </div>` : '';

  const addCtrl = qty > 0
    ? `<div style="display:flex;align-items:center;gap:12px;flex:1">
        <div class="qty-ctrl" style="flex:1;justify-content:space-between;padding:0">
          <button onclick="chQtyModal(${pid},'${selVid}',-1)" style="padding:10px 16px;font-size:1.2rem">âˆ’</button>
          <span style="font-size:1rem">${qty}</span>
          <button onclick="chQtyModal(${pid},'${selVid}',1)" style="padding:10px 16px;font-size:1.2rem">+</button>
        </div>
       </div>`
    : `<button onclick="chQtyModal(${pid},'${selVid}',1)" style="flex:1;background:var(--green);color:#000;border:none;border-radius:12px;padding:14px;font-size:.92rem;font-weight:900;cursor:pointer">+ ADD TO CART</button>`;

  const modal = document.createElement('div');
  modal.id = 'pdModal';
  modal.style.cssText = 'position:fixed;inset:0;z-index:500;display:flex;flex-direction:column;justify-content:flex-end;background:rgba(0,0,0,.7);backdrop-filter:blur(4px)';
  modal.innerHTML = `
    <div style="background:var(--bg2);border-radius:22px 22px 0 0;max-height:88vh;overflow-y:auto;padding-bottom:env(safe-area-inset-bottom,0)">
      <div style="width:40px;height:4px;background:var(--bg5);border-radius:2px;margin:10px auto 0"></div>
      <div style="padding:16px 16px 20px">
        <div style="display:flex;gap:14px;margin-bottom:14px">
          <div style="width:100px;height:100px;border-radius:14px;background:var(--bg3);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;border:1px solid var(--border)">
            ${imgUrl ? `<img src="${imgUrl}" style="width:100%;height:100%;object-fit:contain;padding:6px">` : '<span style="font-size:2.5rem">ğŸ“¦</span>'}
          </div>
          <div style="flex:1;min-width:0">
            ${p.isNew ? '<div style="display:inline-block;font-size:.65rem;font-weight:800;padding:2px 7px;border-radius:20px;background:#3b82f6;color:#fff;margin-bottom:5px">NEW ARRIVAL</div>' : ''}
            <div style="font-size:1rem;font-weight:800;line-height:1.3;margin-bottom:4px">${p.name}</div>
            <div style="font-size:.8rem;color:var(--text3);margin-bottom:8px">${v.label}</div>
            <div style="display:flex;align-items:baseline;gap:6px;flex-wrap:wrap">
              <span style="font-size:1.3rem;font-weight:900">â‚¹${price}</span>
              ${mrp ? `<span style="font-size:.85rem;color:var(--text3);text-decoration:line-through">â‚¹${mrp}</span><span style="font-size:.75rem;background:rgba(255,71,87,.15);color:var(--red);padding:2px 6px;border-radius:4px;font-weight:800">${off}% off</span>` : ''}
            </div>
            
          </div>
        </div>
        ${variantHTML}
        ${tiersHTML}
        <div style="display:flex;gap:10px;margin-top:16px;align-items:center">
          ${addCtrl}
        </div>
      </div>
    </div>`;
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
  document.body.appendChild(modal);
}

function selectDetailVariant(pid, vid) {
  window._selVariant[pid] = vid;
  document.getElementById('pdModal')?.remove();
  openProductDetail(pid);
  // Also refresh home/page
  const fpOpen = document.getElementById('fpage')?.classList.contains('open');
  if (fpOpen && window._openCatId) renderFPContent(window._openCatId);
  else renderHome();
}

function chQtyModal(pid, vid, delta) {
  chQty(pid, vid, delta);
  document.getElementById('pdModal')?.remove();
  openProductDetail(pid);
}

// â”€â”€ CART OPERATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function chQty(pid, vid, delta) {
  const key = cartKey(pid, vid);
  const cur = cart[key] || 0;
  const nw = Math.max(0, cur + delta);
  if (nw === 0) delete cart[key]; else cart[key] = nw;
  updateCart();

  // Update card in-place (no scroll, no full re-render)
  const p = prods.find(x=>x.id===pid);
  if (p) {
    // Find all cards by data-pid + data-vid (reliable, no CSS attr selector issues)
    document.querySelectorAll(`.pcard[data-pid="${pid}"][data-vid="${vid}"]`).forEach(card => {
      updateCardInPlace(card, p, vid);
    });
    // Fallback: any card whose innerHTML references this pid+vid
    document.querySelectorAll('.pcard:not([data-pid])').forEach(card => {
      if (card.innerHTML.includes("chQty("+pid+",'"+vid+"'")) updateCardInPlace(card, p, vid);
    });
  }

  // Bounce pill
  const fc = document.getElementById('fcart');
  if (delta > 0) { fc.classList.add('bounce'); setTimeout(() => fc.classList.remove('bounce'), 500); }
}

function itemsTotal() {
  return Object.entries(cart).reduce((s, [k, qty]) => {
    const { pid, vid } = parseKey(k);
    const p = prods.find(x => x.id === pid);
    if (!p) return s;
    const v = getVariant(p, vid);
    if (!v) return s;
    return s + getPrice(v.priceTiers, qty) * qty;
  }, 0);
}

function giftCfg() {
  const fg = settings.freeGift;
  if (!fg || !fg.threshold) return null;
  const p = prods.find(x => x.id === fg.productId);
  if (!p) return null;
  const v = fg.variantId ? getVariant(p, fg.variantId) : defaultVariant(p);
  return { ...fg, prod: p, variant: v, isFree: fg.discountPrice === 0 };
}

function total() {
  const base = itemsTotal();
  const cfg = giftCfg();
  const giftCharge = (giftState.injected && cfg && cfg.discountPrice > 0) ? cfg.discountPrice * (cfg.qty || 1) : 0;
  return base + giftCharge;
}

function count() { return Object.values(cart).reduce((a,b) => a+b, 0); }

function updateCart() {
  evaluateGift();
  const n = count(), t = total();
  const badge = document.getElementById('cartBadge');
  badge.style.display = n > 0 ? 'flex' : 'none';
  badge.textContent = n;
  const fc = document.getElementById('fcart');
  fc.classList.toggle('show', n > 0);
  document.getElementById('fcCnt').textContent = n + (n===1?' item':' items');
  document.getElementById('fcAmt').textContent = 'â‚¹' + t;
}

function evaluateGift() {
  const cfg = giftCfg();
  if (!cfg || !cfg.threshold) { if (giftState.injected) { giftState.injected=false; giftState.claimed=false; } return; }
  const t = itemsTotal();
  const unlocked = t >= cfg.threshold;
  if (cfg.autoAdd) {
    if (unlocked && !giftState.injected) { giftState.injected=true; giftState.claimed=true; if (!giftState.prevUnlocked) { giftState.prevUnlocked=true; _celebrateGift(cfg); } }
    else if (!unlocked && giftState.injected) { giftState.injected=false; giftState.claimed=false; giftState.prevUnlocked=false; }
  } else {
    if (!unlocked && giftState.injected) { giftState.injected=false; giftState.claimed=false; }
    if (unlocked && !giftState.prevUnlocked) { giftState.prevUnlocked=true; showToast('ğŸ Tap to claim your free gift!'); }
    if (!unlocked) giftState.prevUnlocked=false;
  }
}
function _celebrateGift(cfg) { fireConfetti(); showToast(cfg.isFree ? `ğŸ ${cfg.label||'Free Gift'} added FREE!` : `ğŸ”¥ ${cfg.label} added at â‚¹${cfg.discountPrice}!`); }
function claimGift() { const cfg=giftCfg(); if(!cfg||giftState.injected) return; giftState.injected=true; giftState.claimed=true; _celebrateGift(cfg); renderCart(); }
function removeGift() { giftState.injected=false; giftState.claimed=false; giftState.prevUnlocked=false; updateCart(); renderCart(); showToast('Offer removed'); }

// â”€â”€ CART DRAWER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCart() {
  if (!count()) { showToast('Your cart is empty'); return; }
  renderCart();
  document.getElementById('cartOverlay').classList.add('open');
  document.getElementById('cartDrawer').classList.add('open');
  document.querySelector('.bnav').style.display='none';
}
function closeCart() {
  document.getElementById('cartOverlay').classList.remove('open');
  document.getElementById('cartDrawer').classList.remove('open');
  document.querySelector('.bnav').style.display='';
}

function renderCart() {
  evaluateGift();
  const cfg = giftCfg();
  const items = Object.entries(cart).map(([k,qty]) => {
    const { pid, vid } = parseKey(k);
    const p = prods.find(x => x.id===pid);
    const v = p ? getVariant(p, vid) : null;
    return p && v ? { p, v, vid, qty, key:k } : null;
  }).filter(Boolean);
  const hasGift = giftState.injected && cfg;

  if (!items.length && !hasGift) {
    document.getElementById('cartBody').innerHTML=`<div style="text-align:center;padding:50px 20px"><div style="font-size:3rem;margin-bottom:10px">ğŸ›’</div><div style="font-weight:900;margin-bottom:6px">Cart is empty</div><div style="color:var(--text3);font-size:.8rem;margin-bottom:18px">Add something to get started</div><button onclick="closeCart()" style="background:var(--green);color:#000;border:none;border-radius:10px;padding:10px 20px;font-weight:800;font-size:.85rem;">Browse items</button></div>`;
    document.getElementById('cartFoot').innerHTML='';
    return;
  }

  const t = total(), itemsT = itemsTotal();
  const fdMin = settings.freeDeliveryMin || settings.minOrder || 99;
  const fdUnlocked = t >= fdMin;
  const n = count();
  if (fdUnlocked && !window._fdUnlocked) { window._fdUnlocked=true; fireConfetti(); showToast('ğŸ‰ Free delivery unlocked!'); }
  if (!fdUnlocked) window._fdUnlocked=false;

  document.getElementById('cartHdCount').textContent = n + ' item' + (n!==1?'s':'');

  // Items
  const regularHTML = items.map(({ p, v, vid, qty, key }) => {
    const pr = getPrice(v.priceTiers, qty);
    const coach = getBulkCoach(v.priceTiers, qty);
    const imgUrl = v.imageUrl || p.imageUrl || '';
    return `<div class="ci">
      <div class="ci-img">${imgUrl?`<img src="${imgUrl}">`:'<span style="font-size:1.5rem">ğŸ“¦</span>'}</div>
      <div class="ci-info">
        <div class="ci-name">${p.name}</div>
        <div class="ci-meta">${v.label}</div>
        <div class="ci-price-row">
          <span class="ci-total">â‚¹${pr*qty}</span>
          <span class="ci-each">${qty}Ã—â‚¹${pr}</span>
        </div>
        ${coach ? `<div class="tier-coach">â¬† ${coach}</div>` : ''}
      </div>
      <div class="ci-ctrl">
        <button onclick="chQtyCart('${key}',-1)">âˆ’</button>
        <span>${qty}</span>
        <button onclick="chQtyCart('${key}',1)">+</button>
      </div>
    </div>`;
  }).join('');

  // Gift item
  const giftHTML = hasGift ? (() => {
    const gp = cfg.prod, gv = cfg.variant;
    const origPrice = getPrice(gv?.priceTiers || gp.variants?.[0]?.priceTiers || [], 1);
    const offerPrice = cfg.discountPrice;
    const imgUrl = gv?.imageUrl || gp.imageUrl || '';
    const isFree = offerPrice === 0;
    return `<div class="ci ci-gift">
      <div class="ci-img">${imgUrl?`<img src="${imgUrl}">`:'<span style="font-size:1.5rem">ğŸ</span>'}</div>
      <div class="ci-info">
        <div class="ci-name">${gp.name}</div>
        <div class="ci-meta">${gv?.label||''}</div>
        <div class="ci-price-row">
          <span class="ci-gift-price">${isFree?'FREE':'â‚¹'+offerPrice}</span>
          ${origPrice > offerPrice ? `<span class="ci-gift-original">â‚¹${origPrice}</span>` : ''}
        </div>
        <span class="ci-gift-badge">${isFree?'ğŸ FREE GIFT':'ğŸ”¥ SPECIAL OFFER'}</span>
      </div>
      <button class="ci-gift-remove" onclick="removeGift()">âœ•</button>
    </div>`;
  })() : '';

  document.getElementById('cartBody').innerHTML = regularHTML + giftHTML;

  // Upsell
  const upsellIds = (settings.upsellProductIds||[]).map(Number);
  const upsells = upsellIds.map(id => prods.find(p=>p.id===id)).filter(p => {
    if (!p) return false;
    const dv = defaultVariant(p);
    return dv?.inStock && !cart[cartKey(p.id, dv.id)];
  });
  const upsellHTML = upsells.length ? `<div class="upsell-wrap">
    <div class="upsell-label">âš¡ You may also need</div>
    <div class="upsell-scroll">${upsells.map(p => {
      const dv = defaultVariant(p);
      const pr = getPrice(dv.priceTiers, 1);
      const imgUrl = dv.imageUrl || p.imageUrl || '';
      return `<div class="upsell-card">
        <div class="upsell-card-img">${imgUrl?`<img src="${imgUrl}">`:'<span style="font-size:1.1rem">ğŸ“¦</span>'}</div>
        <div class="upsell-card-name">${p.name}</div>
        <div class="upsell-card-price">â‚¹${pr}</div>
        <button class="upsell-add-btn" id="uadd${p.id}" onclick="upsellAdd(${p.id})">+ Add</button>
      </div>`;
    }).join('')}</div></div>` : '';

  // Free delivery bar
  const fdPct = Math.min(100, Math.round(t/fdMin*100));
  const fdBarHTML = fdUnlocked
    ? `<div class="fd-wrap"><div class="fd-header"><span class="fd-label unlocked">ğŸšš Free delivery unlocked!</span></div><div class="fd-track"><div class="fd-fill unlocked" style="width:100%"></div></div></div>`
    : `<div class="fd-wrap"><div class="fd-header"><span class="fd-label pending">Add <em>â‚¹${fdMin-t}</em> for free delivery</span><span class="fd-pct">${fdPct}%</span></div><div class="fd-track"><div class="fd-fill pending" style="width:${fdPct}%"></div></div></div>`;

  // Gift bar
  const giftBarHTML = _buildGiftUI(itemsT, cfg);

  // Savings
  let savedAmt = 0;
  items.forEach(({p,v,qty}) => {
    const base = (v.priceTiers?.[0]?.price || 0);
    const mrp2 = v.mrp && v.mrp > base ? v.mrp : base;
    savedAmt += (mrp2 - getPrice(v.priceTiers,qty)) * qty;
  });
  const savingsHTML = savedAmt > 0 ? `<div style="padding:8px 16px 0"><div class="savings-strip">ğŸ‰ Saving <strong style="margin:0 3px">â‚¹${savedAmt}</strong> on this order!</div></div>` : '';

  document.getElementById('cartFoot').innerHTML = `
    ${upsellHTML}${fdBarHTML}${giftBarHTML}${savingsHTML}
    <div class="cart-cta-bar">
      <button class="cart-cta-btn" onclick="openCkoPage()">
        <span>Proceed to Checkout</span>
        <span class="cart-cta-total">â‚¹${t}</span>
      </button>
    </div>`;
}

function getBulkCoach(tiers, qty) {
  if (!tiers || tiers.length <= 1) return '';
  const sorted = [...tiers].sort((a,b) => a.minQty-b.minQty);
  const curPrice = getPrice(tiers, qty);
  for (const t of sorted) { if (t.minQty > qty && t.price < curPrice) return `Buy ${t.minQty-qty} more â†’ â‚¹${t.price} each ğŸ”¥`; }
  return '';
}

function chQtyCart(key, delta) {
  const cur = cart[key] || 0;
  const nw = Math.max(0, cur + delta);
  if (nw===0) delete cart[key]; else cart[key]=nw;
  updateCart(); renderCart();
  const { pid, vid } = parseKey(key);
  if (document.getElementById('fpage')?.classList.contains('open') && window._openCatId) renderFPContent(window._openCatId);
  else renderHome();
}

function upsellAdd(id) {
  const p = prods.find(x=>x.id===id); if(!p) return;
  const dv = defaultVariant(p); if(!dv) return;
  const key = cartKey(id, dv.id);
  cart[key] = (cart[key]||0)+1;
  updateCart(); renderCart();
  const btn = document.getElementById('uadd'+id);
  if (btn) { btn.textContent='âœ“ Added'; btn.classList.add('added'); btn.onclick=null; }
}

function _buildGiftUI(cartTotal, cfg) {
  if (!cfg || !cfg.threshold) return '';
  const threshold=cfg.threshold, unlocked=cartTotal>=threshold;
  const pct=Math.min(100,Math.round(cartTotal/threshold*100));
  const remaining=threshold-cartTotal;
  const near=pct>=70 && !unlocked;
  const offerPrice=cfg.discountPrice, isFree=offerPrice===0;
  const pillText=isFree?'FREE':`â‚¹${offerPrice}`;
  const bannerEmoji=isFree?'ğŸ':'ğŸ”¥';
  const progressTitle=isFree
    ?`Add <em>â‚¹${remaining}</em> more â€” get <em>${cfg.label||'free gift'}</em> FREE`
    :`Add <em>â‚¹${remaining}</em> more â€” get <em>${cfg.label}</em> at just <em>â‚¹${offerPrice}</em>`;
  if (unlocked) return `<div class="fd-wrap" style="padding-top:8px">
    <div class="gift-unlocked-banner">
      <div class="gift-unlocked-icon">${bannerEmoji}</div>
      <div class="gift-unlocked-body">
        <div class="gift-unlocked-title">${cfg.label||cfg.prod?.name} ${isFree?'â€” Free!':'â€” â‚¹'+offerPrice+'!'}</div>
        <div class="gift-unlocked-sub">${cfg.autoAdd?(isFree?'Auto-added to cart':'Added at â‚¹'+offerPrice):(giftState.claimed?'Claimed':'Tap to claim')}</div>
      </div>
      <span class="gift-free-pill">${pillText}</span>
    </div>
    ${!cfg.autoAdd && !giftState.injected?`<button class="gift-claim-btn" onclick="claimGift()">${isFree?'ğŸ Claim Free Gift':'ğŸ”¥ Claim at â‚¹'+offerPrice}</button>`:''}
  </div>`;
  return `<div class="fd-wrap" style="padding-top:8px">
    <div class="gift-progress-card${near?' near':''}">
      <div class="gift-progress-header">
        <div style="font-size:1.3rem">${bannerEmoji}</div>
        <div class="gift-progress-text">
          <div class="gift-progress-title">${progressTitle}</div>
          <div class="gift-progress-remaining">â‚¹${cartTotal} of â‚¹${threshold} Â· ${pct}%</div>
        </div>
      </div>
      <div class="gift-progress-bar-track"><div class="gift-progress-bar-fill" style="width:${pct}%"></div></div>
    </div>
  </div>`;
}

// â”€â”€ CHECKOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const UD_KEY='bsc_ud_v1';
function loadUD() { try{return JSON.parse(localStorage.getItem(UD_KEY))||{};}catch{return{};} }
function saveUD(d) { try{localStorage.setItem(UD_KEY,JSON.stringify(d));}catch{} }

function openCkoPage() {
  renderCkoPage();
  document.getElementById('ckoPage').classList.add('open');
  document.querySelector('.bnav').style.display='none';
  closeCart();
}
function closeCkoPage() {
  document.getElementById('ckoPage').classList.remove('open');
  document.querySelector('.bnav').style.display='';
}

function renderCkoPage() {
  const t=total(), ud=loadUD(), fdMin=settings.freeDeliveryMin||settings.minOrder||99, fdUnlocked=t>=fdMin;
  document.getElementById('ckoTopSub').textContent = Object.keys(cart).length + ' items Â· â‚¹' + t;
  document.getElementById('ckPlaceAmt').textContent = 'â‚¹' + t;

  const hasAddr = ud.name && ud.phone && ud.block && ud.villa;
  const dlvCardHTML = `<div class="ck-dlv-card ${hasAddr?'has-data':''} ${!hasAddr?'editing':''}" id="ckDlvCard">
    <div class="ck-dlv-collapsed" onclick="ckToggleDlv()">
      <div class="ck-dlv-addr-icon">ğŸ“</div>
      <div class="ck-dlv-addr-body">
        <div class="ck-dlv-addr-line1">${hasAddr?`Block ${ud.block} Â· Villa ${ud.villa}`:'Add delivery address'}</div>
        <div class="ck-dlv-addr-line2">${hasAddr?`${ud.name} Â· ${ud.phone}`:'Tap to fill details'}</div>
      </div>
      ${hasAddr?`<button class="ck-dlv-change" onclick="event.stopPropagation();ckOpenDlv()">Change</button>`:''}
    </div>
    <div class="ck-dlv-form"><div class="ck-dlv-form-inner">${_ckDlvFields(ud)}</div></div>
  </div>`;

  // Payment methods â€” no COD, login required
  const acctTok = getMilkToken();
  if (!acctTok) {
    document.getElementById('ckoBody').innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:50px 24px;text-align:center;gap:16px">
        <div style="font-size:2.5rem">ğŸ”’</div>
        <div style="font-size:1rem;font-weight:800">Login Required</div>
        <div style="font-size:.82rem;color:var(--text3);line-height:1.6">You need to be logged in to place an order.<br>Login or create your BSC account to continue.</div>
        <button onclick="closeCkoPage();openMilkPage()" style="background:var(--green);color:#000;border-radius:12px;padding:.8rem 2rem;font-size:.9rem;font-weight:800;border:none;cursor:pointer;margin-top:8px">Login / Create Account</button>
      </div>`;
    document.getElementById('ckPlaceBtn').style.display = 'none';
    return;
  }
  document.getElementById('ckPlaceBtn').style.display = '';
  const selPay = window._payMethod === 'cod' ? 'upi' : (window._payMethod || 'upi');
  window._payMethod = selPay;
  const payMethods = [
    { id:'upi',  icon:'ğŸ“±', title:'UPI Payment', sub: settings.upiId || 'Pay via UPI' },
    { id:'account', icon:'ğŸ“’', title:'Add to Account', sub: 'Charged to your BSC khata' },
  ];
  const payHTML = `<div class="ck-pay-cards">${payMethods.map(m => `
    <div class="ck-pay-card ${m.id===selPay?'selected':''}" data-pay="${m.id}" onclick="ckSelectPay('${m.id}')">
      <div class="ck-pay-card-icon">${m.icon}</div>
      <div class="ck-pay-card-body">
        <div class="ck-pay-card-title">${m.title}</div>
        <div class="ck-pay-card-sub">${m.sub}</div>
      </div>
      <div class="ck-pay-radio"></div>
    </div>`).join('')}</div>`;

  // Build price breakdown for summary
  const cfg = giftCfg();
  const giftCharge = giftState.injected && cfg && cfg.discountPrice > 0 ? cfg.discountPrice*(cfg.qty||1) : 0;
  const cartItems = Object.entries(cart).map(([k,qty]) => {
    const { pid, vid } = parseKey(k);
    const p = prods.find(x=>x.id===pid);
    const v = p ? getVariant(p,vid) : null;
    return p&&v ? { p, v, qty } : null;
  }).filter(Boolean);

  // Calculate MRP total (base price tier 1 or mrp field)
  let mrpTotal = 0, sellingTotal = 0, discountTotal = 0;
  cartItems.forEach(({ p, v, qty }) => {
    const selPrice = getPrice(v.priceTiers, qty);
    const mrpPrice = v.mrp && v.mrp > selPrice ? v.mrp : (v.priceTiers?.[0]?.price || selPrice);
    mrpTotal += mrpPrice * qty;
    sellingTotal += selPrice * qty;
    discountTotal += (mrpPrice - selPrice) * qty;
  });
  const totalItems = cartItems.reduce((s,{qty})=>s+qty,0);

  // Build clean breakdown rows
  let sumRows = '';
  sumRows += `<div class="ck-sum-row"><span>MRP (${totalItems} item${totalItems!==1?'s':''})</span><span>â‚¹${mrpTotal.toFixed(0)}</span></div>`;
  if (discountTotal > 0) {
    sumRows += `<div class="ck-sum-row ck-row-save"><span>Product discount</span><span>âˆ’â‚¹${discountTotal.toFixed(0)}</span></div>`;
  }
  if (giftState.injected && cfg) {
    if (cfg.discountPrice === 0) {
      sumRows += `<div class="ck-sum-row ck-row-save"><span>ğŸ ${cfg.label||'Free gift'}</span><span>FREE</span></div>`;
    } else {
      sumRows += `<div class="ck-sum-row ck-row-gift"><span>ğŸ”¥ ${cfg.label} (offer)</span><span>+â‚¹${giftCharge.toFixed(0)}</span></div>`;
    }
  }
  sumRows += `<div class="ck-sum-row ${fdUnlocked?'ck-row-free':''}"><span>Delivery</span><span>${fdUnlocked?'FREE âœ“':'Paid on delivery'}</span></div>`;
  sumRows += `<div class="ck-sum-divider"></div>`;
  const finalTotal = sellingTotal + giftCharge;
  sumRows += `<div class="ck-sum-total"><span>Total to Pay</span><span class="ck-sum-total-num">â‚¹${finalTotal.toFixed(0)}</span></div>`;
  if (discountTotal > 0) {
    sumRows += `<div style="margin-top:8px;background:rgba(45,211,111,.07);border:1px solid rgba(45,211,111,.15);border-radius:10px;padding:8px 10px;font-size:.75rem;font-weight:700;color:var(--green);text-align:center">ğŸ‰ You save â‚¹${discountTotal.toFixed(0)} on this order!</div>`;
  }

  const summaryHTML = `<div class="ck-sum-box">${sumRows}</div>`;

  document.getElementById('ckoBody').innerHTML = `
    <div class="cko-section"><div class="cko-sec-label">Delivery address</div>${dlvCardHTML}</div>
    <div class="cko-section" style="padding-top:14px"><div class="cko-sec-label">Payment method</div>${payHTML}</div>
    <div class="cko-section" style="padding-top:14px"><div class="cko-sec-label">Order summary</div>${summaryHTML}</div>`;
}

function _ckDlvFields(ud) {
  return `<div class="ck-field-row">
    <div class="ck-field"><label class="ck-label">Name</label><input class="ck-inp" id="ckName" placeholder="Your name" value="${ud.name||''}"></div>
    <div class="ck-field"><label class="ck-label">Phone</label><input class="ck-inp" type="tel" id="ckPhone" placeholder="10-digit" maxlength="10" value="${ud.phone||''}"></div>
  </div>
  <div class="ck-field-row">
    <div class="ck-field"><label class="ck-label">Block</label><select class="ck-inp" id="ckBlock"><option value="">Select</option>${['A','B','C','D','E','F'].map(b=>`<option ${ud.block===b?'selected':''}>${b}</option>`).join('')}</select></div>
    <div class="ck-field"><label class="ck-label">Villa No.</label><input class="ck-inp" id="ckVilla" placeholder="e.g. 42" value="${ud.villa||''}"></div>
  </div>
  <div class="ck-field" style="margin-bottom:10px"><label class="ck-label">Note (optional)</label><input class="ck-inp" id="ckNote" placeholder="Leave at door, etc." value="${ud.note||''}"></div>
  <button class="ck-save-btn" onclick="ckSaveDlv()">âœ“ Save address</button>`;
}

function ckToggleDlv() { document.getElementById('ckDlvCard')?.classList.toggle('editing'); }
function ckOpenDlv() { document.getElementById('ckDlvCard')?.classList.add('editing'); }
function ckSaveDlv() {
  const name=(document.getElementById('ckName')?.value||'').trim();
  const phone=(document.getElementById('ckPhone')?.value||'').trim();
  const block=document.getElementById('ckBlock')?.value||'';
  const villa=(document.getElementById('ckVilla')?.value||'').trim();
  const note=(document.getElementById('ckNote')?.value||'').trim();
  if (!name) { showToast('âš ï¸ Enter your name'); return; }
  if (!phone||phone.length<10) { showToast('âš ï¸ Valid phone required'); return; }
  if (!block) { showToast('âš ï¸ Select block'); return; }
  if (!villa) { showToast('âš ï¸ Enter villa number'); return; }
  saveUD({name,phone,block,villa,note});
  const card=document.getElementById('ckDlvCard');
  if (card) {
    card.querySelector('.ck-dlv-collapsed').innerHTML=`<div class="ck-dlv-addr-icon">ğŸ“</div><div class="ck-dlv-addr-body"><div class="ck-dlv-addr-line1">Block ${block} Â· Villa ${villa}</div><div class="ck-dlv-addr-line2">${name} Â· ${phone}</div></div><button class="ck-dlv-change" onclick="event.stopPropagation();ckOpenDlv()">Change</button>`;
    card.classList.add('has-data'); card.classList.remove('editing');
  }
  showToast('âœ“ Address saved');
}

function ckSelectPay(method) {
  if (method === 'account' && !getMilkToken()) {
    showToast('Login to your account first to use this option');
    return;
  }
  window._payMethod=method;
  document.querySelectorAll('.ck-pay-card').forEach(c=>c.classList.toggle('selected',c.dataset.pay===method));
}

function ckoValidate() {
  const ud=loadUD(); const card=document.getElementById('ckDlvCard');
  if (!card?.classList.contains('editing') && ud.name&&ud.phone&&ud.block&&ud.villa) return ud;
  const name=(document.getElementById('ckName')?.value||'').trim();
  const phone=(document.getElementById('ckPhone')?.value||'').trim();
  const block=document.getElementById('ckBlock')?.value||'';
  const villa=(document.getElementById('ckVilla')?.value||'').trim();
  const note=(document.getElementById('ckNote')?.value||'').trim();
  if (!name){showToast('âš ï¸ Enter name');ckOpenDlv();return null;}
  if (!phone||phone.length<10){showToast('âš ï¸ Valid phone');ckOpenDlv();return null;}
  if (!block){showToast('âš ï¸ Select block');ckOpenDlv();return null;}
  if (!villa){showToast('âš ï¸ Enter villa');ckOpenDlv();return null;}
  saveUD({name,phone,block,villa,note}); return {name,phone,block,villa,note};
}

function ckoPlace() {
  if (!getMilkToken()) { showToast('Please login first'); return; }
  const method=window._payMethod||'upi';
  if (method==='upi' && settings.upiId?.trim()) {
    const d=ckoValidate(); if(!d) return;
    window.location.href=`upi://pay?pa=${settings.upiId}&pn=${encodeURIComponent(settings.storeName||'BSC Store')}&am=${total()}&cu=INR&tn=BSC+Order`;
    setTimeout(()=>_doPlaceOrder(method),800); return;
  }
  _doPlaceOrder(method);
}

function _doPlaceOrder(method) {
  const d=ckoValidate(); if(!d) return;
  const t=total();
  const items=Object.entries(cart).map(([k,qty]) => {
    const { pid, vid } = parseKey(k);
    const p=prods.find(x=>x.id===pid); const v=p?getVariant(p,vid):null;
    return p&&v ? { productId:p.id, variantId:vid, name:p.name, variant:v.label, qty, price:getPrice(v.priceTiers,qty) } : null;
  }).filter(Boolean);

  const cfg=giftCfg();
  if (giftState.injected && cfg) {
    items.push({ productId:cfg.productId, variantId:cfg.variantId||'v1', name:cfg.prod.name, variant:cfg.variant?.label||'', qty:cfg.qty||1, price:cfg.discountPrice||0, isFreeGift:true, isOffer:cfg.discountPrice>0 });
  }
  const freeGiftLabel=(giftState.injected&&cfg)?(cfg.label||cfg.prod.name):null;

  // WhatsApp notification
  const wa=settings.whatsapp||'';
  if (wa) {
    const lineItems=items.filter(i=>!i.isFreeGift).map(i=>`  â€¢ ${i.name}${i.variant?' ('+i.variant+')':''} Ã— ${i.qty} = â‚¹${i.price*i.qty}`).join('\n');
    const payLabel = method==='account'?'Add to Account (Khata)':'UPI Payment';
    let msg=`ğŸ›’ *New Order â€” ${settings.storeName||'BSC Store'}*\n\nğŸ‘¤ *${d.name}*\nğŸ“ ${d.phone}\nğŸ“ Block ${d.block}, Villa ${d.villa}${d.note?'\nğŸ“ '+d.note:''}\n\nğŸ“¦ *Items:*\n${lineItems}\n\n${freeGiftLabel?`ğŸ Free Gift: ${freeGiftLabel}\n\n`:''}ğŸ’° *Total: â‚¹${t}*\nğŸ’³ Payment: ${payLabel}${method==='account'?' (added to khata)':''}\n\n_Sent from BSC Store App_`;
    setTimeout(()=>{ window.open('https://wa.me/'+wa+'?text='+encodeURIComponent(msg),'_blank'); },300);
  }

  fetch('/api/orders',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({customerName:d.name,phone:d.phone,block:d.block,villa:d.villa,note:d.note,items,total:t,freeGift:freeGiftLabel,paymentMethod:method})})
  .then(r=>r.json())
  .then(resp=>{
    cart={}; giftState={injected:false,claimed:false,prevUnlocked:false}; window._fdUnlocked=false;
    closeCkoPage();
    // Refresh account data if logged in (so passbook is up to date)
    if (method==='account') { _accData=null; }
    const addedToAcc = resp?.order?.addedToAccount;
    const accMsg = addedToAcc ? '<br><span style="color:#4ade80;font-size:.78rem">âœ“ Added to your account khata</span>' : '';
    document.getElementById('successMsg').innerHTML=`Order for <strong>${d.name}</strong> placed!<br>Block ${d.block}, Villa ${d.villa} Â· â‚¹${t}<br>We'll deliver soon ğŸš€${accMsg}`;
    document.getElementById('success').classList.add('show');
    updateCart(); renderHome();
  }).catch(()=>showToast('Error placing order. Try again.'));
}

function closeSuccess() { document.getElementById('success').classList.remove('show'); }

// â”€â”€ ACCOUNT PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openMilkPage() {
  setNav('bn3');
  document.getElementById('milkPage').classList.add('open');
  renderAccount();
}
function closeMilkPage() {
  document.getElementById('milkPage').classList.remove('open');
  setNav('bn0');
}

const MILK_KEY='bsc_milk_tok';
function getMilkToken() { try{return localStorage.getItem(MILK_KEY);}catch{return null;} }
function setMilkToken(t) { try{localStorage.setItem(MILK_KEY,t);}catch{} }
function clearMilkToken() { try{localStorage.removeItem(MILK_KEY);}catch{} }

// Central entry point
async function renderAccount() {
  const tok = getMilkToken();
  if (!tok) { renderAccountAuth(); return; }
  // Verify token and load profile
  const body = document.getElementById('milkBody');
  body.innerHTML = '<div style="text-align:center;padding:60px;color:var(--text3)">Loading...</div>';
  try {
    const r = await fetch('/api/customer/dashboard', { headers: { Authorization: 'Bearer ' + tok } });
    if (!r.ok) { clearMilkToken(); renderAccountAuth(); return; }
    const data = await r.json();
    renderAccountHome(data);
  } catch { body.innerHTML='<div class="empty-state"><div class="ei">âš ï¸</div><p>Cannot connect to server</p></div>'; }
}

// â”€â”€ AUTH SCREEN (Login + Create Account) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _authMode = 'login'; // 'login' | 'create'

function renderAccountAuth() {
  document.getElementById('accTopTitle').textContent = 'My Account';
  document.getElementById('accTopSub').textContent = 'BSC Store';
  _authMode = 'login';
  renderAuthScreen();
}

function renderAuthScreen() {
  const isCreate = _authMode === 'create';
  document.getElementById('milkBody').innerHTML = `
    <div style="min-height:100vh;display:flex;flex-direction:column;padding:0 0 80px">

      <!-- Hero -->
      <div style="background:linear-gradient(160deg,#0d2218 0%,#0a0a0a 60%);padding:40px 24px 32px;position:relative;overflow:hidden;flex-shrink:0">
        <div style="position:absolute;top:-40px;right:-40px;width:180px;height:180px;background:radial-gradient(circle,rgba(45,211,111,.12),transparent 70%);pointer-events:none"></div>
        <div style="position:absolute;bottom:-20px;left:-20px;width:120px;height:120px;background:radial-gradient(circle,rgba(45,211,111,.06),transparent 70%);pointer-events:none"></div>
        <div style="width:64px;height:64px;border-radius:20px;background:rgba(45,211,111,.12);border:1px solid rgba(45,211,111,.2);display:flex;align-items:center;justify-content:center;font-size:1.8rem;margin-bottom:16px">ğŸ‘¤</div>
        <div style="font-size:1.4rem;font-weight:900;color:#fff;margin-bottom:6px">${isCreate ? 'Create Account' : 'Welcome Back'}</div>
        <div style="font-size:.8rem;color:rgba(255,255,255,.4);line-height:1.6">${isCreate ? 'Set up your BSC Store account\nto track orders & balance' : 'Login with your phone & 4-digit PIN\nto view your account'}</div>
      </div>

      <!-- Toggle tabs -->
      <div style="display:flex;gap:0;margin:0;border-bottom:1px solid var(--border);flex-shrink:0">
        <div onclick="_authMode='login';renderAuthScreen()" style="flex:1;padding:13px;text-align:center;font-size:.85rem;font-weight:700;cursor:pointer;color:${!isCreate?'var(--green)':'var(--text3)'};border-bottom:2.5px solid ${!isCreate?'var(--green)':'transparent'};transition:all .18s">Login</div>
        <div onclick="_authMode='create';renderAuthScreen()" style="flex:1;padding:13px;text-align:center;font-size:.85rem;font-weight:700;cursor:pointer;color:${isCreate?'var(--green)':'var(--text3)'};border-bottom:2.5px solid ${isCreate?'var(--green)':'transparent'};transition:all .18s">Create Account</div>
      </div>

      <!-- Form -->
      <div style="padding:24px 20px;flex:1">
        ${isCreate ? `
          <div class="acc-field"><label class="acc-label">Full Name</label><input class="acc-inp" id="afName" placeholder="Your name" autocomplete="name"></div>
          <div class="acc-field"><label class="acc-label">Phone Number</label><input class="acc-inp" type="tel" id="afPhone" placeholder="10-digit mobile number" maxlength="10" inputmode="numeric"></div>
          <div class="acc-field"><label class="acc-label">Address (optional)</label><input class="acc-inp" id="afAddr" placeholder="Block & Villa e.g. A-14"></div>
          <div class="acc-field">
            <label class="acc-label">Set 4-Digit PIN</label>
            <div class="pin-input-row" id="pinCreateRow">
              <input class="pin-box" type="password" inputmode="numeric" maxlength="1" id="cp0" oninput="pinNext('cp',0,4)">
              <input class="pin-box" type="password" inputmode="numeric" maxlength="1" id="cp1" oninput="pinNext('cp',1,4)">
              <input class="pin-box" type="password" inputmode="numeric" maxlength="1" id="cp2" oninput="pinNext('cp',2,4)">
              <input class="pin-box" type="password" inputmode="numeric" maxlength="1" id="cp3" oninput="pinNext('cp',3,4)">
            </div>
            <div style="font-size:.68rem;color:var(--text3);margin-top:6px">This PIN is used to login. Admin can view it.</div>
          </div>
          <button class="acc-btn acc-btn-green" onclick="doCreateAccount()" style="margin-top:8px">Create Account</button>
        ` : `
          <div class="acc-field"><label class="acc-label">Phone Number</label><input class="acc-inp" type="tel" id="afPhone" placeholder="10-digit mobile number" maxlength="10" inputmode="numeric"></div>
          <div class="acc-field">
            <label class="acc-label">4-Digit PIN</label>
            <div class="pin-input-row" id="pinLoginRow">
              <input class="pin-box" type="password" inputmode="numeric" maxlength="1" id="lp0" oninput="pinNext('lp',0,4)">
              <input class="pin-box" type="password" inputmode="numeric" maxlength="1" id="lp1" oninput="pinNext('lp',1,4)">
              <input class="pin-box" type="password" inputmode="numeric" maxlength="1" id="lp2" oninput="pinNext('lp',2,4)">
              <input class="pin-box" type="password" inputmode="numeric" maxlength="1" id="lp3" oninput="pinNext('lp',3,4)">
            </div>
          </div>
          <button class="acc-btn acc-btn-green" onclick="doLogin()" style="margin-top:8px">Login</button>
        `}
      </div>
    </div>`;
}

function pinNext(prefix, idx, total) {
  const el = document.getElementById(prefix + idx);
  if (!el) return;
  const v = el.value.replace(/\D/g,'');
  el.value = v.slice(-1);
  if (v && idx < total-1) document.getElementById(prefix+(idx+1))?.focus();
}

function getPinValue(prefix, total) {
  let pin = '';
  for (let i=0;i<total;i++) pin += (document.getElementById(prefix+i)?.value||'');
  return pin;
}

async function doLogin() {
  const phone = (document.getElementById('afPhone')?.value||'').trim();
  const pin = getPinValue('lp', 4);
  if (!phone || phone.length < 10) { showToast('Enter valid phone number'); return; }
  if (pin.length < 4) { showToast('Enter your 4-digit PIN'); return; }
  try {
    const r = await fetch('/api/milk/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ phone, pin }) });
    if (!r.ok) { showToast('Wrong phone or PIN'); return; }
    const d = await r.json();
    setMilkToken(d.token);
    renderAccount();
  } catch { showToast('Connection error. Try again.'); }
}

async function doCreateAccount() {
  const name = (document.getElementById('afName')?.value||'').trim();
  const phone = (document.getElementById('afPhone')?.value||'').trim();
  const address = (document.getElementById('afAddr')?.value||'').trim();
  const pin = getPinValue('cp', 4);
  if (!name) { showToast('Enter your name'); return; }
  if (!phone || phone.length < 10) { showToast('Enter valid phone number'); return; }
  if (pin.length < 4) { showToast('Set a 4-digit PIN'); return; }
  try {
    const r = await fetch('/api/milk/register', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, phone, address, defaultQty: 0, pin }) });
    if (!r.ok) { const d=await r.json(); showToast(d.error||'Registration failed'); return; }
    showToast('âœ“ Account created! Please login');
    _authMode = 'login';
    setTimeout(renderAuthScreen, 600);
  } catch { showToast('Connection error. Try again.'); }
}

// â”€â”€ ACCOUNT HOME (Blinkit-style profile) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _accData = null;
let _accSection = 'home'; // 'home'|'orders'|'passbook'

function renderAccountHome(data) {
  _accData = data;
  _accSection = 'home';
  const { customer: c, orders, udharBalance, milkAmt, milkPaid, totalLitres } = data;
  const milkDue = Math.max(0, milkAmt - milkPaid);
  const totalBalance = udharBalance + milkDue;

  document.getElementById('accTopTitle').textContent = c.name;
  document.getElementById('accTopSub').textContent = c.phone;

  const recentOrders = (orders||[]).slice(0,3);

  document.getElementById('milkBody').innerHTML = `
    <div style="overflow-y:auto;height:100%;padding-bottom:80px">

      <!-- Profile hero -->
      <div style="background:linear-gradient(160deg,#101c14 0%,#0a0a0a 55%);padding:24px 20px 20px;position:relative;overflow:hidden">
        <div style="position:absolute;top:-30px;right:-30px;width:160px;height:160px;background:radial-gradient(circle,rgba(45,211,111,.1),transparent 70%)"></div>
        <div style="display:flex;align-items:center;gap:14px;margin-bottom:16px;position:relative">
          <div style="width:60px;height:60px;border-radius:18px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;font-size:1.6rem;flex-shrink:0">ğŸ‘¤</div>
          <div>
            <div style="font-size:1.15rem;font-weight:900;color:#fff">${c.name}</div>
            <div style="font-size:.75rem;color:rgba(255,255,255,.35);margin-top:2px">${c.phone}${c.address?' Â· '+c.address:''}</div>
          </div>
        </div>
        <!-- Balance chip -->
        ${totalBalance > 0 ? `
        <div style="background:rgba(255,71,87,.08);border:1px solid rgba(255,71,87,.18);border-radius:12px;padding:10px 14px;display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-size:.65rem;color:rgba(255,255,255,.4);font-weight:600;text-transform:uppercase;letter-spacing:.06em;margin-bottom:2px">Outstanding Balance</div>
            <div style="font-size:1.3rem;font-weight:900;color:#ff6b6b">â‚¹${totalBalance.toFixed(0)}</div>
          </div>
          <button onclick="openPassbook()" style="background:rgba(255,71,87,.15);color:#ff9090;border:1px solid rgba(255,71,87,.25);border-radius:9px;padding:7px 14px;font-size:.72rem;font-weight:800;cursor:pointer">View Passbook â€º</button>
        </div>` : `
        <div style="background:rgba(45,211,111,.06);border:1px solid rgba(45,211,111,.15);border-radius:12px;padding:10px 14px;display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-size:.65rem;color:rgba(255,255,255,.4);font-weight:600;text-transform:uppercase;letter-spacing:.06em;margin-bottom:2px">Outstanding Balance</div>
            <div style="font-size:1.1rem;font-weight:900;color:var(--green)">All Clear âœ“</div>
          </div>
          <button onclick="openPassbook()" style="background:rgba(45,211,111,.12);color:var(--green);border:1px solid rgba(45,211,111,.2);border-radius:9px;padding:7px 14px;font-size:.72rem;font-weight:800;cursor:pointer">View Passbook â€º</button>
        </div>`}
      </div>

      <!-- Quick action grid -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;padding:16px 16px 0">
        <div class="acc-quick-btn" onclick="openOrdersSection()">
          <div class="aqb-icon">ğŸ›’</div>
          <div class="aqb-label">Your Orders</div>
        </div>
        <div class="acc-quick-btn" onclick="openPassbook()">
          <div class="aqb-icon">ğŸ“’</div>
          <div class="aqb-label">Passbook</div>
        </div>
        <div class="acc-quick-btn" onclick="openMilkSection()">
          <div class="aqb-icon">ğŸ¥›</div>
          <div class="aqb-label">Milk Log</div>
        </div>
      </div>

      <!-- Recent orders preview -->
      <div style="padding:16px 16px 0">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <div style="font-size:.7rem;font-weight:800;color:var(--text3);text-transform:uppercase;letter-spacing:.07em">Recent Orders</div>
          ${(orders||[]).length > 3 ? `<div style="font-size:.72rem;color:var(--green);font-weight:700;cursor:pointer" onclick="openOrdersSection()">See all â†’</div>` : ''}
        </div>
        ${recentOrders.length ? recentOrders.map(o => {
          const statusColor = {delivered:'var(--green)',pending:'#f59e0b',cancelled:'var(--red)'}[o.status]||'var(--text3)';
          const statusEmoji = {delivered:'âœ“',pending:'â³',cancelled:'âœ—'}[o.status]||'Â·';
          return `<div style="background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;gap:10px">
            <div style="width:36px;height:36px;border-radius:10px;background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0">ğŸ›’</div>
            <div style="flex:1;min-width:0">
              <div style="font-size:.82rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${(o.items||[]).slice(0,2).map(i=>i.name).join(', ')||'Order #'+o.id}</div>
              <div style="font-size:.68rem;color:var(--text3);margin-top:2px">${new Date(o.createdAt).toLocaleDateString('default',{day:'numeric',month:'short'})} Â· <span style="color:${statusColor}">${statusEmoji} ${o.status}</span></div>
            </div>
            <div style="font-size:.9rem;font-weight:900;color:var(--text);flex-shrink:0">â‚¹${o.total}</div>
          </div>`;
        }).join('') : '<div style="text-align:center;padding:20px;color:var(--text3);font-size:.82rem">No orders yet</div>'}
      </div>

      <!-- Your information section -->
      <div style="padding:16px 16px 0">
        <div style="font-size:.7rem;font-weight:800;color:var(--text3);text-transform:uppercase;letter-spacing:.07em;margin-bottom:10px">Your Information</div>
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:16px;overflow:hidden">
          ${[
            {icon:'ğŸ“',label:'Address',val:c.address||'Not set'},
            {icon:'ğŸ“±',label:'Phone',val:c.phone},
            {icon:'ğŸ“…',label:'Member since',val:new Date(c.joinedAt||Date.now()).toLocaleDateString('default',{month:'long',year:'numeric'})},
          ].map((row,i,arr) => `<div style="display:flex;align-items:center;gap:12px;padding:13px 16px;border-bottom:${i<arr.length-1?'1px solid var(--border)':'none'}">
            <div style="font-size:1rem;width:24px;text-align:center">${row.icon}</div>
            <div style="flex:1"><div style="font-size:.72rem;color:var(--text3);font-weight:600">${row.label}</div><div style="font-size:.84rem;font-weight:600;margin-top:1px">${row.val}</div></div>
          </div>`).join('')}
        </div>
      </div>

      <!-- Logout -->
      <div style="padding:16px 16px 0">
        <button class="acc-btn acc-btn-danger" onclick="logoutAccount()">Logout</button>
      </div>
    </div>`;
}

function logoutAccount() {
  clearMilkToken();
  renderAccountAuth();
  showToast('Logged out');
}

// â”€â”€ ORDERS SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openOrdersSection() {
  if (!_accData) return;
  const orders = _accData.orders || [];
  document.getElementById('accTopTitle').textContent = 'Your Orders';
  document.getElementById('accTopSub').textContent = orders.length + ' orders';
  document.getElementById('milkBody').innerHTML = `
    <div style="overflow-y:auto;height:100%;padding:16px 16px 80px">
      <button onclick="renderAccountHome(_accData)" style="display:flex;align-items:center;gap:6px;color:var(--text2);font-size:.82rem;font-weight:600;margin-bottom:14px;background:none;border:none;cursor:pointer">&#8592; Back</button>
      ${orders.length ? orders.map(o => {
        const statusColor = {delivered:'var(--green)',pending:'#f59e0b',cancelled:'var(--red)'}[o.status]||'var(--text3)';
        const statusBg = {delivered:'rgba(45,211,111,.08)',pending:'rgba(245,158,11,.08)',cancelled:'rgba(255,71,87,.08)'}[o.status]||'var(--bg3)';
        const statusEmoji = {delivered:'âœ…',pending:'â³',cancelled:'âŒ'}[o.status]||'ğŸ“¦';
        return `<div style="background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:10px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
            <div style="font-size:.72rem;color:var(--text3);font-weight:600">Order #${o.id} Â· ${new Date(o.createdAt).toLocaleDateString('default',{day:'numeric',month:'short',year:'numeric'})}</div>
            <span style="font-size:.68rem;font-weight:800;padding:3px 9px;border-radius:20px;background:${statusBg};color:${statusColor}">${statusEmoji} ${o.status}</span>
          </div>
          ${(o.items||[]).map(item => `<div style="display:flex;align-items:center;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border)">
            <div style="font-size:.8rem;font-weight:600">${item.name} <span style="color:var(--text3)">Ã—${item.qty}</span></div>
            <div style="font-size:.8rem;font-weight:700">â‚¹${(item.price*item.qty).toFixed(0)}</div>
          </div>`).join('')}
          <div style="display:flex;align-items:center;justify-content:space-between;margin-top:10px">
            <div style="font-size:.7rem;color:var(--text3)">${o.paymentMethod==='account'?'ğŸ“’ Account (Khata)':'ğŸ’³ UPI'}</div>
            <div style="font-size:.95rem;font-weight:900">â‚¹${o.total}</div>
          </div>
        </div>`;
      }).join('') : '<div class="empty-state"><div class="ei">ğŸ›’</div><p>No orders yet</p></div>'}
    </div>`;
}

// â”€â”€ MILK LOG SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openMilkSection() {
  if (!_accData) return;
  const { log, totalLitres, milkAmt, milkPaid, pricePerLitre, month } = _accData;
  const milkDue = Math.max(0, milkAmt - milkPaid);
  const monthLabel = new Date(month+'-02').toLocaleString('default',{month:'long',year:'numeric'});
  document.getElementById('accTopTitle').textContent = 'Milk Deliveries';
  document.getElementById('accTopSub').textContent = monthLabel;
  document.getElementById('milkBody').innerHTML = `
    <div style="overflow-y:auto;height:100%;padding:16px 16px 80px">
      <button onclick="renderAccountHome(_accData)" style="display:flex;align-items:center;gap:6px;color:var(--text2);font-size:.82rem;font-weight:600;margin-bottom:14px;background:none;border:none;cursor:pointer">&#8592; Back</button>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px">
        <div class="dash-stat"><div class="ds-num b">${totalLitres}L</div><div class="ds-lbl">Delivered</div></div>
        <div class="ds-num-card"><div class="ds-num" style="color:var(--red)">â‚¹${milkDue.toFixed(0)}</div><div class="ds-lbl">Due</div></div>
        <div class="dash-stat"><div class="ds-num g">â‚¹${milkPaid.toFixed(0)}</div><div class="ds-lbl">Paid</div></div>
      </div>
      <div style="background:var(--bg2);border:1px solid var(--border);border-radius:16px;overflow:hidden">
        ${log.length ? log.sort((a,b)=>b.date.localeCompare(a.date)).map(l => {
          const d = new Date(l.date+'T12:00:00');
          return `<div class="milk-log-row">
            <div class="mlog-day"><div class="mlog-day-num">${d.getDate()}</div><div class="mlog-day-name">${d.toLocaleString('default',{weekday:'short'})}</div></div>
            <div class="mlog-divider"></div>
            <div class="mlog-info"><div class="mlog-qty">${l.qty}L delivered</div><div class="mlog-amt">â‚¹${(l.qty*(l.price||pricePerLitre)).toFixed(0)}</div></div>
            <span class="mlog-pill">âœ“</span>
          </div>`;
        }).join('') : '<div class="milk-log-empty">No deliveries this month</div>'}
      </div>
    </div>`;
}

// â”€â”€ PASSBOOK (calendar ledger) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _cal = {
  months: [], selMonth: null, entries: [], summary: {}, selDate: null
};

async function openPassbook() {
  document.getElementById('accTopTitle').textContent = 'Passbook';
  document.getElementById('accTopSub').textContent = 'Your account ledger';
  document.getElementById('milkBody').innerHTML = '<div style="text-align:center;padding:60px;color:var(--text3)">Loading...</div>';
  try {
    const tok = getMilkToken();
    const r = await fetch('/api/customer/ledger/months', { headers: { Authorization: 'Bearer ' + tok } });
    if (!r.ok) throw new Error('Failed');
    const d = await r.json();
    _cal.months = d.months || [];
    _cal.selMonth = null;
    renderPassbookMonthList();
  } catch { document.getElementById('milkBody').innerHTML = '<div class="empty-state"><div class="ei">âš ï¸</div><p>Cannot load passbook</p></div>'; }
}

function renderPassbookMonthList() {
  const curMonth = new Date().toISOString().slice(0, 7);
  document.getElementById('milkBody').innerHTML = `
    <div style="overflow-y:auto;height:100%;padding:16px 16px 80px">
      <button onclick="renderAccountHome(_accData)" style="display:flex;align-items:center;gap:6px;color:var(--text2);font-size:.82rem;font-weight:600;margin-bottom:14px;background:none;border:none;cursor:pointer">&#8592; Back to Account</button>
      <div style="margin-bottom:10px">
        <div class="legend-row" style="flex-wrap:wrap;gap:10px;padding:0 0 8px">
          <span class="legend-item"><span class="cal-dot dot-milk" style="display:inline-block"></span>Milk</span>
          <span class="legend-item"><span class="cal-dot dot-order" style="display:inline-block"></span>Order</span>
          <span class="legend-item"><span class="cal-dot dot-udhar" style="display:inline-block"></span>Store</span>
          <span class="legend-item"><span class="cal-dot dot-payment" style="display:inline-block"></span>Payment</span>
        </div>
      </div>
      <div class="month-list">
        ${_cal.months.length ? _cal.months.map(m => {
          const label = new Date(m+'-02').toLocaleString('default',{month:'long',year:'numeric'});
          const isCur = m === curMonth;
          return `<div class="month-card ${isCur?'current':''}" onclick="openPassbookMonth('${m}')">
            <div class="month-card-left">
              <div class="month-card-name">${label}${isCur?` <span style="font-size:.6rem;background:rgba(45,211,111,.15);color:var(--green);padding:2px 7px;border-radius:20px;font-weight:800">Current</span>`:''}  </div>
              <div class="month-card-meta">Tap to view details</div>
            </div>
            <div class="month-card-right"><span class="month-card-arr">â€º</span></div>
          </div>`;
        }).join('') : '<div class="empty-state"><div class="ei">ğŸ“’</div><p>No activity yet</p></div>'}
      </div>
    </div>`;
}

async function openPassbookMonth(month) {
  _cal.selMonth = month;
  document.getElementById('milkBody').innerHTML = '<div style="text-align:center;padding:60px;color:var(--text3)">Loading...</div>';
  try {
    const tok = getMilkToken();
    const r = await fetch('/api/customer/ledger?month=' + month, { headers: { Authorization: 'Bearer ' + tok } });
    if (!r.ok) throw new Error('Failed');
    const d = await r.json();
    _cal.entries = d.entries || [];
    _cal.summary = d.summary || {};
    _cal.selDate = null;
    renderPassbookCalendar();
  } catch { showToast('Failed to load'); renderPassbookMonthList(); }
}

function renderPassbookCalendar() {
  const month = _cal.selMonth;
  const summary = _cal.summary;
  const label = new Date(month+'-02').toLocaleString('default',{month:'long',year:'numeric'});
  const dateMap = {};
  _cal.entries.forEach(e => {
    if (!dateMap[e.date]) dateMap[e.date] = { milk:0,order:0,udhar:0,payment:0,total:0 };
    const dm = dateMap[e.date];
    if (e.type==='milk') dm.milk++;
    else if (e.type==='order') dm.order++;
    else if (e.type==='udhar') dm.udhar++;
    else if (e.type==='payment'||e.type==='udhar_payment') dm.payment++;
    if (e.debit) dm.total += e.amount; else dm.total -= e.amount;
  });
  const firstDay = new Date(month+'-01');
  const daysInMonth = new Date(firstDay.getFullYear(),firstDay.getMonth()+1,0).getDate();
  const startDow = firstDay.getDay();
  const today = new Date().toISOString().slice(0,10);
  let cells = '';
  for (let i=0;i<startDow;i++) cells += '<div class="cal-cell empty"><div class="cal-cell-day"></div></div>';
  for (let d=1;d<=daysInMonth;d++) {
    const ds = month+'-'+String(d).padStart(2,'0');
    const dm = dateMap[ds];
    const isToday = ds===today, isSel = ds===_cal.selDate;
    let dots = '';
    if (dm) {
      if (dm.milk>0) dots+='<span class="cal-dot dot-milk"></span>';
      if (dm.order>0) dots+='<span class="cal-dot dot-order"></span>';
      if (dm.udhar>0) dots+='<span class="cal-dot dot-udhar"></span>';
      if (dm.payment>0) dots+='<span class="cal-dot dot-payment"></span>';
    }
    const tt = dm ? (dm.total>0?'+â‚¹'+Math.abs(dm.total).toFixed(0):dm.total<0?'-â‚¹'+Math.abs(dm.total).toFixed(0):'') : '';
    cells += `<div class="cal-cell ${isToday?'today':''} ${isSel?'selected':''}" onclick="openPassbookDay('${ds}')">
      <div class="cal-cell-day">${d}</div>
      <div class="cal-cell-dots">${dots}</div>
      ${tt?`<div class="cal-cell-total">${tt}</div>`:''}
    </div>`;
  }
  const outstanding = summary.outstanding||0;
  document.getElementById('milkBody').innerHTML = `
    <div style="display:flex;flex-direction:column;height:100%;overflow:hidden">
      <div class="cal-header">
        <button class="cal-nav-btn" onclick="renderPassbookMonthList()">&#8592;</button>
        <div class="cal-header-title">${label}</div>
        <button class="cal-nav-btn" onclick="showPassbookAllEntries()" title="All entries">â‰¡</button>
      </div>
      <div style="padding:10px 12px;flex-shrink:0">
        <div class="outstanding-banner">
          <div><div class="ob-label">Outstanding Balance</div><div class="ob-amount ${outstanding<=0?'clear':''}">${outstanding<=0?'âœ“ Cleared':'â‚¹'+outstanding.toFixed(0)}</div></div>
          <div style="text-align:right"><div style="font-size:.66rem;color:var(--text3)">Charged: â‚¹${(summary.totalDebits||0).toFixed(0)}</div><div style="font-size:.66rem;color:var(--green)">Paid: â‚¹${(summary.paymentsTotal||0).toFixed(0)}</div></div>
        </div>
      </div>
      <div class="cal-summary-bar">
        <div class="cs-item"><div class="cs-val" style="color:#60a5fa">â‚¹${(summary.milkTotal||0).toFixed(0)}</div><div class="cs-lbl">ğŸ¥› Milk</div></div>
        <div class="cs-item"><div class="cs-val" style="color:#a78bfa">â‚¹${(summary.orderTotal||0).toFixed(0)}</div><div class="cs-lbl">ğŸ›’ Orders</div></div>
        <div class="cs-item"><div class="cs-val" style="color:#f59e0b">â‚¹${(summary.udharTotal||0).toFixed(0)}</div><div class="cs-lbl">ğŸ“’ Store</div></div>
        <div class="cs-item"><div class="cs-val grn">â‚¹${(summary.paymentsTotal||0).toFixed(0)}</div><div class="cs-lbl">ğŸ’š Paid</div></div>
      </div>
      <div class="cal-grid-wrap" style="flex-shrink:0">
        <div class="cal-dow-row">${['S','M','T','W','T','F','S'].map(d=>`<div class="cal-dow">${d}</div>`).join('')}</div>
        <div class="cal-cells">${cells}</div>
      </div>
      <div style="flex:1;overflow-y:auto;padding:10px 12px 20px" id="calDayDetail">
        <div style="text-align:center;padding:16px;color:var(--text3);font-size:.78rem">Tap a date to see transactions</div>
      </div>
    </div>`;
}

function openPassbookDay(dateStr) {
  document.querySelectorAll('.cal-cell:not(.empty)').forEach(c => {
    const dn = parseInt(c.querySelector('.cal-cell-day')?.textContent);
    const ds2 = _cal.selMonth+'-'+String(dn).padStart(2,'0');
    c.classList.toggle('selected', ds2===dateStr);
  });
  _cal.selDate = dateStr;
  const dayEntries = _cal.entries.filter(e=>e.date===dateStr);
  const d = new Date(dateStr+'T12:00:00');
  const dateLabel = d.toLocaleDateString('default',{weekday:'long',day:'numeric',month:'long'});
  const dayDebit = dayEntries.filter(e=>e.debit).reduce((s,e)=>s+e.amount,0);
  const dayCredit = dayEntries.filter(e=>!e.debit).reduce((s,e)=>s+e.amount,0);
  const dayNet = dayDebit - dayCredit;
  const icons = {milk:'ğŸ¥›',order:'ğŸ›’',udhar:'ğŸ“’',payment:'ğŸ’š',udhar_payment:'ğŸ’š'};
  const srcClass = {APP:'src-app',STORE:'src-store',SUBSCRIPTION:'src-sub',PAYMENT:'src-pay'};
  const chip = dayNet===0?`<div class="day-total-chip zero">No charges</div>`
    :(dayNet>0?`<div class="day-total-chip">â‚¹${dayNet.toFixed(0)} due</div>`
    :`<div class="day-total-chip zero">â‚¹${Math.abs(dayNet).toFixed(0)} credit</div>`);
  document.getElementById('calDayDetail').innerHTML = `
    <div class="day-header"><div class="day-date-title">${dateLabel}</div>${chip}</div>
    ${dayEntries.length ? dayEntries.map(e=>{
      const ts = e.time?new Date(e.time).toLocaleTimeString('default',{hour:'2-digit',minute:'2-digit'}):'';
      return `<div class="ledger-entry">
        <div class="le-icon-wrap">${icons[e.type]||'ğŸ“„'}</div>
        <div class="le-body">
          <div class="le-source-row"><span class="le-source ${srcClass[e.source]||''}">${e.source}</span>${ts?`<span class="le-time">${ts}</span>`:''}</div>
          <div class="le-desc">${e.description}</div>
          ${e.note?`<div class="le-note">${e.note}</div>`:''}
        </div>
        <div class="le-amt"><div class="le-amt-val ${e.debit?'debit':'credit'}">${e.debit?'-':'+'}â‚¹${e.amount.toFixed(0)}</div><div class="le-amt-type">${e.debit?'DEBIT':'CREDIT'}</div></div>
      </div>`;
    }).join('') : '<div style="text-align:center;padding:16px;color:var(--text3);font-size:.78rem">No activity on this date</div>'}`;
}

function showPassbookAllEntries() {
  const month = _cal.selMonth;
  const label = new Date(month+'-02').toLocaleString('default',{month:'long',year:'numeric'});
  const summary = _cal.summary;
  const icons = {milk:'ğŸ¥›',order:'ğŸ›’',udhar:'ğŸ“’',payment:'ğŸ’š',udhar_payment:'ğŸ’š'};
  const srcClass = {APP:'src-app',STORE:'src-store',SUBSCRIPTION:'src-sub',PAYMENT:'src-pay'};
  const entryHTML = _cal.entries.length ? _cal.entries.map(e=>{
    const d2 = new Date(e.date+'T12:00:00');
    const dl = d2.toLocaleDateString('default',{day:'numeric',month:'short'});
    const ts = e.time?new Date(e.time).toLocaleTimeString('default',{hour:'2-digit',minute:'2-digit'}):'';
    return `<div class="ledger-entry">
      <div class="le-icon-wrap">${icons[e.type]||'ğŸ“„'}</div>
      <div class="le-body">
        <div class="le-source-row"><span class="le-source ${srcClass[e.source]||''}">${e.source}</span><span class="le-time">${dl}${ts?' Â· '+ts:''}</span></div>
        <div class="le-desc">${e.description}</div>
        ${e.note?`<div class="le-note">${e.note}</div>`:''}
      </div>
      <div class="le-amt"><div class="le-amt-val ${e.debit?'debit':'credit'}">${e.debit?'-':'+'}â‚¹${e.amount.toFixed(0)}</div><div class="le-amt-type">${e.debit?'DEBIT':'CREDIT'}</div></div>
    </div>`;
  }).join('') : '<div class="empty-state"><div class="ei">ğŸ“’</div><p>No entries this month</p></div>';
  document.getElementById('milkBody').innerHTML = `
    <div style="display:flex;flex-direction:column;height:100%;overflow:hidden">
      <div class="cal-header">
        <button class="cal-nav-btn" onclick="renderPassbookCalendar()">&#8592;</button>
        <div class="cal-header-title">${label} â€” All Entries</div>
        <div></div>
      </div>
      <div class="cal-summary-bar">
        <div class="cs-item"><div class="cs-val red">â‚¹${(summary.totalDebits||0).toFixed(0)}</div><div class="cs-lbl">Total Due</div></div>
        <div class="cs-item"><div class="cs-val grn">â‚¹${(summary.paymentsTotal||0).toFixed(0)}</div><div class="cs-lbl">Paid</div></div>
        <div class="cs-item"><div class="cs-val ${(summary.outstanding||0)>0?'red':'grn'}">â‚¹${Math.abs(summary.outstanding||0).toFixed(0)}</div><div class="cs-lbl">${(summary.outstanding||0)>0?'Balance':'Cleared'}</div></div>
        <div class="cs-item"><div class="cs-val">${_cal.entries.length}</div><div class="cs-lbl">Entries</div></div>
      </div>
      <div style="flex:1;overflow-y:auto;padding:10px 12px 80px">${entryHTML}</div>
    </div>`;
}

// Legacy stubs kept for compatibility
function switchMilkTab(n) {
  if (n===0) renderAccount();
  else if (n===1) { _authMode='create'; renderAuthScreen(); }
  else if (n===2) openPassbook();
}
function renderMilkDash() { renderAccount(); }
function renderMilkReg() { _authMode='create'; renderAuthScreen(); }
function renderKhataView() { openPassbook(); }
function logoutMilk() { logoutAccount(); }

// â”€â”€ BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startBanner() {
  clearInterval(bTimer);
  if (banners.length <= 1) return;
  bTimer = setInterval(() => { bIdx=(bIdx+1)%banners.length; goBanner(bIdx); }, 4000);
}
function goBanner(i) {
  bIdx=i;
  const track=document.getElementById('btrack'); if(track) track.style.transform=`translateX(-${i*100}%)`;
  document.querySelectorAll('.bdot').forEach((d,j)=>d.classList.toggle('active',j===i));
}
function bannerClick(id) {
  const b=banners.find(x=>x.id===id); if(!b?.action) return;
  if (b.action.type==='category') openFP(b.action.catId);
}

// â”€â”€ CONFETTI & TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fireConfetti() {
  const colors=['#2dd36f','#ffd700','#ff6b6b','#60a5fa','#f59e0b','#a78bfa'];
  const cx=window.innerWidth/2, cy=window.innerHeight*.2;
  for (let i=0;i<28;i++) {
    const el=document.createElement('div'); el.className='cpiece';
    const sz=5+Math.random()*6;
    el.style.cssText=`left:${cx-60+Math.random()*120}px;top:${cy}px;width:${sz}px;height:${sz}px;background:${colors[~~(Math.random()*colors.length)]};animation-delay:${Math.random()*.3}s;animation-duration:${.7+Math.random()*.5}s;`;
    document.body.appendChild(el); setTimeout(()=>el.remove(),1400);
  }
}

let toastTimer;
function showToast(msg) {
  const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show');
  clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove('show'),2800);
}

// â”€â”€ CLOSE DROPDOWNS ON OUTSIDE CLICK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('click', (e) => {
  if (window._openDropId) {
    const drop = document.getElementById(window._openDropId);
    const btn  = document.getElementById(window._openDropId.replace('vdrop_','vbtn_'));
    if (drop && !drop.contains(e.target) && !btn?.contains(e.target)) {
      closeAllDropdowns();
    }
  }
}, true);

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>
